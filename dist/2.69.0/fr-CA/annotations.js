/*!
 * Box Content Preview
 * 
 * Copyright 2019 Box, Inc. All rights reserved.
 * 
 * This product includes software developed by Box, Inc. ("Box")
 * (http://www.box.com)
 * 
 * ALL BOX SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESS OR IMPLIED
 * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL BOX BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 * See the Box license for the specific language governing permissions
 * and limitations under the license.
 */!function(n){var i={};function o(t){if(i[t])return i[t].exports;var e=i[t]={i:t,l:!1,exports:{}};return n[t].call(e.exports,e,e.exports,o),e.l=!0,e.exports}o.m=n,o.c=i,o.d=function(t,e,n){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)o.d(n,i,function(t){return e[t]}.bind(null,i));return n},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=232)}({232:function(t,e,n){t.exports=n(233)},233:function(t,e,n){"use strict";n.r(e);n(234),n(235);e.default=BoxAnnotations},234:function(t,e,n){},235:function(t,e,n){function o(t){if(a[t])return a[t].exports;var e=a[t]={i:t,l:!1,exports:{}};return r[t].call(e.exports,e,e.exports,o),e.l=!0,e.exports}var r,a;a={},o.m=r=[function(t,e,n){"use strict";n.d(e,"c",function(){return i}),n.d(e,"O",function(){return o}),n.d(e,"V",function(){return r}),n.d(e,"N",function(){return a}),n.d(e,"E",function(){return s}),n.d(e,"G",function(){return l}),n.d(e,"H",function(){return h}),n.d(e,"D",function(){return c}),n.d(e,"Xb",function(){return u}),n.d(e,"Yb",function(){return d}),n.d(e,"Z",function(){return f}),n.d(e,"i",function(){return p}),n.d(e,"A",function(){return g}),n.d(e,"o",function(){return m}),n.d(e,"l",function(){return v}),n.d(e,"Sb",function(){return y}),n.d(e,"cb",function(){return b}),n.d(e,"C",function(){return E}),n.d(e,"Wb",function(){return w}),n.d(e,"U",function(){return C}),n.d(e,"F",function(){return O}),n.d(e,"Zb",function(){return x}),n.d(e,"j",function(){return T}),n.d(e,"Lb",function(){return _}),n.d(e,"k",function(){return S}),n.d(e,"Rb",function(){return k}),n.d(e,"ac",function(){return A}),n.d(e,"K",function(){return R}),n.d(e,"n",function(){return D}),n.d(e,"Tb",function(){return P}),n.d(e,"m",function(){return L}),n.d(e,"ab",function(){return N}),n.d(e,"bb",function(){return M}),n.d(e,"eb",function(){return B}),n.d(e,"I",function(){return j}),n.d(e,"J",function(){return H}),n.d(e,"t",function(){return I}),n.d(e,"Ub",function(){return F}),n.d(e,"z",function(){return q}),n.d(e,"Q",function(){return z}),n.d(e,"db",function(){return Y}),n.d(e,"R",function(){return X}),n.d(e,"P",function(){return W}),n.d(e,"dc",function(){return U}),n.d(e,"e",function(){return V}),n.d(e,"Jb",function(){return G}),n.d(e,"f",function(){return J}),n.d(e,"Kb",function(){return $}),n.d(e,"T",function(){return Q}),n.d(e,"S",function(){return K}),n.d(e,"r",function(){return Z}),n.d(e,"q",function(){return tt}),n.d(e,"p",function(){return et}),n.d(e,"d",function(){return nt}),n.d(e,"Ib",function(){return it}),n.d(e,"L",function(){return ot}),n.d(e,"bc",function(){return rt}),n.d(e,"g",function(){return at}),n.d(e,"W",function(){return st}),n.d(e,"X",function(){return lt}),n.d(e,"Y",function(){return ht}),n.d(e,"ec",function(){return ct}),n.d(e,"M",function(){return ut}),n.d(e,"y",function(){return dt}),n.d(e,"Vb",function(){return ft}),n.d(e,"B",function(){return pt}),n.d(e,"s",function(){return gt}),n.d(e,"h",function(){return mt}),n.d(e,"Qb",function(){return vt}),n.d(e,"fc",function(){return yt}),n.d(e,"cc",function(){return bt}),n.d(e,"w",function(){return Et}),n.d(e,"x",function(){return wt}),n.d(e,"u",function(){return Ct}),n.d(e,"v",function(){return Ot}),n.d(e,"Pb",function(){return xt}),n.d(e,"Ob",function(){return Tt}),n.d(e,"Nb",function(){return _t}),n.d(e,"Mb",function(){return St}),n.d(e,"ib",function(){return kt}),n.d(e,"jb",function(){return At}),n.d(e,"pb",function(){return Rt}),n.d(e,"hb",function(){return Dt}),n.d(e,"rb",function(){return Pt}),n.d(e,"kb",function(){return Lt}),n.d(e,"tb",function(){return Nt}),n.d(e,"mb",function(){return Mt}),n.d(e,"sb",function(){return Bt}),n.d(e,"ob",function(){return jt}),n.d(e,"lb",function(){return Ht}),n.d(e,"nb",function(){return It}),n.d(e,"qb",function(){return Ft}),n.d(e,"Gb",function(){return qt}),n.d(e,"Hb",function(){return zt}),n.d(e,"Db",function(){return Yt}),n.d(e,"Eb",function(){return Xt}),n.d(e,"Fb",function(){return Wt}),n.d(e,"xb",function(){return Ut}),n.d(e,"gc",function(){return Vt}),n.d(e,"Cb",function(){return Gt}),n.d(e,"ic",function(){return Jt}),n.d(e,"yb",function(){return $t}),n.d(e,"a",function(){return Qt}),n.d(e,"hc",function(){return Kt}),n.d(e,"fb",function(){return Zt}),n.d(e,"gb",function(){return te}),n.d(e,"Bb",function(){return ee}),n.d(e,"Ab",function(){return ne}),n.d(e,"zb",function(){return ie}),n.d(e,"wb",function(){return oe}),n.d(e,"ub",function(){return re}),n.d(e,"b",function(){return ae}),n.d(e,"vb",function(){return se});var i="bp-is-active",o="bp-is-hidden",r="bp-is-invisible",a="is-disabled",s="bp-btn",l="bp-btn-plain",h="bp-btn-primary",c="bp-header",u=".bp-base-header",d=".bp-header-container",f="bp-doc-presentation",p="ba-annotations-loaded",g="ba-point-annotation-marker",m="ba-annotation-dialog",v="ba-annotation-caret",y="."+v,b="ba-textarea",E="annotation-textarea",w="."+E,C="ba-invalid-input",O="button-container",x="."+O,T="cancel-annotation-btn",_="."+T,S="post-annotation-btn",k="."+S,A=".delete-comment-btn",R="delete-confirmation-message",D="annotation-container",P="."+D,L="ba-annotation-comment-text",N="profile-container",M="profile-image-container",B="user-name",j="comment-date",H="ba-create-comment",I="ba-annotation-highlight-dialog",F="."+I,q="ba-plain-highlight",z="ba-highlight-dialog",Y="ba-is-text-highlighted",X="ba-annotation-highlight-label",W="ba-annotation-highlight-btns",U="."+W,V="ba-add-highlight-btn",G="."+V,J="ba-highlight-comment-btn",$="."+J,Q="ba-quad-corner-container",K="ba-quad-corner",Z="ba-annotation-drawing-label",tt="ba-annotation-drawing-dialog",et="ba-annotation-drawing-btns",nt="ba-btn-annotate-draw-add",it="."+nt,ot="ba-btn-annotate-draw-delete",rt="."+ot,at="ba-animate-show-dialog",st="ba-mobile-annotation-dialog",lt="ba-mobile-create-annotation-dialog",ht="ba-annotation-mobile-header",ct="."+ht,ut="ba-annotation-dialog-close",dt="ba-annotation-mode",ft="."+dt,pt="ba-point-mode",gt="ba-draw-mode",mt="ba-annotate-mode-background",vt=".ba-btn-annotate-point-exit",yt=".ba-point-mode-header",bt=".ba-draw-mode-header",Et="ba-annotation-layer-highlight",wt="ba-annotation-layer-highlight-comment",Ct="ba-annotation-layer-draw",Ot="ba-annotation-layer-draw-in-progress",xt=".ba-btn-annotate-draw-undo",Tt=".ba-btn-annotate-draw-redo",_t=".ba-btn-annotate-draw-post",St=".ba-btn-annotate-draw-cancel",kt="annotation-dialog",At="annotation-indicator",Rt="highlight-btn",Dt="add-highlight-comment-btn",Pt="post-annotation-btn",Lt="cancel-annotation-btn",Nt="reply-textarea",Mt="cancel-reply-btn",Bt="post-reply-btn",jt="delete-btn",Ht="cancel-delete-btn",It="confirm-delete-btn",Ft="mobile-dialog-close-btn",qt='[data-section="create"]',zt='[data-section="show"]',Yt="can_annotate",Xt="can_view_annotations_all",Wt="can_view_annotations_self",Ut={idle:"idle",drawing:"drawing",erasing:"erasing"},Vt={hover:"hover",inactive:"inactive",pending:"pending",pending_active:"pending-active"},Gt=[Vt.pending,Vt.pending_active],Jt={point:"point",highlight:"highlight",draw:"draw",highlight_comment:"highlight-comment"},$t={normal:"rgba(254, 217, 78, 0.5)",active:"rgba(255, 201, 0, 0.5)",erase:"rgba(255, 245, 132, 1)"},Qt={fetch:"annotationsfetched",error:"annotationerror",scale:"scaleannotations"},Kt={pending:"annotationpending",threadSave:"annotationthreadsaved",threadDelete:"annotationthreaddeleted",threadCleanup:"annotationthreadcleanup",save:"annotationsaved",delete:"annotationdeleted",deleteError:"annotationdeleteerror",cancel:"annotationcanceled",createError:"annotationcreateerror",show:"annotationshow",hide:"annotationhide"},Zt={toggleMode:"togglemode",enter:"annotationmodeenter",exit:"annotationmodeexit",createThread:"createannotationthread",register:"registerthread",unregister:"unregisterthread",bindDOMListeners:"binddomlisteners",unbindDOMListeners:"unbinddomlisteners",renderPage:"annotationsrenderpage",resetMobileDialog:"annotationsmobiledialogreset"},te={init:"init",post:"post_comment",cancel:"cancel",plain:"plain_highlight_create",comment:"comment_highlight_edit"},ee=15,ne=15,ie="mobile-annotation-dialog",oe=16.67,re=3,ae=5,se=5},function(t,e,n){"use strict";n(13);var l=n(0),i=n(2);n.d(e,"H",function(){return d}),n.d(e,"k",function(){return f}),n.d(e,"u",function(){return p}),n.d(e,"j",function(){return g}),n.d(e,"M",function(){return m}),n.d(e,"x",function(){return v}),n.d(e,"g",function(){return y}),n.d(e,"h",function(){return b}),n.d(e,"K",function(){return E}),n.d(e,"D",function(){return w}),n.d(e,"C",function(){return C}),n.d(e,"z",function(){return O}),n.d(e,"m",function(){return x}),n.d(e,"A",function(){return T}),n.d(e,"o",function(){return _}),n.d(e,"v",function(){return S}),n.d(e,"r",function(){return k}),n.d(e,"t",function(){return A}),n.d(e,"F",function(){return R}),n.d(e,"B",function(){return D}),n.d(e,"q",function(){return P}),n.d(e,"y",function(){return L}),n.d(e,"J",function(){return N}),n.d(e,"E",function(){return M}),n.d(e,"w",function(){return B}),n.d(e,"a",function(){return j}),n.d(e,"i",function(){return H}),n.d(e,"G",function(){return I}),n.d(e,"e",function(){return F}),n.d(e,"f",function(){return q}),n.d(e,"s",function(){return z}),n.d(e,"L",function(){return Y}),n.d(e,"I",function(){return X}),n.d(e,"b",function(){return W}),n.d(e,"d",function(){return U}),n.d(e,"c",function(){return V}),n.d(e,"l",function(){return G}),n.d(e,"n",function(){return J}),n.d(e,"p",function(){return $});var o="X-Box-Client-Name",r="X-Box-Client-Version",a="box-annotations",s="2.3.0",h=9,c=["annotations","annotationService","fileVersionId","locale","location","type"],u=/\r\n|\n\r|\n|\r/g;function d(t,e){e=t.querySelector(e);e&&(t=t.querySelectorAll("."+l.D),[].forEach.call(t,function(t){t.classList.add(l.O)}),e.classList.remove(l.O))}function f(t,e){for(var n=t;n&&n!==document;n=n.parentNode)if(n.classList&&n.classList.contains(e))return n;return null}function p(t){var e=f(t,"page")||null,t=1;return e&&(t=parseInt(e.getAttribute("data-page-number"),10)),{pageEl:e,page:t}}function g(t,e){for(var n=e||"data-type",i=t;i&&i!==document;i=i.parentNode)if(i&&i.getAttribute(n))return i.getAttribute(n);return""}function m(t){var e=t;(e="string"==typeof t||t instanceof String?document.querySelector(t):e)&&e.classList.remove(l.O)}function v(t){var e=t;(e="string"==typeof t||t instanceof String?document.querySelector(t):e)&&e.classList.add(l.O)}function y(t){var e=t;(e="string"==typeof t||t instanceof String?document.querySelector(t):e)&&e.classList.add(l.N)}function b(t){var e=t;(e="string"==typeof t||t instanceof String?document.querySelector(t):e)&&e.classList.remove(l.N)}function E(t,e){t.style.width="",t.style.height="",t.classList.remove(l.c),t.classList.remove(l.U),e&&(t.value="")}function w(t,e){return!!f(e||t.target,l.o)}function C(t){t=t.target;return!(!f(t,l.o)&&!f(t,l.A))}function O(t,e){var n,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;t.insertBefore((n=t,t=e,(e=document.createRange()).selectNode(n),e.createContextualFragment(t.replace(/>\s*</g,"><"))),i)}function x(t,e,n){var i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"",o=document.createElement("button");return t.forEach(function(t){return o.classList.add(t)}),o.title=e,o.innerHTML=n,o.setAttribute("data-type",i),o}function T(t){t=t.getBoundingClientRect();return 0<=t.top&&0<=t.left&&t.bottom<=window.innerHeight&&t.right<=window.innerWidth}function _(t,e,n,i){if(""!==t)return('<img src="'+t+'" alt="'+i+'">').trim();i="";return"0"!==e&&(i=n.replace(/\W*(\w)\w*/g,"$1").toUpperCase().substring(0,3)),('<div class="ba-annotation-profile avatar-color-'+(parseInt(e,10)||0)%h+'">'+i+"</div>").trim()}function S(t){return parseFloat(t.getAttribute("data-scale"))||1}function k(t){return t[Object.keys(t)[0]]}function A(t){var e=Object.keys(t).length;return t[Object.keys(t)[e-1]]}function R(t){var e=k(t);return 1===Object.keys(t).length&&""===e.text}function D(t){return t===l.ic.highlight||t===l.ic.highlight_comment}function P(t,e,n,i){var o,r=null;return t&&void 0!==t.x&&void 0!==t.y&&(o=e.width/n,n=(e.height-i)/n,(1<Math.abs(o-t.x)||1<Math.abs(n!==t.y))&&(r={x:o/t.x,y:n/t.y})),r}function L(t){return(""+t).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/`/g,"&#96;")}function N(t,e,n,i,o){var r=e<0,a=o<e+n,s=t.querySelector(l.Sb);if(r&&!a){t=Math.max(10,i);return s.style.left=t+"px",0}if(!a||r)return s.style.left="50%",e;i=Math.max(10,o-i);return s.style.left=n-i+"px",o-n}function M(t){return-1<l.Cb.indexOf(t)}function B(t){return!!(D(t.type)||t.minX&&t.minY&&t.maxX&&t.maxY)}function j(e){return!!e&&!(!(e.type!==l.ic.point||(n=e.location)&&n.x&&n.y)||D(e.type)&&(!(t=e.location)||!t.quadPoints)||e.type===l.ic.draw&&!((t=e.location)&&t.minX&&t.minY&&t.maxX&&t.maxY))&&c.every(function(t){return void 0!==e[t]});var t,n}function H(e,n){return function(t){t=t||window.event;!t||t.target&&"BUTTON"===t.target.nodeName||(t.preventDefault(),t.stopPropagation(),t=e(t),n(t))}}function I(t){t&&(t.preventDefault(),t.stopPropagation())}function F(t,e,n){e={x:t,y:e};return n&&(e.dimensions=n),e}function q(t){return e="",n=t.keyIdentifier,n=t.key||n||"",t.ctrlKey?e="Control":t.shiftKey?e="Shift":t.metaKey&&(e="Meta"),(n=0===(n=n===e?"":n).indexOf("U+")?"U+001B"===n?"Escape":String.fromCharCode(Number(n.replace("U+","0x"))):n)?(e&&(e+="+"),e+(n="Right"===(n="Esc"===(n=" "===n?"Space":n)?"Escape":n)||"Left"===n||"Down"===n||"Up"===n?"Arrow"+n:n)):"";var e,n}function z(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"",i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"";return e&&(t.Authorization="Bearer "+e),n&&(t.BoxApi="shared_link="+n,i&&(t.BoxApi=t.BoxApi+"&shared_link_password="+i)),a&&(t[o]=a),s&&(t[r]=s),t}function Y(t,e){t=(t+"e").split("e");return+((t=(Math.round(t[0]+"e"+(+t[1]+e))+"e").split("e"))[0]+"e"+(+t[1]-e))}function X(t,n){return t&&t.length?t.replace(/\{\d+\}/g,function(t){var e=parseInt(t.replace(/^\D+/g,""),10)-1;return n[e]||t}):t}function W(t){if(!t)return!1;var e=t[l.Db],n=t[l.Eb],t=t[l.Fb];return!!e||!!n||!!t}function U(t){var e=t.replace(u,"\n").split("\n"),n=document.createElement("p");return n.classList.add(l.m),1<e.length?e.forEach(function(t){var e;""===t?n.appendChild(document.createElement("br")):((e=document.createElement("p")).textContent=t,n.appendChild(e))}):n.textContent=t,n}function V(t,e){t=t.querySelector("canvas."+e);!t||(e=t.getContext("2d"))&&e.clearRect(0,0,t.width,t.height)}function G(t){return t&&(t.classList.add(l.c),t.selectionStart&&(t.selectionEnd=t.value.length,t.selectionStart=t.selectionEnd),T(t)&&t.focus(),t)}function J(){var t=document.createElement("div"),e=document.createElement("div");e.classList.add(l.Y),t.appendChild(e);var n=x([l.M],l.qb,i.a,l.qb);return e.appendChild(n),t}function $(t){var e=t;(n="string"==typeof(n=e)||e instanceof String?document.querySelector(e):n)&&n.classList.add(l.V),m(e),e.style.left=0;var n,t=e.getBoundingClientRect().width;return v(e),(n="string"==typeof(n=e)||e instanceof String?document.querySelector(e):n)&&n.classList.remove(l.V),t}},function(t,e,n){"use strict";n.d(e,"f",function(){return d}),n.d(e,"g",function(){return f}),n.d(e,"b",function(){return p}),n.d(e,"e",function(){return g}),n.d(e,"a",function(){return m}),n.d(e,"d",function(){return v}),n.d(e,"c",function(){return y});var i=n(14),o=n.n(i),r=n(15),a=n.n(r),s=n(16),l=n.n(s),h=n(17),c=n.n(h),u=n(18),e=n.n(u),i=n(19),r=n.n(i),s=n(20),h=n.n(s),u=n(21),i=n.n(u),s=n(22),u=n.n(s),s=n(23),s=n.n(s),d=(o.a,a.a),f=l.a,p=(c.a,e.a,r.a),g=h.a,m=i.a,v=u.a,y=s.a},function(t,e){function i(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function l(t){return"function"==typeof t}function h(t){return"object"==typeof t&&null!==t}function c(t){return void 0===t}((t.exports=i).EventEmitter=i).prototype._events=void 0,i.prototype._maxListeners=void 0,i.defaultMaxListeners=10,i.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw TypeError("n must be a positive number");return this._maxListeners=t,this},i.prototype.emit=function(t){var e,n,i,o,r,a;if(this._events||(this._events={}),"error"===t&&(!this._events.error||h(this._events.error)&&!this._events.error.length)){if((e=arguments[1])instanceof Error)throw e;var s=new Error('Uncaught, unspecified "error" event. ('+e+")");throw s.context=e,s}if(c(n=this._events[t]))return!1;if(l(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:o=Array.prototype.slice.call(arguments,1),n.apply(this,o)}else if(h(n))for(o=Array.prototype.slice.call(arguments,1),i=(a=n.slice()).length,r=0;r<i;r++)a[r].apply(this,o);return!0},i.prototype.on=i.prototype.addListener=function(t,e){var n;if(!l(e))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",t,l(e.listener)?e.listener:e),this._events[t]?h(this._events[t])?this._events[t].push(e):this._events[t]=[this._events[t],e]:this._events[t]=e,h(this._events[t])&&!this._events[t].warned&&(n=c(this._maxListeners)?i.defaultMaxListeners:this._maxListeners)&&0<n&&this._events[t].length>n&&(this._events[t].warned=!0,console.trace),this},i.prototype.once=function(t,e){if(!l(e))throw TypeError("listener must be a function");var n=!1;function i(){this.removeListener(t,i),n||(n=!0,e.apply(this,arguments))}return i.listener=e,this.on(t,i),this},i.prototype.removeListener=function(t,e){var n,i,o,r;if(!l(e))throw TypeError("listener must be a function");if(!this._events||!this._events[t])return this;if(o=(n=this._events[t]).length,i=-1,n===e||l(n.listener)&&n.listener===e)delete this._events[t],this._events.removeListener&&this.emit("removeListener",t,e);else if(h(n)){for(r=o;0<r--;)if(n[r]===e||n[r].listener&&n[r].listener===e){i=r;break}if(i<0)return this;1===n.length?(n.length=0,delete this._events[t]):n.splice(i,1),this._events.removeListener&&this.emit("removeListener",t,e)}return this},i.prototype.removeAllListeners=function(t){var e,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[t]&&delete this._events[t],this;if(0===arguments.length){for(e in this._events)"removeListener"!==e&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this._events={},this}if(l(n=this._events[t]))this.removeListener(t,n);else if(n)for(;n.length;)this.removeListener(t,n[n.length-1]);return delete this._events[t],this},i.prototype.listeners=function(t){return this._events&&this._events[t]?l(this._events[t])?[this._events[t]]:this._events[t].slice():[]},i.prototype.listenerCount=function(t){if(this._events){t=this._events[t];if(l(t))return 1;if(t)return t.length}return 0},i.listenerCount=function(t,e){return t.listenerCount(e)}},function(t,e,n){"use strict";function o(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(n):void 0:null===(t=Object.getPrototypeOf(t))?void 0:o(t,e,n)}var i=n(3),i=n.n(i),r=n(10),a=n(6),s=n(1),l=n(2),h=n(0),n=function(t,e,n){return e&&c(t.prototype,e),n&&c(t,n),t};function c(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)})(u,i.a),n(u,[{key:"destroy",value:function(){this.dialog&&!this.isMobile&&(this.unbindCustomListenersOnDialog(),this.dialog.destroy(),this.dialog=null),this.element&&(this.unbindDOMListeners(),this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null),this.state!==h.gc.pending&&this.emit(h.hc.threadDelete)}},{key:"hide",value:function(){s.x(this.element)}},{key:"reset",value:function(){this.state=h.gc.inactive}},{key:"isDialogVisible",value:function(){return!(!this.dialog||!this.dialog.element||this.dialog.element.classList.contains(h.O))}},{key:"showDialog",value:function(){this.dialog.element||this.dialog.setup(this.annotations,this.element),this.dialog.show()}},{key:"hideDialog",value:function(){this.dialog&&(this.state=h.gc.inactive,this.dialog.hide())}},{key:"saveAnnotation",value:function(t,e){var n=this,t=this.createAnnotationData(t,e),i=a.a.generateID(),e=t;e.annotationID=i,e.permissions={can_edit:!0,can_delete:!0},e.created=(new Date).getTime(),e.modified=e.created;var o=new r.a(e);return this.saveAnnotationToThread(o),this.state=h.gc.inactive,this.dialog&&this.dialog.disable(o.annotationID),this.annotationService.create(t).then(function(t){return n.updateTemporaryAnnotation(o,t)}).catch(function(t){return n.handleThreadSaveError(t,i)})}},{key:"deleteAnnotation",value:function(t){var e=this,n=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],i=this.annotations[t];if(!i)return this.emit(h.hc.deleteError),Promise.reject();if(i.permissions&&!i.permissions.can_delete)return this.emit(h.hc.deleteError),Promise.reject();delete this.annotations[t];var o=s.r(this.annotations),r=o&&o.permissions&&o.permissions.can_delete;return s.F(this.annotations)&&!r?this.cancelFirstComment():!o||s.F(this.annotations)?(this.isMobile&&this.dialog&&(this.dialog.hideMobileDialog(),this.dialog.removeAnnotation(t)),this.destroy()):this.dialog&&(this.dialog.removeAnnotation(t),this.showDialog(),this.dialog.activateReply()),n?this.annotationService.delete(t).then(function(){o=s.r(e.annotations),r=o&&o.permissions&&o.permissions.can_delete,s.F(e.annotations)&&r&&e.annotationService.delete(o.annotationID),(o=s.r(e.annotations))||e.emit(h.hc.threadCleanup),e.emit(h.hc.delete)}).catch(function(t){e.emit(h.hc.deleteError)}):Promise.resolve()}},{key:"cancelFirstComment",value:function(){}},{key:"show",value:function(){}},{key:"createDialog",value:function(){}},{key:"setup",value:function(){var t=s.r(this.annotations);this.state=t?h.gc.inactive:h.gc.pending,this.createDialog(),this.bindCustomListenersOnDialog(),this.dialog&&(this.dialog.isMobile=this.isMobile,this.dialog.localized=this.localized),this.setupElement()}},{key:"setupElement",value:function(){this.element=this.createElement(),this.bindDOMListeners()}},{key:"bindDOMListeners",value:function(){this.element&&this.element.addEventListener("click",this.showDialog)}},{key:"unbindDOMListeners",value:function(){this.element&&this.element.removeEventListener("click",this.showDialog)}},{key:"bindCustomListenersOnDialog",value:function(){var t=this;this.dialog&&(this.createAnnotation=this.createAnnotation.bind(this),this.cancelUnsavedAnnotation=this.cancelUnsavedAnnotation.bind(this),this.deleteAnnotationWithID=this.deleteAnnotationWithID.bind(this),this.dialog.addListener("annotationcreate",this.createAnnotation),this.dialog.addListener("annotationcancel",this.cancelUnsavedAnnotation),this.dialog.addListener("annotationdelete",this.deleteAnnotationWithID),this.dialog.addListener("annotationshow",function(){return t.emit(h.hc.show)}),this.dialog.addListener("annotationhide",function(){return t.emit(h.hc.hide)}))}},{key:"unbindCustomListenersOnDialog",value:function(){this.dialog&&this.dialog.removeAllListeners(["annotationcreate","annotationcancel","annotationdelete","annotationshow","annotationhide"])}},{key:"cancelUnsavedAnnotation",value:function(){s.E(this.state)?(this.emit(h.hc.cancel),this.destroy()):this.hideDialog()}},{key:"scrollIntoView",value:function(){var t=parseInt(this.location.y,10);this.scrollToPage(),this.centerAnnotation(this.annotatedElement.scrollTop+t)}},{key:"scrollToPage",value:function(){this.location&&this.location.page&&this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]').scrollIntoView()}},{key:"centerAnnotation",value:function(t){t<this.annotatedElement.scrollHeight?this.annotatedElement.scrollTop=t:this.annotatedElement.scrollTop=this.annotatedElement.scrollBottom}},{key:"updateTemporaryAnnotation",value:function(t,e){t.annotationID in this.annotations?(delete this.annotations[t.annotationID],this.annotations[e.annotationID]=e):this.saveAnnotationToThread(e),!this.threadNumber&&e&&e.threadNumber&&(this.threadNumber=e.threadNumber),this.dialog&&(this.dialog.element&&this.dialog.element.dataset&&(this.dialog.element.dataset.threadNumber=this.threadNumber),this.dialog.addAnnotation(e),this.dialog.removeAnnotation(t.annotationID),this.dialog.enable(e.annotationID),this.dialog.scrollToLastComment()),this.isMobile&&(this.state=h.gc.hover,this.showDialog()),this.emit(h.hc.save)}},{key:"createElement",value:function(){var t=document.createElement("button");return t.classList.add(h.A),t.setAttribute("data-type",h.jb),t.innerHTML=l.g,t}},{key:"saveAnnotationToThread",value:function(t){this.annotations[t.annotationID]=t,this.dialog&&(this.dialog.addAnnotation(t),this.dialog.activateReply())}},{key:"createAnnotationData",value:function(t,e){return{fileVersionId:this.fileVersionId,type:t,text:e,location:this.location,user:this.annotationService.user,threadID:this.threadID,threadNumber:this.threadNumber}}},{key:"createAnnotation",value:function(t){this.saveAnnotation(h.ic.point,t.text)}},{key:"deleteAnnotationWithID",value:function(t){this.deleteAnnotation(t.annotationID)}},{key:"regenerateBoundary",value:function(){this.location&&this.location.x&&this.location.y&&(this.minX=this.location.x,this.maxX=this.location.x,this.minY=this.location.y,this.maxY=this.location.y)}},{key:"handleThreadSaveError",value:function(t,e){this.deleteAnnotation(e,!1),this.emit(h.hc.createError)}},{key:"getThreadEventData",value:function(){var t={type:this.type,threadID:this.threadID};return 0<this.annotationService.user.id&&(t.userId=this.annotationService.user.id),this.threadNumber&&(t.threadNumber=this.threadNumber),t}},{key:"emit",value:function(t,e){var n=this.getThreadEventData();o(u.prototype.__proto__||Object.getPrototypeOf(u.prototype),"emit",this).call(this,t,{data:n,eventData:e}),o(u.prototype.__proto__||Object.getPrototypeOf(u.prototype),"emit",this).call(this,"threadevent",{event:t,data:n,eventData:e})}}]),n=u;function u(t){!function(t){if(!(t instanceof u))throw new TypeError("Cannot call a class as a function")}(this);var e=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(u.__proto__||Object.getPrototypeOf(u)).call(this));return e.annotatedElement=t.annotatedElement,e.annotations=t.annotations||{},e.annotationService=t.annotationService,e.container=t.container,e.fileVersionId=t.fileVersionId,e.location=t.location,e.threadID=t.threadID||a.a.generateID(),e.threadNumber=t.threadNumber||"",e.type=t.type,e.locale=t.locale,e.isMobile=t.isMobile||!1,e.hasTouch=t.hasTouch||!1,e.permissions=t.permissions,e.localized=t.localized,e.state=h.gc.inactive,e.regenerateBoundary(),e.showDialog=e.showDialog.bind(e),e.setup(),e}e.a=n},function(t,e,n){"use strict";var i=n(3),i=n.n(i),s=n(1),l=n(0),h=n(2),n=function(t,e,n){return e&&o(t.prototype,e),n&&o(t,n),t};function o(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var r="ba-annotation-dialog-flipped",n=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(a,i.a),n(a,[{key:"destroy",value:function(){this.element&&(this.unbindDOMListeners(),this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null)}},{key:"show",value:function(){if(this.isMobile)this.showMobileDialog();else if(this.element&&!this.element.classList.contains(l.O))return;var t=this.hasAnnotations?this.element.querySelector(".reply-textarea"):this.element.querySelector(l.Wb);if(this.canAnnotate&&t.classList.contains(l.c)&&this.element.parentNode)return s.M(this.element),void this.scrollToLastComment();this.isMobile||this.position(),this.scrollToLastComment(),this.emit("annotationshow")}},{key:"scrollToLastComment",value:function(){var t,e;this.element&&(this.hasAnnotations&&this.activateReply(),e=this.hasAnnotations?this.element.querySelector(".reply-textarea"):this.element.querySelector(l.Wb),s.l(e),(t=this.element.querySelector(l.Tb))&&(e=this.dialogEl.classList.contains(r)?0:t.clientHeight,t.scrollTop=t.scrollHeight-e))}},{key:"showMobileDialog",value:function(){var t;this.element=this.container.querySelector("."+l.W),this.element.classList.contains(l.O)&&(s.M(this.element),this.element.appendChild(this.dialogEl),t=this.element.querySelectorAll(".annotation-comment"),this.highlightDialogEl&&!t.length&&(this.element.classList.add(l.z),this.element.querySelector(l.ec).classList.add(l.O)),this.element.classList.add(l.g),this.bindDOMListeners())}},{key:"hideMobileDialog",value:function(){this.element&&(this.dialogEl&&this.dialogEl.parentNode&&this.dialogEl.parentNode.removeChild(this.dialogEl),s.x(this.element),this.unbindDOMListeners(),this.element=s.n())}},{key:"hide",value:function(){this.element&&this.element.classList.contains(l.O)||(this.isMobile&&this.hideMobileDialog(),s.x(this.element),this.deactivateReply(),this.emit("annotationhide"),this.toggleFlippedThreadEl())}},{key:"addAnnotation",value:function(t){var e,n;this.hasAnnotations||(e=this.element.querySelector(l.Gb),n=this.element.querySelector(l.Hb),s.x(e),s.M(n),this.hasAnnotations=!0),this.addAnnotationElement(t)}},{key:"removeAnnotation",value:function(t){t=this.element.querySelector('[data-annotation-id="'+t+'"]');t&&t.parentNode.removeChild(t);t=this.element.querySelector(".reply-textarea");t&&t.focus()}},{key:"postAnnotation",value:function(t){var e=this.element.querySelector(l.Wb),t=t||e.value;""!==t.trim()?(this.emit("annotationcreate",{text:t}),e.value=""):e.classList.add(l.U)}},{key:"position",value:function(){}},{key:"setup",value:function(){var t,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];this.threadEl=1<arguments.length&&void 0!==arguments[1]?arguments[1]:void 0,this.dialogEl=this.generateDialogEl(Object.keys(e).length),this.dialogEl.classList.add(l.n),this.isMobile||(this.element=document.createElement("div"),this.element.setAttribute("data-type",l.ib),this.element.classList.add(l.o),this.element.classList.add(l.O),this.element.innerHTML='<div class="'+l.l+'"></div>',this.element.appendChild(this.dialogEl),(t=s.r(e))&&(this.element.dataset.threadNumber=t.threadNumber),this.bindDOMListeners()),this.addSortedAnnotations(e)}},{key:"addSortedAnnotations",value:function(e){var n=this,t=Object.keys(e).map(function(t){return e[t]});t.sort(function(t,e){return new Date(t.created)-new Date(e.created)}),t.forEach(function(t){n.addAnnotationElement(t)})}},{key:"bindDOMListeners",value:function(){this.element.addEventListener("keydown",this.keydownHandler),this.element.addEventListener("wheel",this.stopPropagation),this.element.addEventListener("mouseup",this.stopPropagation),this.hasTouch&&(this.element.addEventListener("touchstart",this.clickHandler),this.element.addEventListener("touchstart",this.stopPropagation));var t=this.element.querySelector(".reply-textarea");t&&t.addEventListener("focus",this.validateTextArea);t=this.element.querySelector(l.Wb);t&&t.addEventListener("focus",this.validateTextArea),this.isMobile||this.element.addEventListener("click",this.clickHandler)}},{key:"validateTextArea",value:function(t){t=t.target;"textarea"===t.type&&""!==t.value.trim()&&t.classList.remove(l.U)}},{key:"unbindDOMListeners",value:function(){this.element.removeEventListener("keydown",this.keydownHandler),this.element.removeEventListener("mouseup",this.stopPropagation),this.element.removeEventListener("wheel",this.stopPropagation),this.hasTouch&&(this.element.removeEventListener("touchstart",this.clickHandler),this.element.removeEventListener("touchstart",this.stopPropagation));var t=this.element.querySelector(".reply-textarea");t&&t.removeEventListener("focus",this.validateTextArea);t=this.element.querySelector(l.Wb);t&&t.removeEventListener("focus",this.validateTextArea),this.isMobile||(this.element.removeEventListener("click",this.clickHandler),this.element.removeEventListener("click",this.stopPropagation))}},{key:"enable",value:function(t){t=this.element.querySelector('[data-annotation-id="'+t+'"]');t&&(t=t.querySelectorAll("button"),Array.prototype.forEach.call(t,function(t){t.classList.remove(l.N)}))}},{key:"disable",value:function(t){t=this.element.querySelector('[data-annotation-id="'+t+'"]');t&&(t=t.querySelectorAll("button"),Array.prototype.forEach.call(t,function(t){t.classList.add(l.N)}))}},{key:"keydownHandler",value:function(t){t.stopPropagation(),"Escape"===s.f(t)?this.hasAnnotations?this.hide():this.cancelAnnotation():"reply-textarea"===s.j(t.target)&&this.scrollToLastComment()}},{key:"stopPropagation",value:function(t){t.stopPropagation()}},{key:"clickHandler",value:function(t){t.stopPropagation(),this.isMobile&&t.target&&"BUTTON"===t.target.nodeName&&t.preventDefault();var e=t.target,t=s.j(e),n=s.j(e,"data-annotation-id");switch(t){case l.rb:this.postAnnotation();break;case l.kb:case l.qb:this.hide(),this.isMobile||this.cancelAnnotation();break;case l.tb:this.activateReply();break;case l.mb:this.deactivateReply(!0);break;case l.sb:this.postReply();break;case l.ob:this.showDeleteConfirmation(n);break;case l.lb:this.hideDeleteConfirmation(n);break;case l.nb:this.deleteAnnotation(n)}}},{key:"addAnnotationElement",value:function(t){var e=s.y(t.user.id||"0"),n="0"===e?this.localized.posting:s.y(t.user.name)||this.localized.anonymousUserName,i=s.y(t.user.avatarUrl||""),o=s.o(i,e,n,this.localized.profileAlt),r=new Date(t.created).toLocaleString(this.locale,{month:"2-digit",day:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),a=s.d(t.text),i=document.createElement("div");i.classList.add("annotation-comment"),i.setAttribute("data-annotation-id",t.annotationID),this.dialogEl.querySelector(".annotation-comments").appendChild(i);e=document.createElement("div");e.classList.add(l.bb),e.innerHTML=o,i.appendChild(e);o=document.createElement("div");o.classList.add(l.ab),i.appendChild(o);e=document.createElement("div");e.classList.add(l.eb),e.textContent=n,o.appendChild(e);e=document.createElement("div");e.classList.add(l.I),e.textContent=r,o.appendChild(e);e=document.createElement("div");e.appendChild(a),i.appendChild(e),t.permissions.can_delete&&(t=s.m([l.G,"delete-comment-btn"],this.localized.deleteButton,h.b,l.ob),i.appendChild(t),(t=document.createElement("div")).classList.add("delete-confirmation"),t.classList.add(l.O),i.appendChild(t),(i=document.createElement("div")).classList.add(l.K),i.textContent=this.localized.deleteConfirmation,t.appendChild(i),(i=document.createElement("div")).classList.add(l.F),t.appendChild(i),t=s.m([l.E,"cancel-delete-btn"],this.localized.cancelButton,this.localized.cancelButton,l.lb),i.appendChild(t),t=s.m([l.E,"confirm-delete-btn",l.H],this.localized.deleteButton,this.localized.deleteButton,l.nb),i.appendChild(t))}},{key:"cancelAnnotation",value:function(){this.emit("annotationcancel")}},{key:"activateReply",value:function(){var t,e;!this.dialogEl||(t=this.dialogEl.querySelector(".reply-textarea"))&&(e=t.classList.contains(l.c),t.classList.remove(l.U),e||(e=t.parentNode.querySelector(l.Zb),t.classList.add(l.c),s.M(e)))}},{key:"deactivateReply",value:function(t){var e,n;!this.dialogEl||(n=this.dialogEl.querySelector(".reply-container"))&&(e=n.querySelector(".reply-textarea"),n=n.querySelector(l.Zb),s.K(e,t),s.x(n))}},{key:"postReply",value:function(){var t=this.element.querySelector(".reply-textarea"),e=t.value;""!==e.trim()?(this.emit("annotationcreate",{text:e}),t.value="",t.focus()):t.classList.add(l.U)}},{key:"showDeleteConfirmation",value:function(t){var e=this.element.querySelector('[data-annotation-id="'+t+'"]'),n=e.querySelector(".delete-confirmation"),t=e.querySelector(".cancel-delete-btn"),e=e.querySelector(l.ac);s.x(e),s.M(n),t.focus()}},{key:"hideDeleteConfirmation",value:function(t){var e=this.element.querySelector('[data-annotation-id="'+t+'"]'),t=e.querySelector(".delete-confirmation"),e=e.querySelector(l.ac);s.M(e),s.x(t),e.focus()}},{key:"deleteAnnotation",value:function(t){this.emit("annotationdelete",{annotationID:t})}},{key:"generateDialogEl",value:function(t){var e,n=document.createElement("div");this.canAnnotate&&((i=document.createElement("section")).setAttribute("data-section","create"),t&&i.classList.add(l.O),n.appendChild(i),(e=document.createElement("textarea")).classList.add(l.cb),e.classList.add(l.C),e.placeholder=this.localized.addCommentPlaceholder,i.appendChild(e),(e=document.createElement("div")).classList.add(l.F),i.appendChild(e),i=s.m([l.E,l.j],this.localized.cancelButton,this.localized.cancelButton,l.kb),e.appendChild(i),i=s.m([l.E,l.H,l.k],this.localized.postButton,this.localized.postButton,l.rb),e.appendChild(i));var i=document.createElement("section");i.setAttribute("data-section","show"),t||i.classList.add(l.O),n.appendChild(i);t=document.createElement("div");return t.classList.add("annotation-comments"),i.appendChild(t),this.canAnnotate&&((t=document.createElement("div")).classList.add("reply-container"),i.appendChild(t),(i=document.createElement("textarea")).classList.add(l.cb),i.classList.add(l.C),i.classList.add("reply-textarea"),i.placeholder=this.localized.replyPlaceholder,i.setAttribute("data-type",l.tb),t.appendChild(i),(i=document.createElement("div")).classList.add(l.F),i.classList.add(l.O),t.appendChild(i),t=s.m([l.E,l.j],this.localized.cancelButton,this.localized.cancelButton,l.mb),i.appendChild(t),t=s.m([l.E,l.H,l.k],this.localized.postButton,this.localized.postButton,l.sb),i.appendChild(t)),n}},{key:"flipDialog",value:function(t,e){var n="",i="",o=this.element.querySelector(l.Sb);return t<=e/2?(n=t-8+"px",i="",this.element.classList.remove(r),o.style.bottom=""):(n="",i=e-t-27+"px",this.element.classList.add(r),o.style.top="",o.style.bottom="0px"),this.fitDialogHeightInPage(),this.toggleFlippedThreadEl(),{top:n,bottom:i}}},{key:"toggleFlippedThreadEl",value:function(){this.element&&this.threadEl&&this.element.classList.contains(r)&&(this.element.classList.contains(l.O)?this.threadEl.classList.remove(r):this.threadEl.classList.add(r))}},{key:"fitDialogHeightInPage",value:function(){var t=this.container.clientHeight/2-l.Bb-l.Ab;this.dialogEl.style.maxHeight=t+"px";var e=this.dialogEl.querySelector("."+l.n);e&&(e.style.maxHeight=t+"px")}}]),a);function a(t){!function(t){if(!(t instanceof a))throw new TypeError("Cannot call a class as a function")}(this);var e=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(a.__proto__||Object.getPrototypeOf(a)).call(this));return e.annotatedElement=t.annotatedElement,e.container=t.container,e.location=t.location,e.hasAnnotations=0<Object.keys(t.annotations).length,e.canAnnotate=t.canAnnotate,e.locale=t.locale,e.isMobile=t.isMobile||!1,e.hasTouch=t.hasTouch||!1,e.keydownHandler=e.keydownHandler.bind(e),e.clickHandler=e.clickHandler.bind(e),e.stopPropagation=e.stopPropagation.bind(e),e.validateTextArea=e.validateTextArea.bind(e),e}e.a=n},function(t,e,n){"use strict";n(13);var i=n(3),i=n.n(i),o=n(10),r=n(1),n=function(t,e,n){return e&&a(t.prototype,e),n&&a(t,n),t};function a(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)})(s,i.a),n(s,null,[{key:"generateID",value:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})}}]),n(s,[{key:"create",value:function(t){var o=this;return new Promise(function(n,i){fetch(o.api+"/2.0/annotations",{method:"POST",headers:o.headers,body:JSON.stringify({item:{type:"file_version",id:t.fileVersionId},details:{type:t.type,drawingPaths:t.drawingPaths,location:t.location,threadID:t.threadID},message:t.text,thread:t.threadNumber})}).then(function(t){return t.json()}).then(function(t){var e;"error"!==t.type&&t.id?((e=t).permissions={can_edit:!0,can_delete:!0},e=o.createAnnotation(e),"0"===o.user.id&&(o.user=e.user),n(e)):(e=new Error("Could not create annotation"),i(e),o.emit("annotationerror",{reason:"create",error:e.toString()}))}).catch(function(t){i(new Error("Could not create annotation due to invalid or expired token")),o.emit("annotationerror",{reason:"authorization",error:t.toString()})})})}},{key:"read",value:function(t){this.annotations={};var n=void 0,i=void 0,e=new Promise(function(t,e){n=t,i=e});return this.readFromMarker(n,i,t),e}},{key:"delete",value:function(i){var o=this;return new Promise(function(e,n){fetch(o.api+"/2.0/annotations/"+i,{method:"DELETE",headers:o.headers}).then(function(t){204===t.status?e():(t=new Error("Could not delete annotation with ID "+i),n(t),o.emit("annotationerror",{reason:"delete",error:t.toString()}))}).catch(function(t){n(new Error("Could not delete annotation due to invalid or expired token")),o.emit("annotationerror",{reason:"authorization",error:t.toString()})})})}},{key:"getThreadMap",value:function(t){return this.read(t).then(this.createThreadMap)}},{key:"createThreadMap",value:function(i){var o={};return this.annotations=i,Object.keys(i).forEach(function(t){var e=i[t],n=e.threadID,t=o[n]||[];(o[n]=t)[e.annotationID]=e}),o}},{key:"createAnnotation",value:function(t){return new o.a({annotationID:t.id,fileVersionId:t.item.id,threadID:t.details.threadID,type:t.details.type,threadNumber:t.thread,text:t.message,location:t.details.location,user:{id:t.created_by.id,name:t.created_by.name,avatarUrl:t.created_by.profile_image},permissions:t.permissions,created:t.created_at,modified:t.modified_at})}},{key:"getReadUrl",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,t=this.api+"/2.0/files/"+this.fileId+"/annotations?version="+t+"&fields=item,thread,details,message,created_by,created_at,modified_at,permissions";return e&&(t+="&marker="+e),n&&(t+="&limit="+n),t}},{key:"readFromMarker",value:function(e,n,i){var o=this,t=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null;fetch(this.getReadUrl(i,t,r),{headers:this.headers}).then(function(t){return t.json()}).then(function(t){"error"!==t.type&&Array.isArray(t.entries)?(t.entries.forEach(function(t){t=o.createAnnotation(t);o.annotations[t.annotationID]=t}),t.next_marker?o.readFromMarker(e,n,i,t.next_marker,r):e(o.annotations)):(t=new Error("Could not read annotations from file version with ID "+i),n(t),o.emit("annotationerror",{reason:"read",error:t.toString()}))}).catch(function(t){n(new Error("Could not read annotations from file due to invalid or expired token")),o.emit("annotationerror",{reason:"authorization",error:t.toString()})})}}]),n=s;function s(t){!function(t){if(!(t instanceof s))throw new TypeError("Cannot call a class as a function")}(this);var e=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(s.__proto__||Object.getPrototypeOf(s)).call(this));return e.api=t.apiHost,e.fileId=t.fileId,e.headers=Object(r.s)({},t.token),e.canAnnotate=t.canAnnotate,e.user={id:"0",name:e.anonymousUserName},e.createThreadMap=e.createThreadMap.bind(e),e}e.a=n},function(t,e,n){var i;void 0===(i="function"==typeof(i=function(){var i="object",o="function",n="undefined",l=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],h=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],e=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],r=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"];function c(t,e){var n=typeof t[e];return n==o||!(n!=i||!t[e])||"unknown"==n}function a(t,e){return!(typeof t[e]!=i||!t[e])}function t(t,e){return typeof t[e]!=n}function s(i){return function(t,e){for(var n=e.length;n--;)if(!i(t,e[n]))return!1;return!0}}var u=s(c),d=s(a),f=s(t);function p(t){return t&&u(t,r)&&f(t,e)}function g(t){return a(t,"body")?t.body:t.getElementsByTagName("body")[0]}var m,v,y={},b=typeof window!=n&&typeof document!=n,E={isHostMethod:c,isHostObject:a,isHostProperty:t,areHostMethods:u,areHostObjects:d,areHostProperties:f,isTextRange:p,getBody:g,forEach:[].forEach?function(t,e){t.forEach(e)}:function(t,e){for(var n=0,i=t.length;n<i;++n)e(t[n],n)}},w={version:"1.3.0",initialized:!1,isBrowser:b,supported:!0,util:E,features:{},modules:y,config:{alertOnFail:!1,alertOnWarn:!1,preferTextRange:!1,autoInitialize:typeof rangyAutoInitialize==n||rangyAutoInitialize}};function C(){typeof console!=n&&c(console,"log")}function O(t,e){b&&e?alert(t):C()}function x(t){w.initialized=!0,w.supported=!1,O("Rangy is not supported in this environment. Reason: "+t,w.config.alertOnFail)}w.fail=x,w.warn=function(t){O("Rangy warning: "+t,w.config.alertOnWarn)},{}.hasOwnProperty?(E.extend=m=function(t,e,n){var i,o,r;for(r in e)e.hasOwnProperty(r)&&(i=t[r],o=e[r],n&&null!==i&&"object"==typeof i&&null!==o&&"object"==typeof o&&m(i,o,!0),t[r]=o);return e.hasOwnProperty("toString")&&(t.toString=e.toString),t},E.createOptions=function(t,e){var n={};return m(n,e),t&&m(n,t),n}):x("hasOwnProperty not supported"),b||x("Rangy can only run in a browser"),function(){var t;if(b){var e=document.createElement("div");e.appendChild(document.createElement("span"));var n=[].slice;try{1==n.call(e.childNodes,0)[0].nodeType&&(t=function(t){return n.call(t,0)})}catch(t){}}E.toArray=t=t||function(t){for(var e=[],n=0,i=t.length;n<i;++n)e[n]=t[n];return e}}(),b&&(c(document,"addEventListener")?v=function(t,e,n){t.addEventListener(e,n,!1)}:c(document,"attachEvent")?v=function(t,e,n){t.attachEvent("on"+e,n)}:x("Document does not have required addEventListener or attachEvent method"),E.addListener=v);var T=[];function _(t){return t.message||t.description||String(t)}function S(){if(b&&!w.initialized){var t,e=!1,n=!1;c(document,"createRange")&&(t=document.createRange(),u(t,h)&&f(t,l)&&(e=!0));var i,o,r=g(document);if(r&&"body"==r.nodeName.toLowerCase())if(r&&c(r,"createTextRange")&&p(t=r.createTextRange())&&(n=!0),e||n){for(o in w.initialized=!0,w.features={implementsDomRange:e,implementsTextRange:n},y)(i=y[o])instanceof D&&i.init(i,w);for(var a=0,s=T.length;a<s;++a)try{T[a](w)}catch(t){C(_(t))}}else x("Neither Range nor TextRange are available");else x("No body element found")}}function k(t,e,n){n&&(t+=" in module "+n.name),w.warn("DEPRECATED: "+t+" is deprecated. Please use "+e+" instead.")}function A(t,e,n,i){t[e]=function(){return k(e,n,i),t[n].apply(t,E.toArray(arguments))}}E.deprecationNotice=k,E.createAliasForDeprecatedMethod=A,w.init=S,w.addInitListener=function(t){w.initialized?t(w):T.push(t)};var R=[];function D(t,e,n){this.name=t,this.dependencies=e,this.initialized=!1,this.supported=!1,this.initializer=n}function P(t,e,n){e=new D(t,e,function(t){if(!t.initialized){t.initialized=!0;try{n(w,t),t.supported=!0}catch(t){_(t),C(),t.stack&&C(t.stack)}}});return y[t]=e}function L(){}w.addShimListener=function(t){R.push(t)},b&&(w.shim=w.createMissingNativeApi=function(t){t=t||window,S();for(var e=0,n=R.length;e<n;++e)R[e](t)},A(w,"createMissingNativeApi","shim")),D.prototype={init:function(){for(var t,e,n=this.dependencies||[],i=0,o=n.length;i<o;++i){if(e=n[i],!((t=y[e])&&t instanceof D))throw new Error("required module '"+e+"' not found");if(t.init(),!t.supported)throw new Error("required module '"+e+"' not supported")}this.initializer(this)},fail:function(t){throw this.initialized=!0,this.supported=!1,new Error(t)},warn:function(t){w.warn("Module "+this.name+": "+t)},deprecationNotice:function(t,e){w.warn("DEPRECATED: "+t+" in module "+this.name+" is deprecated. Please use "+e+" instead")},createError:function(t){return new Error("Error in Rangy "+this.name+" module: "+t)}},w.createModule=function(t){var e=2==arguments.length?(n=arguments[1],[]):(n=arguments[2],arguments[1]),n=P(t,e,n);w.initialized&&w.supported&&n.init()},w.createCoreModule=function(t,e,n){P(t,e,n)},w.RangePrototype=L,w.rangePrototype=new L,w.selectionPrototype=new function(){},w.createCoreModule("DomUtil",[],function(n,l){var i="undefined",o=n.util,r=o.getBody;o.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||l.fail("document missing a Node creation method"),o.isHostMethod(document,"getElementsByTagName")||l.fail("document missing getElementsByTagName method");var t=document.createElement("div");o.areHostMethods(t,["insertBefore","appendChild","cloneNode"])||l.fail("Incomplete Element implementation"),o.isHostProperty(t,"innerHTML")||l.fail("Element is missing innerHTML property");t=document.createTextNode("test");o.areHostMethods(t,["splitText","deleteData","insertData","appendData","cloneNode"])||l.fail("Incomplete Text Node implementation");function a(t,e){for(var n=t.length;n--;)if(t[n]===e)return!0;return!1}function h(t){for(var e=0;t=t.previousSibling;)++e;return e}function c(t,e){for(var n=[],i=t;i;i=i.parentNode)n.push(i);for(i=e;i;i=i.parentNode)if(a(n,i))return i;return null}function s(t,e,n){for(var i=n?e:e.parentNode;i;){if(i===t)return!0;i=i.parentNode}return!1}function u(t,e,n){for(var i,o=n?t:t.parentNode;o;){if((i=o.parentNode)===e)return o;o=i}return null}function d(t){t=t.nodeType;return 3==t||4==t||8==t}function f(t,e){var n=e.nextSibling,e=e.parentNode;return n?e.insertBefore(t,n):e.appendChild(t),t}function p(t){if(9==t.nodeType)return t;if(typeof t.ownerDocument!=i)return t.ownerDocument;if(typeof t.document!=i)return t.document;if(t.parentNode)return p(t.parentNode);throw l.createError("getDocument: no document found for node")}function g(t){t=p(t);if(typeof t.defaultView!=i)return t.defaultView;if(typeof t.parentWindow!=i)return t.parentWindow;throw l.createError("Cannot get a window object for node")}function m(t){if(typeof t.contentDocument!=i)return t.contentDocument;if(typeof t.contentWindow!=i)return t.contentWindow.document;throw l.createError("getIframeDocument: No Document object found for iframe element")}function v(t){return t&&o.isHostMethod(t,"setTimeout")&&o.isHostObject(t,"document")}var e,y;function b(t){try{return t.parentNode,!1}catch(t){return!0}}function E(t){if(!t)return"[No node]";if(y&&b(t))return"[Broken node]";if(d(t))return'"'+t.data+'"';if(1!=t.nodeType)return t.nodeName;var e=t.id?' id="'+t.id+'"':"";return"<"+t.nodeName+e+">[index:"+h(t)+",length:"+t.childNodes.length+"]["+(t.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}function w(t){this.root=t,this._next=t}function C(t,e){this.node=t,this.offset=e}function O(t){this.code=this[t],this.codeName=t,this.message="DOMException: "+this.codeName}!function(){var t=document.createElement("b");t.innerHTML="1";var e=t.firstChild;t.innerHTML="<br />",y=b(e),n.features.crashyTextNodes=y}(),typeof window.getComputedStyle!=i?e=function(t,e){return g(t).getComputedStyle(t,null)[e]}:typeof document.documentElement.currentStyle!=i?e=function(t,e){return t.currentStyle?t.currentStyle[e]:""}:l.fail("No means of obtaining computed style properties found"),w.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var t,e,n=this._current=this._next;if(this._current)if(t=n.firstChild)this._next=t;else{for(e=null;n!==this.root&&!(e=n.nextSibling);)n=n.parentNode;this._next=e}return this._current},detach:function(){this._current=this._next=this.root=null}},C.prototype={equals:function(t){return!!t&&this.node===t.node&&this.offset==t.offset},inspect:function(){return"[DomPosition("+E(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},(O.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24}).toString=function(){return this.message},n.dom={arrayContains:a,isHtmlNamespace:function(t){var e;return typeof t.namespaceURI==i||null===(e=t.namespaceURI)||"http://www.w3.org/1999/xhtml"==e},parentElement:function(t){t=t.parentNode;return 1==t.nodeType?t:null},getNodeIndex:h,getNodeLength:function(t){switch(t.nodeType){case 7:case 10:return 0;case 3:case 8:return t.length;default:return t.childNodes.length}},getCommonAncestor:c,isAncestorOf:s,isOrIsAncestorOf:function(t,e){return s(t,e,!0)},getClosestAncestorIn:u,isCharacterDataNode:d,isTextOrCommentNode:function(t){if(!t)return!1;t=t.nodeType;return 3==t||8==t},insertAfter:f,splitDataNode:function(t,e,n){var i=t.cloneNode(!1);if(i.deleteData(0,e),t.deleteData(e,t.length-e),f(i,t),n)for(var o,r=0;o=n[r++];)o.node==t&&o.offset>e?(o.node=i,o.offset-=e):o.node==t.parentNode&&o.offset>h(t)&&++o.offset;return i},getDocument:p,getWindow:g,getIframeWindow:function(t){if(typeof t.contentWindow!=i)return t.contentWindow;if(typeof t.contentDocument!=i)return t.contentDocument.defaultView;throw l.createError("getIframeWindow: No Window object found for iframe element")},getIframeDocument:m,getBody:r,isWindow:v,getContentDocument:function(t,e,n){var i;if(t?o.isHostProperty(t,"nodeType")?i=(1==t.nodeType&&"iframe"==t.tagName.toLowerCase()?m:p)(t):v(t)&&(i=t.document):i=document,!i)throw e.createError(n+"(): Parameter must be a Window object or DOM node");return i},getRootContainer:function(t){for(var e;e=t.parentNode;)t=e;return t},comparePoints:function(t,e,n,i){var o,r,a,s;if(t==n)return e===i?0:e<i?-1:1;if(o=u(n,t,!0))return e<=h(o)?-1:1;if(o=u(t,n,!0))return h(o)<i?-1:1;if(!(i=c(t,n)))throw new Error("comparePoints error: nodes have no common ancestor");if((r=t===i?i:u(t,i,!0))===(a=n===i?i:u(n,i,!0)))throw l.createError("comparePoints got to case 4 and childA and childB are the same!");for(s=i.firstChild;s;){if(s===r)return-1;if(s===a)return 1;s=s.nextSibling}},isBrokenNode:b,inspectNode:E,getComputedStyleProperty:e,createTestElement:function(t,e,n){var i=r(t),t=t.createElement("div");t.contentEditable=""+!!n,e&&(t.innerHTML=e);e=i.firstChild;return e?i.insertBefore(t,e):i.appendChild(t),t},removeNode:function(t){return t.parentNode.removeChild(t)},fragmentFromNodeChildren:function(t){for(var e,n=p(t).createDocumentFragment();e=t.firstChild;)n.appendChild(e);return n},createIterator:function(t){return new w(t)},DomPosition:C},n.DOMException=O}),w.createCoreModule("DomRange",["DomUtil"],function(r,t){var s=r.dom,a=r.util,e=s.DomPosition,l=r.DOMException,c=s.isCharacterDataNode,u=s.getNodeIndex,h=s.isOrIsAncestorOf,o=s.getDocument,d=s.comparePoints,f=s.splitDataNode,p=s.getClosestAncestorIn,g=s.getNodeLength,m=s.arrayContains,v=s.getRootContainer,n=r.features.crashyTextNodes,y=s.removeNode;function b(t,e){return 3!=t.nodeType&&(h(t,e.startContainer)||h(t,e.endContainer))}function E(t){return t.document||o(t.startContainer)}function w(t){return new e(t.parentNode,u(t))}function C(t){return new e(t.parentNode,u(t)+1)}function i(t,e,n){var i=11==t.nodeType?t.firstChild:t;return c(e)?n==e.length?s.insertAfter(t,e):e.parentNode.insertBefore(t,0==n?e:f(e,n)):n>=e.childNodes.length?e.appendChild(t):e.insertBefore(t,e.childNodes[n]),i}function O(t,e,n){if(W(t),W(e),E(e)!=E(t))throw new l("WRONG_DOCUMENT_ERR");var i=d(t.startContainer,t.startOffset,e.endContainer,e.endOffset),e=d(t.endContainer,t.endOffset,e.startContainer,e.startOffset);return n?i<=0&&0<=e:i<0&&0<e}function x(t,e,n){var i,o,r,a;for(n=n||{stop:!1};r=t.next();)if(t.isPartiallySelectedSubtree()){if(!1===e(r))return n.stop=!0,0;if(x(a=t.getSubtreeIterator(),e,n),a.detach(),n.stop)return}else for(i=s.createIterator(r);o=i.next();)if(!1===e(o))return n.stop=!0,0}function T(t){for(var e;t.next();)t.isPartiallySelectedSubtree()?(T(e=t.getSubtreeIterator()),e.detach()):t.remove()}function _(t){for(var e,n,i=E(t.range).createDocumentFragment();e=t.next();){if(t.isPartiallySelectedSubtree()?(e=e.cloneNode(!1),n=t.getSubtreeIterator(),e.appendChild(_(n)),n.detach()):t.remove(),10==e.nodeType)throw new l("HIERARCHY_REQUEST_ERR");i.appendChild(e)}return i}function S(t){return"["+(void 0===t.getName?"Range":t.getName())+"("+s.inspectNode(t.startContainer)+":"+t.startOffset+", "+s.inspectNode(t.endContainer)+":"+t.endOffset+")]"}function k(t,e){this.range=t,this.clonePartiallySelectedTextNodes=e,t.collapsed||(this.sc=t.startContainer,this.so=t.startOffset,this.ec=t.endContainer,this.eo=t.endOffset,t=t.commonAncestorContainer,this.sc===this.ec&&c(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==t||c(this.sc)?p(this.sc,t,!0):this.sc.childNodes[this.so],this._last=this.ec!==t||c(this.ec)?p(this.ec,t,!0):this.ec.childNodes[this.eo-1]))}k.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var t=this._current=this._next;return t&&(this._next=t!==this._last?t.nextSibling:null,c(t)&&this.clonePartiallySelectedTextNodes&&(t===this.ec&&(t=t.cloneNode(!0)).deleteData(this.eo,t.length-this.eo),this._current===this.sc&&(t=t.cloneNode(!0)).deleteData(0,this.so))),t},remove:function(){var t,e,n=this._current;!c(n)||n!==this.sc&&n!==this.ec?n.parentNode&&y(n):(t=n===this.sc?this.so:0)!=(e=n===this.ec?this.eo:n.length)&&n.deleteData(t,e-t)},isPartiallySelectedSubtree:function(){return b(this._current,this.range)},getSubtreeIterator:function(){var t,e,n,i,o,r;return this.isSingleCharacterDataNode?(t=this.range.cloneRange()).collapse(!1):(t=new ut(E(this.range)),e=this._current,i=0,r=g(o=n=e),h(e,this.sc)&&(n=this.sc,i=this.so),h(e,this.ec)&&(o=this.ec,r=this.eo),ct(t,n,i,o,r)),new k(t,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var A=[1,3,4,5,7,8,10],R=[2,9,11],D=[1,3,4,5,7,8,10,11],P=[1,3,4,5,7,8];function L(o){return function(t,e){for(var n,i=e?t:t.parentNode;i;){if(n=i.nodeType,m(o,n))return i;i=i.parentNode}return null}}var N=L([9,11]),M=L([5,6,10,12]),B=L([6,10,12]);function j(t,e){if(B(t,e))throw new l("INVALID_NODE_TYPE_ERR")}function H(t,e){if(!m(e,t.nodeType))throw new l("INVALID_NODE_TYPE_ERR")}function I(t,e){if(e<0||e>(c(t)?t:t.childNodes).length)throw new l("INDEX_SIZE_ERR")}function F(t,e){if(N(t,!0)!==N(e,!0))throw new l("WRONG_DOCUMENT_ERR")}function q(t){if(M(t,!0))throw new l("NO_MODIFICATION_ALLOWED_ERR")}function z(t,e){if(!t)throw new l(e)}function Y(t,e){return e<=(c(t)?t:t.childNodes).length}function X(t){return!!t.startContainer&&!!t.endContainer&&!(n&&(s.isBrokenNode(t.startContainer)||s.isBrokenNode(t.endContainer)))&&v(t.startContainer)==v(t.endContainer)&&Y(t.startContainer,t.startOffset)&&Y(t.endContainer,t.endOffset)}function W(t){if(!X(t))throw new Error("Range error: Range is not valid. This usually happens after DOM mutation. Range: ("+t.inspect()+")")}var U=document.createElement("style"),V=!1;try{U.innerHTML="<b>x</b>",V=3==U.firstChild.nodeType}catch(r){}function G(t,e){W(t);var n=t.startContainer,i=t.startOffset,o=t.endContainer,r=t.endOffset,a=n===o;c(o)&&0<r&&r<o.length&&f(o,r,e),c(n)&&0<i&&i<n.length&&(n=f(n,i,e),a?(r-=i,o=n):o==n.parentNode&&r>=u(n)&&r++,i=0),t.setStartAndEnd(n,i,o,r)}function J(t){W(t);var e=t.commonAncestorContainer.parentNode.cloneNode(!1);return e.appendChild(t.cloneContents()),e.innerHTML}r.features.htmlParsingConforms=V;var $=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],Q=0,K=1,Z=2,tt=3,et=0,nt=1,it=2,ot=3;function rt(t){t.START_TO_START=Q,t.START_TO_END=K,t.END_TO_END=Z,t.END_TO_START=tt,t.NODE_BEFORE=et,t.NODE_AFTER=nt,t.NODE_BEFORE_AND_AFTER=it,t.NODE_INSIDE=ot}function at(t){rt(t),rt(t.prototype)}function st(r,a){return function(){W(this);var t=this.startContainer,e=this.startOffset,n=this.commonAncestorContainer,i=new k(this,!0);t!==n&&(t=(o=C(p(t,n,!0))).node,e=o.offset),x(i,q),i.reset();var o=r(i);return i.detach(),a(this,t,e,t,e),o}}function lt(t,h){function e(e,n){return function(t){H(t,A),H(v(t),R);t=(e?w:C)(t);(n?i:o)(this,t.node,t.offset)}}function i(t,e,n){var i=t.endContainer,o=t.endOffset;e===t.startContainer&&n===t.startOffset||(v(e)==v(i)&&1!=d(e,n,i,o)||(i=e,o=n),h(t,e,n,i,o))}function o(t,e,n){var i=t.startContainer,o=t.startOffset;e===t.endContainer&&n===t.endOffset||(v(e)==v(i)&&-1!=d(e,n,i,o)||(i=e,o=n),h(t,i,o,e,n))}function n(){}n.prototype=r.rangePrototype,t.prototype=new n,a.extend(t.prototype,{setStart:function(t,e){j(t,!0),I(t,e),i(this,t,e)},setEnd:function(t,e){j(t,!0),I(t,e),o(this,t,e)},setStartAndEnd:function(){var t=arguments,e=t[0],n=t[1],i=e,o=n;switch(t.length){case 3:o=t[2];break;case 4:i=t[2],o=t[3]}h(this,e,n,i,o)},setBoundary:function(t,e,n){this["set"+(n?"Start":"End")](t,e)},setStartBefore:e(!0,!0),setStartAfter:e(!1,!0),setEndBefore:e(!0,!1),setEndAfter:e(!1,!1),collapse:function(t){W(this),t?h(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):h(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(t){j(t,!0),h(this,t,0,t,g(t))},selectNode:function(t){j(t,!1),H(t,A);var e=w(t),t=C(t);h(this,e.node,e.offset,t.node,t.offset)},extractContents:st(_,h),deleteContents:st(T,h),canSurroundContents:function(){W(this),q(this.startContainer),q(this.endContainer);var t=new k(this,!0),e=t._first&&b(t._first,this)||t._last&&b(t._last,this);return t.detach(),!e},splitBoundaries:function(){G(this)},splitBoundariesPreservingPositions:function(t){G(this,t)},normalizeBoundaries:function(){W(this);function t(t){var e=t.nextSibling;e&&e.nodeType==t.nodeType&&(s=(a=t).length,t.appendData(e.data),y(e))}function e(t){var e,n=t.previousSibling;n&&n.nodeType==t.nodeType&&(e=(o=t).length,r=n.length,t.insertData(0,n.data),y(n),o==a?(s+=r,a=o):a==t.parentNode&&(n=u(t),s==n?(a=t,s=e):n<s&&s--))}var n,i,o=this.startContainer,r=this.startOffset,a=this.endContainer,s=this.endOffset,l=!0;c(a)?s==a.length?t(a):0==s&&(i=a.previousSibling)&&i.nodeType==a.nodeType&&(s=i.length,o==a&&(l=!1),i.appendData(a.data),y(a),a=i):(0<s&&((n=a.childNodes[s-1])&&c(n)&&t(n)),l=!this.collapsed),l?c(o)?0==r?e(o):r==o.length&&(i=o.nextSibling)&&i.nodeType==o.nodeType&&(a==i&&(s+=(a=o).length),o.appendData(i.data),y(i)):r<o.childNodes.length&&((i=o.childNodes[r])&&c(i)&&e(i)):(o=a,r=s),h(this,o,r,a,s)},collapseToPoint:function(t,e){j(t,!0),I(t,e),this.setStartAndEnd(t,e)}}),at(t)}function ht(t){t.collapsed=t.startContainer===t.endContainer&&t.startOffset===t.endOffset,t.commonAncestorContainer=t.collapsed?t.startContainer:s.getCommonAncestor(t.startContainer,t.endContainer)}function ct(t,e,n,i,o){t.startContainer=e,t.startOffset=n,t.endContainer=i,t.endOffset=o,t.document=s.getDocument(e),ht(t)}function ut(t){this.startContainer=t,this.startOffset=0,this.endContainer=t,this.endOffset=0,this.document=t,ht(this)}a.extend(r.rangePrototype,{compareBoundaryPoints:function(t,e){W(this),F(this.startContainer,e.startContainer);var n=t==tt||t==Q?"start":"end",i=t==K||t==Q?"start":"end",o=this[n+"Container"],t=this[n+"Offset"],n=e[i+"Container"],i=e[i+"Offset"];return d(o,t,n,i)},insertNode:function(t){if(W(this),H(t,D),q(this.startContainer),h(t,this.startContainer))throw new l("HIERARCHY_REQUEST_ERR");t=i(t,this.startContainer,this.startOffset);this.setStartBefore(t)},cloneContents:function(){if(W(this),this.collapsed)return E(this).createDocumentFragment();if(this.startContainer===this.endContainer&&c(this.startContainer))return(e=this.startContainer.cloneNode(!0)).data=e.data.slice(this.startOffset,this.endOffset),(t=E(this).createDocumentFragment()).appendChild(e),t;var t=new k(this,!0),e=function t(e){for(var n,i,o=E(e.range).createDocumentFragment();n=e.next();){if(i=e.isPartiallySelectedSubtree(),n=n.cloneNode(!i),i&&(i=e.getSubtreeIterator(),n.appendChild(t(i)),i.detach()),10==n.nodeType)throw new l("HIERARCHY_REQUEST_ERR");o.appendChild(n)}return o}(t);return t.detach(),e},canSurroundContents:function(){W(this),q(this.startContainer),q(this.endContainer);var t=new k(this,!0),e=t._first&&b(t._first,this)||t._last&&b(t._last,this);return t.detach(),!e},surroundContents:function(t){if(H(t,P),!this.canSurroundContents())throw new l("INVALID_STATE_ERR");var e=this.extractContents();if(t.hasChildNodes())for(;t.lastChild;)t.removeChild(t.lastChild);i(t,this.startContainer,this.startOffset),t.appendChild(e),this.selectNode(t)},cloneRange:function(){W(this);for(var t,e=new ut(E(this)),n=$.length;n--;)e[t=$[n]]=this[t];return e},toString:function(){W(this);var t=this.startContainer;if(t===this.endContainer&&c(t))return 3==t.nodeType||4==t.nodeType?t.data.slice(this.startOffset,this.endOffset):"";var e=[],t=new k(this,!0);return x(t,function(t){3!=t.nodeType&&4!=t.nodeType||e.push(t.data)}),t.detach(),e.join("")},compareNode:function(t){W(this);var e=t.parentNode,n=u(t);if(!e)throw new l("NOT_FOUND_ERR");t=this.comparePoint(e,n),n=this.comparePoint(e,n+1);return t<0?0<n?it:et:0<n?nt:ot},comparePoint:function(t,e){return W(this),z(t,"HIERARCHY_REQUEST_ERR"),F(t,this.startContainer),d(t,e,this.startContainer,this.startOffset)<0?-1:0<d(t,e,this.endContainer,this.endOffset)?1:0},createContextualFragment:V?function(t){var e=this.startContainer,n=o(e);if(!e)throw new l("INVALID_STATE_ERR");var i=null;return 1==e.nodeType?i=e:c(e)&&(i=s.parentElement(e)),(i=null===i||"HTML"==i.nodeName&&s.isHtmlNamespace(o(i).documentElement)&&s.isHtmlNamespace(i)?n.createElement("body"):i.cloneNode(!1)).innerHTML=t,s.fragmentFromNodeChildren(i)}:function(t){var e=E(this).createElement("body");return e.innerHTML=t,s.fragmentFromNodeChildren(e)},toHtml:function(){return J(this)},intersectsNode:function(t,e){if(W(this),v(t)!=v(this.startContainer))return!1;var n=t.parentNode,i=u(t);if(!n)return!0;t=d(n,i,this.endContainer,this.endOffset),i=d(n,i+1,this.startContainer,this.startOffset);return e?t<=0&&0<=i:t<0&&0<i},isPointInRange:function(t,e){return W(this),z(t,"HIERARCHY_REQUEST_ERR"),F(t,this.startContainer),0<=d(t,e,this.startContainer,this.startOffset)&&d(t,e,this.endContainer,this.endOffset)<=0},intersectsRange:function(t){return O(this,t,!1)},intersectsOrTouchesRange:function(t){return O(this,t,!0)},intersection:function(t){if(this.intersectsRange(t)){var e=d(this.startContainer,this.startOffset,t.startContainer,t.startOffset),n=d(this.endContainer,this.endOffset,t.endContainer,t.endOffset),i=this.cloneRange();return-1==e&&i.setStart(t.startContainer,t.startOffset),1==n&&i.setEnd(t.endContainer,t.endOffset),i}return null},union:function(t){if(this.intersectsOrTouchesRange(t)){var e=this.cloneRange();return-1==d(t.startContainer,t.startOffset,this.startContainer,this.startOffset)&&e.setStart(t.startContainer,t.startOffset),1==d(t.endContainer,t.endOffset,this.endContainer,this.endOffset)&&e.setEnd(t.endContainer,t.endOffset),e}throw new l("Ranges do not intersect")},containsNode:function(t,e){return e?this.intersectsNode(t,!1):this.compareNode(t)==ot},containsNodeContents:function(t){return 0<=this.comparePoint(t,0)&&this.comparePoint(t,g(t))<=0},containsRange:function(t){var e=this.intersection(t);return null!==e&&t.equals(e)},containsNodeText:function(t){var e=this.cloneRange();e.selectNode(t);var n=e.getNodes([3]);if(0<n.length){e.setStart(n[0],0);n=n.pop();return e.setEnd(n,n.length),this.containsRange(e)}return this.containsNodeContents(t)},getNodes:function(t,e){return W(this),function(n,i){var o,r=!(!t||!t.length),a=!!i;r&&(o=new RegExp("^("+t.join("|")+")$"));var s=[];return x(new k(n,!1),function(t){var e;r&&!o.test(t.nodeType)||a&&!i(t)||(t==(e=n.startContainer)&&c(e)&&n.startOffset==e.length||(t==(e=n.endContainer)&&c(e)&&0==n.endOffset||s.push(t)))}),s}(this,e)},getDocument:function(){return E(this)},collapseBefore:function(t){this.setEndBefore(t),this.collapse(!1)},collapseAfter:function(t){this.setStartAfter(t),this.collapse(!0)},getBookmark:function(t){var e=E(this),n=r.createRange(e);t=t||s.getBody(e),n.selectNodeContents(t);var i=this.intersection(n),o=0,e=0;return i&&(n.setEnd(i.startContainer,i.startOffset),e=(o=n.toString().length)+i.toString().length),{start:o,end:e,containerNode:t}},moveToBookmark:function(t){var e=t.containerNode,n=0;this.setStart(e,0),this.collapse(!0);for(var i,o,r,a,s=[e],l=!1,h=!1;!h&&(i=s.pop());)if(3==i.nodeType)o=n+i.length,!l&&t.start>=n&&t.start<=o&&(this.setStart(i,t.start-n),l=!0),l&&t.end>=n&&t.end<=o&&(this.setEnd(i,t.end-n),h=!0),n=o;else for(r=(a=i.childNodes).length;r--;)s.push(a[r])},getName:function(){return"DomRange"},equals:function(t){return ut.rangesEqual(this,t)},isValid:function(){return X(this)},inspect:function(){return S(this)},detach:function(){}}),lt(ut,ct),a.extend(ut,{rangeProperties:$,RangeIterator:k,copyComparisonConstants:at,createPrototypeRange:lt,inspect:S,toHtml:J,getRangeDocument:E,rangesEqual:function(t,e){return t.startContainer===e.startContainer&&t.startOffset===e.startOffset&&t.endContainer===e.endContainer&&t.endOffset===e.endOffset}}),r.DomRange=ut}),w.createCoreModule("WrappedRange",["DomRange"],function(l,h){var c,t,o,i,e,n,v=l.dom,u=l.util,y=v.DomPosition,d=l.DomRange,f=v.getBody,p=v.getContentDocument,b=v.isCharacterDataNode;l.features.implementsDomRange&&function(){var e,i=d.rangeProperties;function o(t){for(var e,n=i.length;n--;)t[e=i[n]]=t.nativeRange[e];t.collapsed=t.startContainer===t.endContainer&&t.startOffset===t.endOffset}c=function(t){if(!t)throw h.createError("WrappedRange: Range must be specified");this.nativeRange=t,o(this)},d.createPrototypeRange(c,function(t,e,n,i,o){var r=t.startContainer!==e||t.startOffset!=n,a=t.endContainer!==i||t.endOffset!=o,s=!t.equals(t.nativeRange);(r||a||s)&&(t.setEnd(i,o),t.setStart(e,n))}),(e=c.prototype).selectNode=function(t){this.nativeRange.selectNode(t),o(this)},e.cloneContents=function(){return this.nativeRange.cloneContents()},e.surroundContents=function(t){this.nativeRange.surroundContents(t),o(this)},e.collapse=function(t){this.nativeRange.collapse(t),o(this)},e.cloneRange=function(){return new c(this.nativeRange.cloneRange())},e.refresh=function(){o(this)},e.toString=function(){return this.nativeRange.toString()};var t=document.createTextNode("test");f(document).appendChild(t);var n=document.createRange();n.setStart(t,0),n.setEnd(t,0);try{n.setStart(t,1),e.setStart=function(t,e){this.nativeRange.setStart(t,e),o(this)},e.setEnd=function(t,e){this.nativeRange.setEnd(t,e),o(this)},s=function(e){return function(t){this.nativeRange[e](t),o(this)}}}catch(t){e.setStart=function(e,n){try{this.nativeRange.setStart(e,n)}catch(t){this.nativeRange.setEnd(e,n),this.nativeRange.setStart(e,n)}o(this)},e.setEnd=function(e,n){try{this.nativeRange.setEnd(e,n)}catch(t){this.nativeRange.setStart(e,n),this.nativeRange.setEnd(e,n)}o(this)},s=function(n,i){return function(e){try{this.nativeRange[n](e)}catch(t){this.nativeRange[i](e),this.nativeRange[n](e)}o(this)}}}e.setStartBefore=s("setStartBefore","setEndBefore"),e.setStartAfter=s("setStartAfter","setEndAfter"),e.setEndBefore=s("setEndBefore","setStartBefore"),e.setEndAfter=s("setEndAfter","setStartAfter"),e.selectNodeContents=function(t){this.setStartAndEnd(t,0,v.getNodeLength(t))},n.selectNodeContents(t),n.setEnd(t,3);var r=document.createRange();r.selectNodeContents(t),r.setEnd(t,4),r.setStart(t,2),-1==n.compareBoundaryPoints(n.START_TO_END,r)&&1==n.compareBoundaryPoints(n.END_TO_START,r)?e.compareBoundaryPoints=function(t,e){return t==(e=e.nativeRange||e).START_TO_END?t=e.END_TO_START:t==e.END_TO_START&&(t=e.START_TO_END),this.nativeRange.compareBoundaryPoints(t,e)}:e.compareBoundaryPoints=function(t,e){return this.nativeRange.compareBoundaryPoints(t,e.nativeRange||e)};var a=document.createElement("div");a.innerHTML="123";var s=a.firstChild,r=f(document);r.appendChild(a),n.setStart(s,1),n.setEnd(s,2),n.deleteContents(),"13"==s.data&&(e.deleteContents=function(){this.nativeRange.deleteContents(),o(this)},e.extractContents=function(){var t=this.nativeRange.extractContents();return o(this),t}),r.removeChild(a),r=null,u.isHostMethod(n,"createContextualFragment")&&(e.createContextualFragment=function(t){return this.nativeRange.createContextualFragment(t)}),f(document).removeChild(t),e.getName=function(){return"WrappedRange"},l.WrappedRange=c,l.createNativeRange=function(t){return(t=p(t,h,"createNativeRange")).createRange()}}(),l.features.implementsTextRange&&(o=function(t,e,n,i,o){var r=t.duplicate();r.collapse(n);var a=r.parentElement();if(!(a=!v.isOrIsAncestorOf(e,a)?e:a).canHaveHTML){e=new y(a.parentNode,v.getNodeIndex(a));return{boundaryPosition:e,nodeInfo:{nodeIndex:e.offset,containerElement:e.node}}}var s=v.getDocument(a).createElement("span");s.parentNode&&v.removeNode(s);for(var l,h=n?"StartToStart":"StartToEnd",c=o&&o.containerElement==a?o.nodeIndex:0,u=a.childNodes.length,d=u,f=d;f==u?a.appendChild(s):a.insertBefore(s,a.childNodes[f]),r.moveToElementText(s),0!=(l=r.compareEndPoints(h,t))&&c!=d;){if(-1==l){if(d==c+1)break;c=f}else d=d==c+1?c:f;f=Math.floor((c+d)/2),a.removeChild(s)}if(o=s.nextSibling,-1==l&&o&&b(o)){if(r.setEndPoint(n?"EndToStart":"EndToEnd",t),/[\r\n]/.test(o.data))for(var p=r.duplicate(),g=p.text.replace(/\r\n/g,"\r").length,m=p.moveStart("character",g);-1==(l=p.compareEndPoints("StartToEnd",p));)m++,p.moveStart("character",1);else m=r.text.length;g=new y(o,m)}else o=(i||!n)&&s.previousSibling,g=(n=(i||n)&&s.nextSibling)&&b(n)?new y(n,0):o&&b(o)?new y(o,o.data.length):new y(a,v.getNodeIndex(s));return v.removeNode(s),{boundaryPosition:g,nodeInfo:{nodeIndex:f,containerElement:a}}},i=function(t,e){var n,i,o=t.offset,r=v.getDocument(t.node),a=f(r).createTextRange(),s=b(t.node),t=s?(n=t.node).parentNode:(n=o<(i=t.node.childNodes).length?i[o]:null,t.node);return(r=r.createElement("span")).innerHTML="&#feff;",n?t.insertBefore(r,n):t.appendChild(r),a.moveToElementText(r),a.collapse(!e),t.removeChild(r),s&&a[e?"moveStart":"moveEnd"]("character",o),a},(t=function(t){this.textRange=t,this.refresh()}).prototype=new d(document),t.prototype.refresh=function(){var t,e,n=function(t){var e=t.parentElement(),n=t.duplicate();n.collapse(!0);var i=n.parentElement();(n=t.duplicate()).collapse(!1);n=n.parentElement(),n=i==n?i:v.getCommonAncestor(i,n);return n==e?n:v.getCommonAncestor(e,n)}(this.textRange),i=0==(e=this.textRange).compareEndPoints("StartToEnd",e)?t=o(this.textRange,n,!0,!0).boundaryPosition:(t=(i=o(this.textRange,n,!0,!1)).boundaryPosition,o(this.textRange,n,!1,!1,i.nodeInfo).boundaryPosition);this.setStart(t.node,t.offset),this.setEnd(i.node,i.offset)},t.prototype.getName=function(){return"WrappedTextRange"},d.copyComparisonConstants(t),t.rangeToTextRange=e=function(t){if(t.collapsed)return i(new y(t.startContainer,t.startOffset),!0);var e=i(new y(t.startContainer,t.startOffset),!0),n=i(new y(t.endContainer,t.endOffset),!1),t=f(d.getRangeDocument(t)).createTextRange();return t.setEndPoint("StartToStart",e),t.setEndPoint("EndToEnd",n),t},t.prototype.toTextRange=function(){return e(this)},l.WrappedTextRange=t,l.features.implementsDomRange&&!l.config.preferTextRange||(void 0===(n=Function("return this;")()).Range&&(n.Range=t),l.createNativeRange=function(t){return t=p(t,h,"createNativeRange"),f(t).createTextRange()},l.WrappedRange=t)),l.createRange=function(t){return t=p(t,h,"createRange"),new l.WrappedRange(l.createNativeRange(t))},l.createRangyRange=function(t){return t=p(t,h,"createRangyRange"),new d(t)},u.createAliasForDeprecatedMethod(l,"createIframeRange","createRange"),u.createAliasForDeprecatedMethod(l,"createIframeRangyRange","createRangyRange"),l.addShimListener(function(t){var e=t.document;void 0===e.createRange&&(e.createRange=function(){return l.createRange(e)}),e=t=null})}),w.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(h,s){h.config.checkSelectionRanges=!0;var o,i,c=h.dom,t=h.util,e=t.isHostMethod,l=h.DomRange,r=h.WrappedRange,n=h.DOMException,u=c.DomPosition,a=h.features,d=c.getDocument,f=c.getBody,p=l.rangesEqual;function g(t){return"string"==typeof t?/^backward(s)?$/i.test(t):!!t}function m(t,e){if(t){if(c.isWindow(t))return t;if(t instanceof F)return t.win;e=c.getContentDocument(t,s,e);return c.getWindow(e)}return window}function v(t){return m(t,"getDocSelection").document.selection}function y(t){var e=!1;return e=t.anchorNode?1==c.comparePoints(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset):e}var b=e(window,"getSelection"),E=t.isHostObject(document,"selection");a.implementsWinGetSelection=b;var w=(a.implementsDocSelection=E)&&(!b||h.config.preferTextRange);if(w)o=v,h.isSelectionValid=function(t){var e=m(t,"isSelectionValid").document,t=e.selection;return"None"!=t.type||d(t.createRange().parentElement())==e};else{if(!b)return s.fail("Neither document.selection or window.getSelection() detected."),!1;o=function(t){return m(t,"getWinSelection").getSelection()},h.isSelectionValid=function(){return!0}}var C=(h.getNativeSelection=o)();if(!C)return s.fail("Native selection was null (possibly issue 138?)"),!1;var O=h.createNativeRange(document),x=f(document),T=t.areHostProperties(C,["anchorNode","focusNode","anchorOffset","focusOffset"]);a.selectionHasAnchorAndFocus=T;var _=e(C,"extend");a.selectionHasExtend=_;b="number"==typeof C.rangeCount;a.selectionHasRangeCount=b;var S=!1,k=!0,A=_?function(t,e){var n=l.getRangeDocument(e),n=h.createRange(n);n.collapseToPoint(e.endContainer,e.endOffset),t.addRange(N(n)),t.extend(e.startContainer,e.startOffset)}:null;t.areHostMethods(C,["addRange","getRangeAt","removeAllRanges"])&&"number"==typeof C.rangeCount&&a.implementsDomRange&&function(){var t=window.getSelection();if(t){for(var e=t.rangeCount,n=1<e,i=[],o=y(t),r=0;r<e;++r)i[r]=t.getRangeAt(r);var a=c.createTestElement(document,"",!1),s=a.appendChild(document.createTextNode("   ")),l=document.createRange();for(l.setStart(s,1),l.collapse(!0),t.removeAllRanges(),t.addRange(l),k=1==t.rangeCount,t.removeAllRanges(),n||(n=window.navigator.appVersion.match(/Chrome\/(.*?) /),S=!(n&&36<=parseInt(n[1]))&&(n=l.cloneRange(),l.setStart(s,0),n.setEnd(s,3),n.setStart(s,2),t.addRange(l),t.addRange(n),2==t.rangeCount)),c.removeNode(a),t.removeAllRanges(),r=0;r<e;++r)0==r&&o?A?A(t,i[r]):(h.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),t.addRange(i[r])):t.addRange(i[r])}}(),a.selectionSupportsMultipleRanges=S,a.collapsedNonEditableSelectionsSupported=k;var R,D=!1;function P(t,e,n){var i=n?"end":"start",n=n?"start":"end";t.anchorNode=e[i+"Container"],t.anchorOffset=e[i+"Offset"],t.focusNode=e[n+"Container"],t.focusOffset=e[n+"Offset"]}function L(t){t.anchorNode=t.focusNode=null,t.anchorOffset=t.focusOffset=0,t.rangeCount=0,t.isCollapsed=!0,t._ranges.length=0}function N(t){var e;return t instanceof l?((e=h.createNativeRange(t.getDocument())).setEnd(t.endContainer,t.endOffset),e.setStart(t.startContainer,t.startOffset)):t instanceof r?e=t.nativeRange:a.implementsDomRange&&t instanceof c.getWindow(t.startContainer).Range&&(e=t),e}function M(t){var e=t.getNodes();if(!function(t){if(t.length&&1==t[0].nodeType){for(var e=1,n=t.length;e<n;++e)if(!c.isAncestorOf(t[0],t[e]))return;return 1}}(e))throw s.createError("getSingleElementFromRange: range "+t.inspect()+" did not consist of a single element");return e[0]}function B(t){return t&&void 0!==t.text}function j(t,e){e=new r(e);t._ranges=[e],P(t,e,!1),t.rangeCount=1,t.isCollapsed=e.collapsed}function H(t){if(t._ranges.length=0,"None"==t.docSelection.type)L(t);else{var e=t.docSelection.createRange();if(B(e))j(t,e);else{t.rangeCount=e.length;for(var n,i=d(e.item(0)),o=0;o<t.rangeCount;++o)(n=h.createRange(i)).selectNode(e.item(o)),t._ranges.push(n);t.isCollapsed=1==t.rangeCount&&t._ranges[0].collapsed,P(t,t._ranges[t.rangeCount-1],!1)}}}function I(t,e){for(var n=t.docSelection.createRange(),i=M(e),e=d(n.item(0)),o=f(e).createControlRange(),r=0,a=n.length;r<a;++r)o.add(n.item(r));try{o.add(i)}catch(t){throw s.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}o.select(),H(t)}function F(t,e,n){this.nativeSelection=t,this.docSelection=e,this._ranges=[],this.win=n,this.refresh()}function q(t){t.win=t.anchorNode=t.focusNode=t._ranges=null,t.rangeCount=t.anchorOffset=t.focusOffset=0,t.detached=!0}x&&e(x,"createControlRange")&&(U=x.createControlRange(),t.areHostProperties(U,["item","add"])&&(D=!0)),a.implementsControlRange=D,i=T?function(t){return t.anchorNode===t.focusNode&&t.anchorOffset===t.focusOffset}:function(t){return!!t.rangeCount&&t.getRangeAt(t.rangeCount-1).collapsed},e(C,"getRangeAt")?R=function(t,e){try{return t.getRangeAt(e)}catch(t){return null}}:T&&(R=function(t){var e=d(t.anchorNode),e=h.createRange(e);return e.setStartAndEnd(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset),e.collapsed!==this.isCollapsed&&e.setStartAndEnd(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset),e}),F.prototype=h.selectionPrototype;var z=[];function Y(t,e){for(var n,i,o=z.length;o--;)if(i=(n=z[o]).selection,"deleteAll"==e)q(i);else if(n.win==t)return"delete"==e?(z.splice(o,1),!0):i;return"deleteAll"==e&&(z.length=0),null}function X(t){if(t&&t instanceof F)return t.refresh(),t;var e=Y(t=m(t,"getNativeSelection")),n=o(t),i=E?v(t):null;return e?(e.nativeSelection=n,e.docSelection=i,e.refresh()):(e=new F(n,i,t),z.push({win:t,selection:e})),e}h.getSelection=X,t.createAliasForDeprecatedMethod(h,"getIframeSelection","getSelection");var W,U=F.prototype;function V(t,e){for(var n,i=d(e[0].startContainer),o=f(i).createControlRange(),r=0,a=e.length;r<a;++r){n=M(e[r]);try{o.add(n)}catch(t){throw s.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}o.select(),H(t)}if(!w&&T&&t.areHostMethods(C,["removeAllRanges","addRange"])){U.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),L(this)};function G(t,e){A(t.nativeSelection,e),t.refresh()}U.addRange=b?function(t,e){if(D&&E&&"Control"==this.docSelection.type)I(this,t);else if(g(e)&&_)G(this,t);else{var n=S?this.rangeCount:(this.removeAllRanges(),0),e=N(t).cloneRange();try{this.nativeSelection.addRange(e)}catch(t){}this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==n+1?(!h.config.checkSelectionRanges||(n=R(this.nativeSelection,this.rangeCount-1))&&!p(n,t)&&(t=new r(n)),this._ranges[this.rangeCount-1]=t,P(this,t,$(this.nativeSelection)),this.isCollapsed=i(this)):this.refresh()}}:function(t,e){g(e)&&_?G(this,t):(this.nativeSelection.addRange(N(t)),this.refresh())},U.setRanges=function(t){if(D&&E&&1<t.length)V(this,t);else{this.removeAllRanges();for(var e=0,n=t.length;e<n;++e)this.addRange(t[e])}}}else{if(!(e(C,"empty")&&e(O,"select")&&D&&w))return s.fail("No means of selecting a Range or TextRange was found"),!1;U.removeAllRanges=function(){try{var t,e;this.docSelection.empty(),"None"!=this.docSelection.type&&(this.anchorNode?t=d(this.anchorNode):"Control"!=this.docSelection.type||(e=this.docSelection.createRange()).length&&(t=d(e.item(0))),t&&(f(t).createTextRange().select(),this.docSelection.empty()))}catch(t){}L(this)},U.addRange=function(t){"Control"==this.docSelection.type?I(this,t):(h.WrappedTextRange.rangeToTextRange(t).select(),this._ranges[0]=t,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,P(this,t,!1))},U.setRanges=function(t){this.removeAllRanges();var e=t.length;1<e?V(this,t):e&&this.addRange(t[0])}}if(U.getRangeAt=function(t){if(t<0||t>=this.rangeCount)throw new n("INDEX_SIZE_ERR");return this._ranges[t].cloneRange()},w)W=function(t){var e;h.isSelectionValid(t.win)?e=t.docSelection.createRange():(e=f(t.win.document).createTextRange()).collapse(!0),"Control"==t.docSelection.type?H(t):B(e)?j(t,e):L(t)};else if(e(C,"getRangeAt")&&"number"==typeof C.rangeCount)W=function(t){if(D&&E&&"Control"==t.docSelection.type)H(t);else if(t._ranges.length=t.rangeCount=t.nativeSelection.rangeCount,t.rangeCount){for(var e=0,n=t.rangeCount;e<n;++e)t._ranges[e]=new h.WrappedRange(t.nativeSelection.getRangeAt(e));P(t,t._ranges[t.rangeCount-1],$(t.nativeSelection)),t.isCollapsed=i(t)}else L(t)};else{if(!T||"boolean"!=typeof C.isCollapsed||"boolean"!=typeof O.collapsed||!a.implementsDomRange)return s.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;W=function(t){var e,n=t.nativeSelection;n.anchorNode?(e=R(n,0),t._ranges=[e],t.rangeCount=1,e=(n=t).nativeSelection,n.anchorNode=e.anchorNode,n.anchorOffset=e.anchorOffset,n.focusNode=e.focusNode,n.focusOffset=e.focusOffset,t.isCollapsed=i(t)):L(t)}}U.refresh=function(t){var e=t?this._ranges.slice(0):null,n=this.anchorNode,i=this.anchorOffset;if(W(this),t){var o=e.length;if(o!=this._ranges.length)return!0;if(this.anchorNode!=n||this.anchorOffset!=i)return!0;for(;o--;)if(!p(e[o],this._ranges[o]))return!0;return!1}};function J(t,e){var n=t.getAllRanges();t.removeAllRanges();for(var i=0,o=n.length;i<o;++i)p(e,n[i])||t.addRange(n[i]);t.rangeCount||L(t)}var $;function Q(t,e){if(t.win.document!=d(e))throw new n("WRONG_DOCUMENT_ERR")}function K(i){return function(t,e){var n;this.rangeCount?(n=this.getRangeAt(0))["set"+(i?"Start":"End")](t,e):(n=h.createRange(this.win.document)).setStartAndEnd(t,e),this.setSingleRange(n,this.isBackward())}}function Z(t){var e=[],n=new u(t.anchorNode,t.anchorOffset),i=new u(t.focusNode,t.focusOffset),o="function"==typeof t.getName?t.getName():"Selection";if(void 0!==t.rangeCount)for(var r=0,a=t.rangeCount;r<a;++r)e[r]=l.inspect(t.getRangeAt(r));return"["+o+"(Ranges: "+e.join(", ")+")(anchor: "+n.inspect()+", focus: "+i.inspect()+"]"}U.removeRange=D&&E?function(t){if("Control"==this.docSelection.type){for(var e=this.docSelection.createRange(),n=M(t),i=d(e.item(0)),o=f(i).createControlRange(),r=!1,a=0,s=e.length;a<s;++a)e.item(a)!==n||r?o.add(e.item(a)):r=!0;o.select(),H(this)}else J(this,t)}:function(t){J(this,t)},!w&&T&&a.implementsDomRange?($=y,U.isBackward=function(){return $(this)}):$=U.isBackward=function(){return!1},U.isBackwards=U.isBackward,U.toString=function(){for(var t=[],e=0,n=this.rangeCount;e<n;++e)t[e]=""+this._ranges[e];return t.join("")},U.collapse=function(t,e){Q(this,t);var n=h.createRange(t);n.collapseToPoint(t,e),this.setSingleRange(n),this.isCollapsed=!0},U.collapseToStart=function(){if(!this.rangeCount)throw new n("INVALID_STATE_ERR");var t=this._ranges[0];this.collapse(t.startContainer,t.startOffset)},U.collapseToEnd=function(){if(!this.rangeCount)throw new n("INVALID_STATE_ERR");var t=this._ranges[this.rangeCount-1];this.collapse(t.endContainer,t.endOffset)},U.selectAllChildren=function(t){Q(this,t);var e=h.createRange(t);e.selectNodeContents(t),this.setSingleRange(e)},U.deleteFromDocument=function(){if(D&&E&&"Control"==this.docSelection.type){for(var t,e=this.docSelection.createRange();e.length;)t=e.item(0),e.remove(t),c.removeNode(t);this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();if(n.length){this.removeAllRanges();for(var i=0,o=n.length;i<o;++i)n[i].deleteContents();this.addRange(n[o-1])}}},U.eachRange=function(t,e){for(var n=0,i=this._ranges.length;n<i;++n)if(t(this.getRangeAt(n)))return e},U.getAllRanges=function(){var e=[];return this.eachRange(function(t){e.push(t)}),e},U.setSingleRange=function(t,e){this.removeAllRanges(),this.addRange(t,e)},U.callMethodOnEachRange=function(e,n){var i=[];return this.eachRange(function(t){i.push(t[e].apply(t,n||[]))}),i},U.setStart=K(!0),U.setEnd=K(!1),h.rangePrototype.select=function(t){X(this.getDocument()).setSingleRange(this,t)},U.changeEachRange=function(e){var n=[],t=this.isBackward();this.eachRange(function(t){e(t),n.push(t)}),this.removeAllRanges(),t&&1==n.length?this.addRange(n[0],"backward"):this.setRanges(n)},U.containsNode=function(e,n){return this.eachRange(function(t){return t.containsNode(e,n)},!0)||!1},U.getBookmark=function(t){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[t])}},U.moveToBookmark=function(t){for(var e,n,i=[],o=0;e=t.rangeBookmarks[o++];)(n=h.createRange(this.win)).moveToBookmark(e),i.push(n);t.backward?this.setSingleRange(i[0],"backward"):this.setRanges(i)},U.saveRanges=function(){return{backward:this.isBackward(),ranges:this.callMethodOnEachRange("cloneRange")}},U.restoreRanges=function(t){this.removeAllRanges();for(var e,n=0;e=t.ranges[n];++n)this.addRange(e,t.backward&&0==n)},U.toHtml=function(){var e=[];return this.eachRange(function(t){e.push(l.toHtml(t))}),e.join("")},a.implementsTextRange&&(U.getNativeTextRange=function(){if(t=this.docSelection){var t=t.createRange();if(B(t))return t;throw s.createError("getNativeTextRange: selection is a control selection")}if(0<this.rangeCount)return h.WrappedTextRange.rangeToTextRange(this.getRangeAt(0));throw s.createError("getNativeTextRange: selection contains no range")}),U.getName=function(){return"WrappedSelection"},U.inspect=function(){return Z(this)},U.detach=function(){Y(this.win,"delete"),q(this)},F.detachAll=function(){Y(null,"deleteAll")},F.inspect=Z,F.isDirectionBackward=g,h.Selection=F,h.selectionPrototype=U,h.addShimListener(function(t){void 0===t.getSelection&&(t.getSelection=function(){return X(t)}),t=null})});var N=!1,d=function(t){N||(N=!0,!w.initialized&&w.config.autoInitialize&&S())};return b&&("complete"==document.readyState?d():(c(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",d,!1),v(window,"load",d))),w})?i.call(e,n,e,t):i)||(t.exports=i)},function(t,e,n){"use strict";function o(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(n):void 0:null===(t=Object.getPrototypeOf(t))?void 0:o(t,e,n)}var i=n(25),r=n.n(i),i=n(3),i=n.n(i),a=n(1),s=n(0),n=function(t,e,n){return e&&l(t.prototype,e),n&&l(t,n),t};function l(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function h(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)})(c,i.a),n(c,[{key:"init",value:function(t){this.container=t.container,this.headerElement=t.headerElement,this.annotatedElement=t.annotatedElement,this.mode=t.mode,this.annotator=t.annotator,this.permissions=t.permissions||{},this.localized=t.localized||{},this.hasTouch=!!t.options&&t.options.hasTouch,this.isMobile=!!t.options&&t.options.isMobile,t.modeButton&&this.permissions.canAnnotate&&(this.modeButton=t.modeButton,this.showButton()),this.handleThreadEvents=this.handleThreadEvents.bind(this),this.destroyPendingThreads=this.destroyPendingThreads.bind(this)}},{key:"destroy",value:function(){var e=this;Object.keys(this.threads).forEach(function(t){(e.threads[t].all()||[]).forEach(e.unregisterThread.bind(e))}),this.buttonEl&&this.buttonEl.removeEventListener("click",this.toggleMode),this.modeButton&&this.hideButton()}},{key:"getButton",value:function(t){return this.headerElement?this.headerElement.querySelector(t):null}},{key:"showButton",value:function(){this.permissions.canAnnotate&&this.modeButton&&(this.buttonEl=this.getButton(this.modeButton.selector),this.buttonEl&&(this.buttonEl.title=this.modeButton.title,this.buttonEl.classList.remove(s.O),this.toggleMode=this.toggleMode.bind(this),this.buttonEl.addEventListener("click",this.toggleMode)))}},{key:"hideButton",value:function(){this.permissions.canAnnotate&&this.modeButton&&(this.buttonEl=this.getButton(this.modeButton.selector),this.buttonEl&&this.buttonEl.classList.add(s.O))}},{key:"toggleMode",value:function(){this.destroyPendingThreads(),this.modeButton&&this.emit(s.fb.toggleMode)}},{key:"exit",value:function(){this.emit(s.fb.exit,{mode:this.mode}),Object(a.H)(this.headerElement,s.Xb),this.destroyPendingThreads(),this.annotatedElement.classList.remove(s.y),this.annotatedElement.classList.remove(s.h),this.buttonEl.classList.remove(s.c),this.unbindListeners(),this.emit(s.fb.bindDOMListeners),this.hadPendingThreads=!1}},{key:"enter",value:function(){this.annotatedElement.classList.add(s.y),this.annotatedElement.classList.add(s.h),this.buttonEl.classList.add(s.c),this.emit(s.fb.enter,{mode:this.mode}),this.emit(s.fb.unbindDOMListeners),this.bindListeners()}},{key:"isEnabled",value:function(){return!!this.buttonEl&&this.buttonEl.classList.contains(s.c)}},{key:"bindListeners",value:function(){var n=this,t=this.handlers.length;this.setupHandlers();for(var e=t;e<this.handlers.length;e++)!function(t){var e=n.handlers[t];(e.type instanceof Array?e.type:[e.type]).forEach(function(t){return e.eventObj.addEventListener(t,e.func,e.useCapture)})}(e)}},{key:"unbindListeners",value:function(){for(var t=this;0<this.handlers.length;)!function(){var e=t.handlers.pop();(e.type instanceof Array?e.type:[e.type]).forEach(function(t){e.eventObj.removeEventListener(t,e.func,e.useCapture)})}()}},{key:"registerThread",value:function(e){var t,n=this;e&&e.location&&Object(a.w)(e)&&((t=e.location.page||1)in this.threads||(this.threads[t]=new r.a),this.threads[t].insert(e),this.emit(s.fb.register,e),e.addListener("threadevent",function(t){return n.handleThreadEvents(e,t)}))}},{key:"unregisterThread",value:function(t){t&&t.location&&t.location.page&&this.threads[t.location.page]&&(this.threads[t.location.page].remove(t),this.emit(s.fb.unregister,t),t.removeListener("threadevent",this.handleThreadEvents))}},{key:"applyActionToPageThreads",value:function(t,e){this.threads[e]&&(this.threads[e].all()||[]).forEach(t)}},{key:"applyActionToThreads",value:function(e){var n=this;Object.keys(this.threads).forEach(function(t){return n.applyActionToPageThreads(e,t)})}},{key:"getThreadByID",value:function(e){var n=this,i=null;return e&&Object.keys(this.threads).some(function(t){t=n.threads[t];return t?!!(i=t.all().filter(function(t){return t.threadID===e})[0]):!!i}),i}},{key:"removeSelection",value:function(){}},{key:"setupHandlers",value:function(){}},{key:"handleThreadEvents",value:function(t,e){var n=e.event,i=e.data;switch(n){case s.hc.save:case s.hc.cancel:this.hadPendingThreads=!1,this.emit(n,i);break;case s.hc.show:this.visibleThreadID=i.threadID;break;case s.hc.hide:this.visibleThreadID=null;break;case s.hc.threadCleanup:this.unregisterThread(t);break;case s.hc.threadDelete:this.unregisterThread(t),this.emit(n,i);break;case s.hc.deleteError:this.emit(s.a.error,this.localized.deleteError),this.emit(n,i);break;case s.hc.createError:this.emit(s.a.error,this.localized.createError),this.emit(n,i);break;default:this.emit(n,i)}}},{key:"pushElementHandler",value:function(t,e,n){t&&this.handlers.push({eventObj:t,func:n,type:e,useCapture:3<arguments.length&&void 0!==arguments[3]&&arguments[3]})}},{key:"setupHeader",value:function(t,e){var n=t.firstElementChild;Object(a.z)(t,e,n)}},{key:"render",value:function(){var e=this;this.threads&&Object.keys(this.threads).forEach(function(t){e.renderPage(t)})}},{key:"renderPage",value:function(t){var n,i=this;this.threads&&this.threads[t]&&(n=this.threads[t].all()||[]).forEach(function(t,e){return Object(a.E)(t.state)?(i.unregisterThread(t),void t.destroy()):(t.hideDialog(),t.annotatedElement||(n[e].annotatedElement=i.annotatedElement),void t.show())})}},{key:"destroyPendingThreads",value:function(){var e=this,n=!1;return Object.keys(this.threads).forEach(function(t){(e.threads[t].all()||[]).forEach(function(t){Object(a.E)(t.state)?(e.unregisterThread(t),n=!0,e.pendingThreadID=null,t.destroy()):t.isDialogVisible()&&t.hideDialog()})}),n}},{key:"getIntersectingThreads",value:function(t){if(!t||!this.threads||!this.annotator)return[];var e=this.annotator.getLocationFromEvent(t,s.ic.point);if(!e||0===Object.keys(this.threads).length||!this.threads[e.page])return[];t={minX:+e.x-s.b,minY:+e.y-s.b,maxX:+e.x+s.b,maxY:+e.y+s.b};return this.threads[e.page].search(t)}},{key:"emit",value:function(t,e){o(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"emit",this).call(this,t,e),o(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"emit",this).call(this,"annotationcontrollerevent",{event:t,data:e,mode:this.mode})}}]),n=c;function c(){var t,e;!function(t){if(!(t instanceof c))throw new TypeError("Cannot call a class as a function")}(this);for(var n=arguments.length,i=Array(n),o=0;o<n;o++)i[o]=arguments[o];return t=e=h(this,(t=c.__proto__||Object.getPrototypeOf(c)).call.apply(t,[this].concat(i))),e.threads={},e.handlers=[],h(e,t)}e.a=n},function(t,e,n){"use strict";function o(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(n):void 0:null===(t=Object.getPrototypeOf(t))?void 0:o(t,e,n)}var i=n(3),i=n.n(i),r=n(6),a=n(1),s=(n(37),n(0)),n=function(t,e,n){return e&&l(t.prototype,e),n&&l(t,n),t};function l(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)})(h,i.a),n(h,[{key:"destroy",value:function(){var e=this;Object.keys(this.modeControllers).forEach(function(t){e.modeControllers[t].destroy()}),this.unbindDOMListeners(),this.unbindCustomListenersOnService(),this.removeListener(s.a.scale,this.scaleAnnotations)}},{key:"init",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1;this.container=this.options.container,"string"==typeof this.options.container&&(this.container=document.querySelector(this.container)),this.headerElement=this.options.headerElement,"string"==typeof this.headerElement&&(this.headerElement=document.querySelector(this.headerElement)),"none"===this.options.header||this.headerElement||(this.headerElement=this.container.querySelector(s.Yb)),this.annotatedElement=this.getAnnotatedEl(this.container),this.isMobile&&this.setupMobileDialog(),this.setScale(t),this.setupAnnotations(),this.loadAnnotations()}},{key:"isModeAnnotatable",value:function(e){if(!this.options.annotator)return!1;var t=this.options.annotator.TYPE;return!(e&&t&&!t.some(function(t){return e===t}))}},{key:"loadAnnotations",value:function(){var e=this;this.fetchPromise.then(function(){e.generateThreadMap(e.threadMap),e.render(),e.annotatedElement.classList.add(s.i)}).catch(function(t){e.emit(s.a.loadError,t)})}},{key:"setScale",value:function(t){this.annotatedElement.setAttribute("data-scale",t)}},{key:"getLocationFromEvent",value:function(t,e){}},{key:"createAnnotationThread",value:function(t,e,n){}},{key:"getAnnotatedEl",value:function(t){}},{key:"setupAnnotations",value:function(){this.bindDOMListeners(),this.bindCustomListenersOnService(this.annotationService),this.addListener(s.a.scale,this.scaleAnnotations),this.setupControllers()}},{key:"setupControllers",value:function(){var n=this;this.modeButtons=this.options.modeButtons||{};var i={header:this.options.header,isMobile:this.isMobile,hasTouch:this.hasTouch};Object.keys(this.modeControllers).forEach(function(t){var e=n.modeControllers[t];e.init({container:n.container,headerElement:n.headerElement,annotatedElement:n.annotatedElement,mode:t,modeButton:n.modeButtons[t],permissions:n.permissions,annotator:n,localized:n.localized,options:i}),e.addListener("annotationcontrollerevent",n.handleControllerEvents)});var t=this.modeControllers[s.ic.point];t&&this.isMobile&&t.setupSharedDialog(this.container,{isMobile:this.isMobile,hasTouch:this.hasTouch,localized:this.localized})}},{key:"setupMobileDialog",value:function(){this.mobileDialogEl=a.n(),this.mobileDialogEl.setAttribute("data-type",s.ib),this.mobileDialogEl.classList.add(s.W),this.mobileDialogEl.classList.add(s.o),this.mobileDialogEl.classList.add(s.O),this.mobileDialogEl.id=s.zb,this.container.appendChild(this.mobileDialogEl)}},{key:"removeThreadFromSharedDialog",value:function(){this.mobileDialogEl&&!this.mobileDialogEl.classList.contains(s.O)&&(a.x(this.mobileDialogEl),a.M("."+s.Y),this.mobileDialogEl.removeChild(this.mobileDialogEl.lastChild))}},{key:"hideAnnotations",value:function(t){var e=this;t&&a.D(t)||Object.keys(this.modeControllers).forEach(function(t){e.modeControllers[t].applyActionToThreads(function(t){a.E(t.state)||t.hideDialog()})})}},{key:"fetchAnnotations",value:function(){var e=this;return this.permissions.canViewAllAnnotations||this.permissions.canViewOwnAnnotations?this.annotationService.getThreadMap(this.fileVersionId).then(function(t){e.threadMap=t,e.emit(s.a.fetch)}).catch(function(t){e.emit(s.a.loadError,t)}):Promise.resolve({})}},{key:"generateThreadMap",value:function(i){var o=this;this.options.annotator&&Object.keys(i).forEach(function(t){var e=i[t],n=a.t(e);n&&o.isModeAnnotatable(n.type)&&(t=a.r(e),t=o.createAnnotationThread(e,t.location,n.type),(n=o.modeControllers[n.type])&&n.registerThread(t))})}},{key:"bindDOMListeners",value:function(){}},{key:"unbindDOMListeners",value:function(){}},{key:"bindCustomListenersOnService",value:function(){var t=this.annotationService;t&&t instanceof r.a&&t.addListener(s.a.error,this.handleServicesErrors)}},{key:"unbindCustomListenersOnService",value:function(){var t=this.annotationService;t&&t instanceof r.a&&t.removeListener(s.a.error,this.handleServicesErrors)}},{key:"getThreadParams",value:function(t,e,n){n={annotatedElement:this.annotatedElement,annotations:t,annotationService:this.annotationService,container:this.container,fileVersionId:this.fileVersionId,isMobile:this.isMobile,hasTouch:this.hasTouch,locale:this.locale,location:e,type:n,permissions:this.permissions,localized:this.localized},t=a.r(t);return t&&(n.threadID=t.threadID,n.threadNumber=t.threadNumber),n}},{key:"getCurrentAnnotationMode",value:function(){var e=this;return Object.keys(this.modeControllers).filter(function(t){return e.modeControllers[t].isEnabled()})[0]||null}},{key:"createPointThread",value:function(t){var e=t.commentText,n=t.lastPointEvent,t=t.pendingThreadID;if(!n||!t||!e||""===e.trim())return null;if(!this.getLocationFromEvent(n,s.ic.point))return null;n=this.modeControllers[s.ic.point],t=n.getThreadByID(t);return n&&t?(t.dialog.hasComments=!0,t.state=s.gc.hover,t.showDialog(),t.dialog.postAnnotation(e),this.emit(s.hc.threadSave,t.getThreadEventData()),t):null}},{key:"render",value:function(){var e=this;Object.keys(this.modeControllers).forEach(function(t){e.modeControllers[t].render()})}},{key:"renderPage",value:function(e){var n=this;Object.keys(this.modeControllers).forEach(function(t){return n.modeControllers[t].renderPage(e)})}},{key:"getAnnotationPermissions",value:function(t){t=t.permissions||{};return{canAnnotate:t.can_annotate||!1,canViewAllAnnotations:t.can_view_annotations_all||!1,canViewOwnAnnotations:t.can_view_annotations_self||!1}}},{key:"scaleAnnotations",value:function(t){this.setScale(t.scale),this.render()}},{key:"toggleAnnotationMode",value:function(t){this.hideAnnotations();var e=this.getCurrentAnnotationMode();e&&this.modeControllers[e].exit(),e!==t&&this.modeControllers[t].enter()}},{key:"scrollToAnnotation",value:function(e){var n=this;e&&Object.keys(this.modeControllers).forEach(function(t){t=n.modeControllers[t].getThreadByID(e);t&&t.scrollIntoView()})}},{key:"handleValidationError",value:function(){this.validationErrorEmitted||(this.emit(s.a.error,this.localized.loadError),this.validationErrorEmitted=!0)}},{key:"handleServicesErrors",value:function(t){var e="";switch(t.reason){case"read":e=this.localized.loadError;break;case"create":e=this.localized.createError,this.loadAnnotations();break;case"delete":e=this.localized.deleteError,this.loadAnnotations();break;case"authorization":e=this.localized.authError}t.error,e&&this.emit(s.a.error,e)}},{key:"handleControllerEvents",value:function(t){switch(t.event){case s.fb.resetMobileDialog:this.removeThreadFromSharedDialog();break;case s.fb.toggleMode:this.toggleAnnotationMode(t.mode);break;case s.fb.enter:this.emit(t.event,{mode:t.mode}),this.unbindDOMListeners();break;case s.fb.exit:this.emit(t.event,{mode:t.mode}),this.bindDOMListeners();break;case s.fb.createThread:this.createPointThread(t.data);break;default:this.emit(t.event,t.data)}}},{key:"emit",value:function(t,e){var n=this.options.annotator;o(h.prototype.__proto__||Object.getPrototypeOf(h.prototype),"emit",this).call(this,t,e),o(h.prototype.__proto__||Object.getPrototypeOf(h.prototype),"emit",this).call(this,"annotatorevent",{event:t,data:e,annotatorName:n?n.NAME:"",fileVersionId:this.fileVersionId,fileId:this.fileId})}}]),n=h;function h(t){!function(t){if(!(t instanceof h))throw new TypeError("Cannot call a class as a function")}(this);var e=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(h.__proto__||Object.getPrototypeOf(h)).call(this));e.options=t,e.locale=t.location.locale||"en-US",e.validationErrorEmitted=!1,e.isMobile=t.isMobile||!1,e.hasTouch=t.hasTouch||!1,e.localized=t.localizedStrings;var n=e.options,i=n.apiHost,t=n.file,n=n.token;e.fileVersionId=t.file_version.id,e.fileId=t.id,e.permissions=e.getAnnotationPermissions(e.options.file),e.annotationService=new r.a({apiHost:i,fileId:e.fileId,token:n,canAnnotate:e.permissions.canAnnotate,anonymousUserName:e.localized.anonymousUserName});n=(e.options.annotator||{}).CONTROLLERS;return e.modeControllers=n||{},e.fetchPromise=e.fetchAnnotations(),e.createPointThread=e.createPointThread.bind(e),e.scaleAnnotations=e.scaleAnnotations.bind(e),e.handleControllerEvents=e.handleControllerEvents.bind(e),e.handleServicesErrors=e.handleServicesErrors.bind(e),e.hideAnnotations=e.hideAnnotations.bind(e),e}e.a=n},function(t,e,n){"use strict";e.a=function e(t){!function(t){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this),this.annotationID=t.annotationID,this.fileVersionId=t.fileVersionId,this.threadID=t.threadID,this.threadNumber=t.threadNumber,this.type=t.type,this.text=t.text,this.location=t.location,this.user=t.user,this.permissions=t.permissions,this.created=t.created,this.modified=t.modified}},function(t,e,n){"use strict";var i=n(3),i=n.n(i),o=n(0),r=n(1),n=function(t,e,n){return e&&a(t.prototype,e),n&&a(t,n),t};function a(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)})(s,i.a),n(s,[{key:"focus",value:function(){this.textAreaEl&&(this.textAreaEl.focus(),this.textAreaEl.classList.remove(o.U))}},{key:"blur",value:function(){document.activeElement&&document.activeElement.blur()}},{key:"clear",value:function(){this.textAreaEl&&(this.textAreaEl.value="")}},{key:"hide",value:function(){this.containerEl&&Object(r.x)(this.containerEl)}},{key:"show",value:function(){this.containerEl||(this.containerEl=this.createCommentBox(),this.parentEl.appendChild(this.containerEl)),Object(r.M)(this.containerEl),Object(r.l)(this.textAreaEl)}},{key:"destroy",value:function(){this.containerEl&&(this.containerEl.removeEventListener("touchend",this.preventDefaultAndPropagation),this.containerEl.remove(),this.parentEl=null,this.containerEl=null,this.cancelEl&&(this.cancelEl.removeEventListener("click",this.onCancel),this.cancelEl.removeEventListener("touchend",this.onCancel)),this.postEl&&(this.postEl.removeEventListener("click",this.onPost),this.postEl.removeEventListener("touchend",this.onPost)),this.textAreaEl&&this.textAreaEl.removeEventListener("focus",this.focus))}},{key:"createHTML",value:function(){var t=document.createElement("section");return t.classList.add(o.J),t.innerHTML=('\n            <textarea class="'+o.cb+" "+o.C+" "+o.c+'"\n                placeholder="'+this.placeholderText+'"></textarea>\n            <div class="'+o.F+'">\n                <button class="'+o.E+" "+o.j+'">\n                    '+this.cancelText+'\n                </button>\n                <button class="'+o.E+" "+o.H+" "+o.k+'">\n                    '+this.postText+"\n                </button>\n            </div>").trim(),t}},{key:"preventDefaultAndPropagation",value:function(t){t.preventDefault(),t.stopPropagation()}},{key:"onCancel",value:function(t){this.preventDefaultAndPropagation(t),this.clear(),this.emit(s.CommentEvents.cancel)}},{key:"onPost",value:function(t){this.preventDefaultAndPropagation(t);t=this.textAreaEl.value;""!==t.trim()?(this.emit(s.CommentEvents.post,t),this.clear()):this.textAreaEl.classList.add(o.U)}},{key:"createCommentBox",value:function(){var t=this.createHTML();return this.textAreaEl=t.querySelector(o.Wb),this.cancelEl=t.querySelector(o.Lb),this.postEl=t.querySelector(o.Rb),this.focus=this.focus.bind(this),this.onCancel=this.onCancel.bind(this),this.onPost=this.onPost.bind(this),this.hasTouch&&(t.addEventListener("touchend",this.preventDefaultAndPropagation.bind(this)),this.cancelEl.addEventListener("touchend",this.onCancel),this.postEl.addEventListener("touchend",this.onPost)),this.isMobile||(this.textAreaEl.addEventListener("focus",this.focus),this.cancelEl.addEventListener("click",this.onCancel),this.postEl.addEventListener("click",this.onPost)),t.addEventListener("click",this.preventDefaultAndPropagation.bind(this)),t}}]),n=s;function s(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};!function(t){if(!(t instanceof s))throw new TypeError("Cannot call a class as a function")}(this);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(s.__proto__||Object.getPrototypeOf(s)).call(this));return n.parentEl=t,n.hasTouch=e.hasTouch||!1,n.isMobile=e.isMobile||!1,n.localized=e.localized,n.cancelText=e.localized.cancelButton,n.postText=e.localized.postButton,n.placeholderText=e.localized.addCommentPlaceholder,n.containerEl=n.createCommentBox(),n}n.CommentEvents={cancel:"comment_cancel",post:"comment_post"};var l=n,n=function(t,e,n){return e&&h(t.prototype,e),n&&h(t,n),t};function h(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)})(c,i.a),n(c,[{key:"setParentEl",value:function(t){this.parentEl=t}},{key:"setPosition",value:function(t,e){this.position.x=t,this.position.y=e,this.updatePosition()}},{key:"show",value:function(t){this.isVisible=!0,this.containerEl||this.createElement(),t&&this.setParentEl(t),this.setButtonVisibility(!0),Object(r.M)(this.containerEl),this.emit(o.gb.init)}},{key:"showCommentBox",value:function(){this.commentBox.show(),this.commentBox.focus()}},{key:"hide",value:function(){this.isVisible=!1,this.containerEl&&(Object(r.x)(this.containerEl),this.commentBox&&(this.commentBox.hide(),this.commentBox.clear()))}},{key:"destroy",value:function(){this.containerEl&&(this.hide(),this.isMobile||(this.containerEl.removeEventListener("click",this.stopPropagation),this.containerEl.removeEventListener("mouseup",this.stopPropagation),this.containerEl.removeEventListener("dblclick",this.stopPropagation)),this.hasTouch&&this.containerEl.removeEventListener("touchend",this.stopPropagation),this.containerEl.remove(),this.containerEl=null,this.parentEl=null,this.commentBox&&(this.commentBox.removeListener(l.CommentEvents.post,this.onCommentPost),this.commentBox.removeListener(l.CommentEvents.cancel,this.onCommentCancel),this.commentBox.destroy(),this.commentBox=null))}},{key:"updatePosition",value:function(){this.isMobile||(this.containerEl.style.left=this.position.x-1-this.containerEl.clientWidth/2+"px",this.containerEl.style.top=this.position.y+5+"px")}},{key:"onCommentPost",value:function(t){this.emit(o.gb.post,t),t&&(this.commentBox.clear(),this.commentBox.blur())}},{key:"onCommentCancel",value:function(){this.emit(o.gb.cancel),this.commentBox.hide(),this.setButtonVisibility(!0),this.updatePosition()}},{key:"setButtonVisibility",value:function(t){(t?Object(r.M):Object(r.x))(this.buttonsEl)}},{key:"stopPropagation",value:function(t){t.stopPropagation()}},{key:"setupCommentBox",value:function(t){var e=new l(t,{hasTouch:this.hasTouch,isMobile:this.isMobile,localized:this.localized});return t.appendChild(e.containerEl),e.addListener(l.CommentEvents.post,this.onCommentPost.bind(this)),e.addListener(l.CommentEvents.cancel,this.onCommentCancel.bind(this)),e.hide(),e}},{key:"createElement",value:function(){this.containerEl=document.createElement("div"),this.containerEl.classList.add(o.X),this.containerEl.classList.add(o.o),this.isMobile||(this.containerEl.addEventListener("click",this.stopPropagation),this.containerEl.addEventListener("mouseup",this.stopPropagation),this.containerEl.addEventListener("dblclick",this.stopPropagation)),this.hasTouch&&this.containerEl.addEventListener("touchend",this.stopPropagation),this.commentBox=this.setupCommentBox(this.containerEl),this.containerEl.appendChild(this.commentBox.containerEl)}}]),n=c;function c(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};!function(t){if(!(t instanceof c))throw new TypeError("Cannot call a class as a function")}(this);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(c.__proto__||Object.getPrototypeOf(c)).call(this));return n.position={x:0,y:0},n.parentEl=t,n.isMobile=!!e.isMobile||!1,n.hasTouch=!!e.hasTouch||!1,n.localized=e.localized,n.isVisible=!1,n}e.a=n},function(t,e,n){"use strict";function o(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(n):void 0:null===(t=Object.getPrototypeOf(t))?void 0:o(t,e,n)}var i=n(8),r=n(1),a=n(0),n=function(t,e,n){return e&&s(t.prototype,e),n&&s(t,n),t};function s(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)})(l,i.a),n(l,[{key:"handleThreadEvents",value:function(t,e){var n;switch(e.event){case a.hc.save:(n=Object(r.r)(t.annotations))&&n.type===a.ic.highlight&&2===Object.keys(t.annotations).length&&this.renderPage(t.location.page);break;case a.hc.threadCleanup:this.emit(a.fb.renderPage,t.location.page)}o(l.prototype.__proto__||Object.getPrototypeOf(l.prototype),"handleThreadEvents",this).call(this,t,e)}},{key:"exit",value:function(){this.destroyPendingThreads(),window.getSelection().removeAllRanges(),this.unbindListeners(),this.emit(a.fb.bindDOMListeners)}},{key:"enter",value:function(){this.emit(a.fb.unbindDOMListeners),this.bindListeners()}},{key:"render",value:function(){o(l.prototype.__proto__||Object.getPrototypeOf(l.prototype),"render",this).call(this),this.destroyPendingThreads()}},{key:"renderPage",value:function(t){var e=this.annotatedElement.querySelector('[data-page-number="'+t+'"]'),n=this.mode===a.ic.highlight?a.w:a.x;Object(r.c)(e,n),this.threads&&o(l.prototype.__proto__||Object.getPrototypeOf(l.prototype),"renderPage",this).call(this,t)}}]),n=l;function l(){return function(t){if(!(t instanceof l))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(l.__proto__||Object.getPrototypeOf(l)).apply(this,arguments))}e.a=n},function(t,e){!function(t){"use strict";var e,n,a,i,o,r,s,l,h,c;function u(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function d(t){return t="string"!=typeof t?String(t):t}function f(e){var t={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return n&&(t[Symbol.iterator]=function(){return t}),t}function p(e){this.map={},e instanceof p?e.forEach(function(t,e){this.append(e,t)},this):Array.isArray(e)?e.forEach(function(t){this.append(t[0],t[1])},this):e&&Object.getOwnPropertyNames(e).forEach(function(t){this.append(t,e[t])},this)}function g(t){if(t.bodyUsed)return Promise.reject(new TypeError("Already read"));t.bodyUsed=!0}function m(n){return new Promise(function(t,e){n.onload=function(){t(n.result)},n.onerror=function(){e(n.error)}})}function v(t){var e=new FileReader,n=m(e);return e.readAsArrayBuffer(t),n}function y(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function b(){return this.bodyUsed=!1,this._initBody=function(t){if(this._bodyInit=t)if("string"==typeof t)this._bodyText=t;else if(a&&Blob.prototype.isPrototypeOf(t))this._bodyBlob=t;else if(i&&FormData.prototype.isPrototypeOf(t))this._bodyFormData=t;else if(e&&URLSearchParams.prototype.isPrototypeOf(t))this._bodyText=t.toString();else if(o&&a&&s(t))this._bodyArrayBuffer=y(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer]);else{if(!o||!ArrayBuffer.prototype.isPrototypeOf(t)&&!l(t))throw new Error("unsupported BodyInit type");this._bodyArrayBuffer=y(t)}else this._bodyText="";this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):e&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},a&&(this.blob=function(){var t=g(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?g(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(v)}),this.text=function(){var t,e,n=g(this);if(n)return n;if(this._bodyBlob)return t=this._bodyBlob,n=m(e=new FileReader),e.readAsText(t),n;if(this._bodyArrayBuffer)return Promise.resolve(function(t){for(var e=new Uint8Array(t),n=new Array(e.length),i=0;i<e.length;i++)n[i]=String.fromCharCode(e[i]);return n.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},i&&(this.formData=function(){return this.text().then(w)}),this.json=function(){return this.text().then(JSON.parse)},this}function E(t,e){var n,i=(e=e||{}).body;if(t instanceof E){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new p(t.headers)),this.method=t.method,this.mode=t.mode,i||null==t._bodyInit||(i=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=e.credentials||this.credentials||"omit",!e.headers&&this.headers||(this.headers=new p(e.headers)),this.method=(t=(n=e.method||this.method||"GET").toUpperCase(),-1<h.indexOf(t)?t:n),this.mode=e.mode||this.mode||null,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&i)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(i)}function w(t){var n=new FormData;return t.trim().split("&").forEach(function(t){var e;t&&(t=(e=t.split("=")).shift().replace(/\+/g," "),e=e.join("=").replace(/\+/g," "),n.append(decodeURIComponent(t),decodeURIComponent(e)))}),n}function C(t,e){e=e||{},this.type="default",this.status=void 0===e.status?200:e.status,this.ok=200<=this.status&&this.status<300,this.statusText="statusText"in e?e.statusText:"OK",this.headers=new p(e.headers),this.url=e.url||"",this._initBody(t)}t.fetch||(e="URLSearchParams"in t,n="Symbol"in t&&"iterator"in Symbol,a="FileReader"in t&&"Blob"in t&&function(){try{return new Blob,!0}catch(t){return!1}}(),i="FormData"in t,(o="ArrayBuffer"in t)&&(r=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],s=function(t){return t&&DataView.prototype.isPrototypeOf(t)},l=ArrayBuffer.isView||function(t){return t&&-1<r.indexOf(Object.prototype.toString.call(t))}),p.prototype.append=function(t,e){t=u(t),e=d(e);var n=this.map[t];this.map[t]=n?n+","+e:e},p.prototype.delete=function(t){delete this.map[u(t)]},p.prototype.get=function(t){return t=u(t),this.has(t)?this.map[t]:null},p.prototype.has=function(t){return this.map.hasOwnProperty(u(t))},p.prototype.set=function(t,e){this.map[u(t)]=d(e)},p.prototype.forEach=function(t,e){for(var n in this.map)this.map.hasOwnProperty(n)&&t.call(e,this.map[n],n,this)},p.prototype.keys=function(){var n=[];return this.forEach(function(t,e){n.push(e)}),f(n)},p.prototype.values=function(){var e=[];return this.forEach(function(t){e.push(t)}),f(e)},p.prototype.entries=function(){var n=[];return this.forEach(function(t,e){n.push([e,t])}),f(n)},n&&(p.prototype[Symbol.iterator]=p.prototype.entries),h=["DELETE","GET","HEAD","OPTIONS","POST","PUT"],E.prototype.clone=function(){return new E(this,{body:this._bodyInit})},b.call(E.prototype),b.call(C.prototype),C.prototype.clone=function(){return new C(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new p(this.headers),url:this.url})},C.error=function(){var t=new C(null,{status:0,statusText:""});return t.type="error",t},c=[301,302,303,307,308],C.redirect=function(t,e){if(-1===c.indexOf(e))throw new RangeError("Invalid status code");return new C(null,{status:e,headers:{location:t}})},t.Headers=p,t.Request=E,t.Response=C,t.fetch=function(n,r){return new Promise(function(i,t){var e=new E(n,r),o=new XMLHttpRequest;o.onload=function(){var n,t={status:o.status,statusText:o.statusText,headers:(e=o.getAllResponseHeaders()||"",n=new p,e.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach(function(t){var e=t.split(":"),t=e.shift().trim();t&&(e=e.join(":").trim(),n.append(t,e))}),n)};t.url="responseURL"in o?o.responseURL:t.headers.get("X-Request-URL");var e="response"in o?o.response:o.responseText;i(new C(e,t))},o.onerror=function(){t(new TypeError("Network request failed"))},o.ontimeout=function(){t(new TypeError("Network request failed"))},o.open(e.method,e.url,!0),"include"===e.credentials?o.withCredentials=!0:"omit"===e.credentials&&(o.withCredentials=!1),"responseType"in o&&a&&(o.responseType="blob"),e.headers.forEach(function(t,e){o.setRequestHeader(e,t)}),o.send(void 0===e._bodyInit?null:e._bodyInit)})},t.fetch.polyfill=!0)}("undefined"!=typeof self?self:this)},function(t,e){t.exports='<svg width="22" height="21" viewBox="0 0 22 21" focusable="false">\n  <path d="M11 21l-4-4H1.99C.89 17 0 16.11 0 15V2C0 .895.89 0 1.99 0h18.02C21.11 0 22 .89 22 2v13c0 1.105-.89 2-1.99 2H15l-4 4zm-7-9.5c0-.276.228-.5.51-.5h8.98c.282 0 .51.232.51.5 0 .276-.228.5-.51.5H4.51c-.282 0-.51-.232-.51-.5zm0-3c0-.276.23-.5.5-.5h11c.276 0 .5.232.5.5 0 .276-.23.5-.5.5h-11c-.276 0-.5-.232-.5-.5zm0-3c0-.276.22-.5.498-.5h13.004c.275 0 .498.232.498.5 0 .276-.22.5-.498.5H4.498C4.223 6 4 5.768 4 5.5z" fill="#0061d5" fill-rule="evenodd"/>\n</svg>\n'},function(t,e){t.exports='<svg width="20" height="20" viewBox="0 0 20 20" focusable="false">\n  <g fill="none" fill-rule="evenodd">\n    <path d="M-2-2h24v24H-2"/>\n    <path class="icon" d="M18 0H2C.9 0 .01.9.01 2L0 20l4-4h14c1.1 0 2-.9 2-2V2c0-1.1-.9-2-2-2zM4 7h10v2H4V7zm8 5H4v-2h8v2zm4-6H4V4h12v2z" fill="#000"/>\n  </g>\n</svg>\n'},function(t,e){t.exports='<svg width="24" height="30" viewBox="0 0 24 30" focusable="false">\n  <g transform="translate(1 1)" fill="none" fill-rule="evenodd">\n    <path d="M15 17l-4 4-4-4H1.99C.89 17 0 16.11 0 15V2C0 .895.89 0 1.99 0h18.02C21.11 0 22 .89 22 2v13c0 1.105-.89 2-1.99 2H15z" stroke="#FFF" fill="#0061d5"/>\n    <rect fill="#FFF" x="4" y="5" width="14" height="1" rx=".5"/>\n    <rect fill="#FFF" x="4" y="8" width="12" height="1" rx=".5"/>\n    <rect fill="#FFF" x="4" y="11" width="10" height="1" rx=".5"/>\n    <circle fill-opacity=".3" fill="#0061d5" cx="11" cy="26" r="3"/>\n  </g>\n</svg>\n'},function(t,e){t.exports='<svg fill="#fff" height="24" viewBox="0 0 24 24" width="24" focusable="false">\n    <path d="M7 10l5 5 5-5z"/>\n    <path d="M0 0h24v24H0z" fill="none"/>\n</svg>\n'},function(t,e){t.exports='<svg fill="#fff" height="24" viewBox="0 0 24 24" width="24" focusable="false">\n    <path d="M7 14l5-5 5 5z"/>\n    <path d="M0 0h24v24H0z" fill="none"/>\n</svg>\n'},function(t,e){t.exports='<svg fill="#000" height="24" viewBox="0 0 24 24" width="24" focusable="false">\n    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>\n    <path d="M0 0h24v24H0z" fill="none"/>\n</svg>\n'},function(t,e){t.exports='<svg width="24" height="24" viewBox="0 0 24 24" focusable="false">\n    <g fill-rule="evenodd">\n        <path d="M1 23h11.875v-3H1v3zm9.19-9.854l4.103 4.102.694.694.707-.68 7-6.742.306-.295V.07l-1.673 1.524L10.224 11.7l-.775.705.74.74z"/>\n        <path d="M11.023 12.17L6.33 16.58C5.28 17.62 5.9 19 7.32 19h3.95c.82 0 1.826-.413 2.406-.995l1.544-1.383.768-.69-.713-.745-2.844-2.976-.683-.717-.723.68v-.003zm-.038 1.42l2.844 2.977.053-1.435-1.584 1.42c-.244.243-.74.446-1.03.446l-2.454-.008 3.577-3.36-1.408-.04z"/>\n    </g>\n</svg>\n'},function(t,e){t.exports='<svg viewBox="-11 13 24 24" focusable="false">\n  <path class="icon" fill="#494949" d="M6 21l-1-1-4 4-4-4-1 1 4 4-4 4 1 1 4-4 4 4 1-1-4-4 4-4z"/>\n  <path fill="none" d="M-11 13h24v24h-24V13z"/>\n</svg>\n'},function(t,e){t.exports='<svg width="11" height="11" viewBox="0 0 24 18" focusable="false"><path d="M9 21.035l-9-8.638 2.791-2.87 6.156 5.874 12.21-12.436 2.843 2.817z"/></svg>'},function(t,e){t.exports='<svg width="11" height="9" viewBox="0 0 24 24" focusable="false"><path d="M23.954 21.03l-9.184-9.095 9.092-9.174-2.832-2.807-9.09 9.179-9.176-9.088-2.81 2.81 9.186 9.105-9.095 9.184 2.81 2.81 9.112-9.192 9.18 9.1z"/></svg>'},function(t,e,n){"use strict";function o(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(n):void 0:null===(t=Object.getPrototypeOf(t))?void 0:o(t,e,n)}var i=n(8),r=n(26),a=n.n(r),s=n(1),l=n(0),n=function(t,e,n){return e&&h(t.prototype,e),n&&h(t,n),t};function h(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)})(c,i.a),n(c,[{key:"init",value:function(t){o(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"init",this).call(this,t),"none"===t.options.header&&!this.headerElement||this.setupHeader(this.headerElement,a.a),this.handleSelection=this.handleSelection.bind(this)}},{key:"setupHeader",value:function(t,e){o(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"setupHeader",this).call(this,t,e),this.cancelButtonEl=this.getButton(l.Mb),this.cancelButtonEl.textContent=this.localized.cancelButton,this.postButtonEl=this.getButton(l.Nb),this.postButtonEl.textContent=this.localized.doneButton||"Done",this.undoButtonEl=this.getButton(l.Pb),this.redoButtonEl=this.getButton(l.Ob)}},{key:"bindDOMListeners",value:function(){this.hasTouch&&this.annotatedElement.addEventListener("touchstart",this.handleSelection),this.isMobile||this.annotatedElement.addEventListener("click",this.handleSelection)}},{key:"unbindDOMListeners",value:function(){this.hasTouch&&this.annotatedElement.removeEventListener("touchstart",this.handleSelection),this.isMobile||this.annotatedElement.removeEventListener("click",this.handleSelection)}},{key:"bindListeners",value:function(){o(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"bindListeners",this).call(this),this.unbindDOMListeners()}},{key:"unbindListeners",value:function(){o(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"unbindListeners",this).call(this),this.bindDOMListeners(),Object(s.g)(this.undoButtonEl),Object(s.g)(this.redoButtonEl)}},{key:"stopPropagation",value:function(t){Object(s.k)(t.target,l.A)&&t.stopPropagation()}},{key:"cancelDrawing",value:function(){this.currentThread&&this.currentThread.cancelUnsavedAnnotation(),this.currentThread=void 0,this.toggleMode()}},{key:"postDrawing",value:function(){this.currentThread&&this.currentThread.state===l.gc.pending&&this.saveThread(this.currentThread),this.currentThread=void 0,this.toggleMode()}},{key:"undoDrawing",value:function(){this.currentThread&&this.currentThread.undo()}},{key:"redoDrawing",value:function(){this.currentThread&&this.currentThread.redo()}},{key:"setupHandlers",value:function(){var e=this;this.locationFunction=function(t){return e.annotator.getLocationFromEvent(t,l.ic.point)},this.stopPropagation=this.stopPropagation.bind(this),this.drawingStartHandler=this.drawingStartHandler.bind(this),this.cancelDrawing=this.cancelDrawing.bind(this),this.postDrawing=this.postDrawing.bind(this),this.undoDrawing=this.undoDrawing.bind(this),this.redoDrawing=this.redoDrawing.bind(this),this.pushElementHandler(this.annotatedElement,"click",this.stopPropagation,!0),this.pushElementHandler(this.cancelButtonEl,"click",this.cancelDrawing),this.pushElementHandler(this.postButtonEl,"click",this.postDrawing),this.pushElementHandler(this.undoButtonEl,"click",this.undoDrawing),this.pushElementHandler(this.redoButtonEl,"click",this.redoDrawing),this.pushElementHandler(this.annotatedElement,["mousedown","touchstart"],this.drawingStartHandler,!0)}},{key:"drawingStartHandler",value:function(t){var e=this;t.stopPropagation(),t.preventDefault();var n,t=this.annotator.getLocationFromEvent(t,l.ic.point);t&&(this.currentThread?this.currentThread.handleStart(t):(t.minX=t.x,t.maxX=t.x,t.minY=t.y,t.maxY=t.y,(n=this.annotator.createAnnotationThread([],t,l.ic.draw))&&(this.currentThread=n,this.emit(l.hc.pending,n.getThreadEventData()),n.bindDrawingListeners(this.locationFunction),n.addListener("threadevent",function(t){return e.handleThreadEvents(n,t)}),n.handleStart(t))))}},{key:"exit",value:function(){this.annotatedElement.classList.remove(l.s),o(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"exit",this).call(this)}},{key:"enter",value:function(){o(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"enter",this).call(this),Object(s.H)(this.headerElement,l.cc),this.annotatedElement.classList.add(l.s)}},{key:"handleThreadEvents",value:function(t){var e,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=n.eventData;switch(n.event){case"softcommit":t.removeListener("threadevent",this.handleThreadEvents),t.unbindDrawingListeners(),this.currentThread=void 0,this.saveThread(t),this.unbindListeners(),this.bindListeners(),i&&i.location&&this.currentThread.handleStart(i.location);break;case"dialogdelete":if(!t||!t.dialog)return;this.currentThread=void 0,t.removeListener("threadevent",this.handleThreadEvents),t.unbindDrawingListeners(),t.state===l.gc.pending?(t.destroy(),this.unbindListeners(),this.bindListeners()):(t.deleteThread(),this.unregisterThread(t),e=t.location.page,this.threads[e].all().forEach(function(t){return t.show()}));break;case"availableactions":this.updateUndoRedoButtonEls(i.undo,i.redo)}o(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"handleThreadEvents",this).call(this,t,n)}},{key:"handleSelection",value:function(t){var e=this.currentThread&&this.currentThread.state===l.gc.pending;!t||t.target&&"BUTTON"===t.target.nodeName||e||(t.stopPropagation(),t=this.getIntersectingThreads(t),this.removeSelection(),0!==t.length?(t=t[Math.floor(Math.random()*t.length)],this.select(t)):this.selectedThread=void 0)}},{key:"renderPage",value:function(t){var e=this.annotatedElement.querySelector('[data-page-number="'+t+'"]');Object(s.c)(e,l.u),this.threads&&this.threads[t]&&(this.threads[t].all()||[]).forEach(function(t){return t.show()})}},{key:"removeSelection",value:function(){this.selectedThread&&(this.selectedThread.clearBoundary(),this.selectedThread=void 0)}},{key:"select",value:function(t){t.drawBoundary(),this.selectedThread=t}},{key:"updateUndoRedoButtonEls",value:function(t,e){this.undoButtonEl&&(1===t?Object(s.h)(this.undoButtonEl):0===t&&Object(s.g)(this.undoButtonEl)),this.redoButtonEl&&(1===e?Object(s.h)(this.redoButtonEl):0===e&&Object(s.g)(this.redoButtonEl))}},{key:"saveThread",value:function(t){t&&Object(s.w)(t)&&(t.saveAnnotation(l.ic.draw),this.registerThread(t))}}]),n=c;function c(){return function(t){if(!(t instanceof c))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(c.__proto__||Object.getPrototypeOf(c)).apply(this,arguments))}e.a=n},function(t,e,n){"use strict";t.exports=i,t.exports.default=i;var s=n(39);function i(t,e){if(!(this instanceof i))return new i(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&this._initFormat(e),this.clear()}function f(t,e){p(t,0,t.children.length,e,t)}function p(t,e,n,i,o){(o=o||m(null)).minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(var r,a=e;a<n;a++)r=t.children[a],c(o,t.leaf?i(r):r);return o}function c(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function r(t,e){return t.minX-e.minX}function a(t,e){return t.minY-e.minY}function g(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function u(t){return t.maxX-t.minX+(t.maxY-t.minY)}function d(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function h(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function m(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function v(t,e,n,i,o){for(var r,a=[e,n];a.length;)(n=a.pop())-(e=a.pop())<=i||(r=e+Math.ceil((n-e)/i/2)*i,s(t,r,e,n,o),a.push(e,r,r,n))}i.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,n=[],i=this.toBBox;if(!h(t,e))return n;for(var o,r,a,s,l=[];e;){for(o=0,r=e.children.length;o<r;o++)a=e.children[o],h(t,s=e.leaf?i(a):a)&&(e.leaf?n.push(a):d(t,s)?this._all(a,n):l.push(a));e=l.pop()}return n},collides:function(t){var e=this.data,n=this.toBBox;if(!h(t,e))return!1;for(var i,o,r,a,s=[];e;){for(i=0,o=e.children.length;i<o;i++)if(r=e.children[i],h(t,a=e.leaf?n(r):r)){if(e.leaf||d(t,a))return!0;s.push(r)}e=s.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,n=t.length;e<n;e++)this.insert(t[e]);return this}var i,o=this._build(t.slice(),0,t.length-1,0);return this.data.children.length?this.data.height===o.height?this._splitRoot(this.data,o):(this.data.height<o.height&&(i=this.data,this.data=o,o=i),this._insert(o,this.data.height-o.height-1,!0)):this.data=o,this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=m([]),this},remove:function(t,e){if(!t)return this;for(var n,i,o,r,a=this.data,s=this.toBBox(t),l=[],h=[];a||l.length;){if(a||(a=l.pop(),i=l[l.length-1],n=h.pop(),r=!0),a.leaf&&-1!==(o=function(t,e,n){if(!n)return e.indexOf(t);for(var i=0;i<e.length;i++)if(n(t,e[i]))return i;return-1}(t,a.children,e)))return a.children.splice(o,1),l.push(a),this._condense(l),this;r||a.leaf||!d(a,s)?i?(n++,a=i.children[n],r=!1):a=null:(l.push(a),h.push(n),a=(i=a).children[n=0])}return this},toBBox:function(t){return t},compareMinX:r,compareMinY:a,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var n=[];t;)t.leaf?e.push.apply(e,t.children):n.push.apply(n,t.children),t=n.pop();return e},_build:function(t,e,n,i){var o,r=n-e+1,a=this._maxEntries;if(r<=a)return f(o=m(t.slice(e,n+1)),this.toBBox),o;i||(i=Math.ceil(Math.log(r)/Math.log(a)),a=Math.ceil(r/Math.pow(a,i-1))),(o=m([])).leaf=!1,o.height=i;var s,l,h,c,u=Math.ceil(r/a),d=u*Math.ceil(Math.sqrt(a));for(v(t,e,n,d,this.compareMinX),s=e;s<=n;s+=d)for(v(t,s,h=Math.min(s+d-1,n),u,this.compareMinY),l=s;l<=h;l+=u)c=Math.min(l+u-1,h),o.children.push(this._build(t,l,c,i-1));return f(o,this.toBBox),o},_chooseSubtree:function(t,e,n,i){for(var o,r,a,s,l,h,c,u,d;i.push(e),!e.leaf&&i.length-1!==n;){for(h=c=1/0,o=0,r=e.children.length;o<r;o++)l=g(a=e.children[o]),u=t,d=a,(u=(Math.max(d.maxX,u.maxX)-Math.min(d.minX,u.minX))*(Math.max(d.maxY,u.maxY)-Math.min(d.minY,u.minY))-l)<c?(c=u,h=l<h?l:h,s=a):u===c&&l<h&&(h=l,s=a);e=s||e.children[0]}return e},_insert:function(t,e,n){var i=this.toBBox,n=n?t:i(t),o=[],i=this._chooseSubtree(n,this.data,e,o);for(i.children.push(t),c(i,n);0<=e&&o[e].children.length>this._maxEntries;)this._split(o,e),e--;this._adjustParentBBoxes(n,o,e)},_split:function(t,e){var n=t[e],i=n.children.length,o=this._minEntries;this._chooseSplitAxis(n,o,i);i=this._chooseSplitIndex(n,o,i),i=m(n.children.splice(i,n.children.length-i));i.height=n.height,i.leaf=n.leaf,f(n,this.toBBox),f(i,this.toBBox),e?t[e-1].children.push(i):this._splitRoot(n,i)},_splitRoot:function(t,e){this.data=m([t,e]),this.data.height=t.height+1,this.data.leaf=!1,f(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,n){for(var i,o,r,a,s,l,h,c,u,d=r=1/0,f=e;f<=n-e;f++)s=i=p(t,0,f,this.toBBox),u=o=p(t,f,n,this.toBBox),l=Math.max(s.minX,u.minX),h=Math.max(s.minY,u.minY),c=Math.min(s.maxX,u.maxX),u=Math.min(s.maxY,u.maxY),h=Math.max(0,c-l)*Math.max(0,u-h),o=g(i)+g(o),h<d?(d=h,a=f,r=o<r?o:r):h===d&&o<r&&(r=o,a=f);return a},_chooseSplitAxis:function(t,e,n){var i=t.leaf?this.compareMinX:r,o=t.leaf?this.compareMinY:a;this._allDistMargin(t,e,n,i)<this._allDistMargin(t,e,n,o)&&t.children.sort(i)},_allDistMargin:function(t,e,n,i){t.children.sort(i);for(var o,r=this.toBBox,a=p(t,0,e,r),s=p(t,n-e,n,r),l=u(a)+u(s),h=e;h<n-e;h++)o=t.children[h],c(a,t.leaf?r(o):o),l+=u(a);for(h=n-e-1;e<=h;h--)o=t.children[h],c(s,t.leaf?r(o):o),l+=u(s);return l},_adjustParentBBoxes:function(t,e,n){for(var i=n;0<=i;i--)c(e[i],t)},_condense:function(t){for(var e,n=t.length-1;0<=n;n--)0===t[n].children.length?0<n?(e=t[n-1].children).splice(e.indexOf(t[n]),1):this.clear():f(t[n],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}}},function(t,e){t.exports='<div class="bp-header ba-mode-header ba-draw-mode-header bp-is-hidden">\n    <div class="ba-mode-header-btn-container ba-draw-undo-redo-container">\n        <button class="bp-btn-plain ba-btn-annotate-draw-undo is-disabled">\n            <svg width="22" height="21" viewBox="0 0 16 19" focusable="false" style="z-index: 1">\n                <path d="M2,10a6.22,6.22,0,0,0,6,6A6,6,0,0,0,8,4V6L3,3,8,0V2A8,8,0,0,1,8,18a8.16,8.16,0,0,1-5.49-2A7.83,7.83,0,0,1,0,10Z" fill-rule="evenodd"/>\n            </svg>\n        </button>\n        <button class="bp-btn-plain ba-btn-annotate-draw-redo is-disabled">\n            <svg width="22" height="21" viewBox="0 0 16 19" focusable="false">\n                <path d="M14,10a6.22,6.22,0,0,1-6,6A6,6,0,0,1,8,4V6l5-3L8,0V2A8,8,0,1,0,8,18a8.16,8.16,0,0,0,5.49-2A7.83,7.83,0,0,0,16,10Z" fill-rule="evenodd"/>\n            </svg>\n        </button>\n    </div>\n    <div class="ba-mode-header-btn-container ba-draw-post-cancel-container">\n        <button class="bp-btn ba-btn-annotate-draw-cancel"></button>\n        <button class="bp-btn ba-btn-annotate-draw-post"></button>\n    </div>\n</div>\n'},function(t,e,n){"use strict";function o(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(n):void 0:null===(t=Object.getPrototypeOf(t))?void 0:o(t,e,n)}var i=n(8),r=n(28),a=n.n(r),s=n(0),l=n(11),h=n(1),n=function(t,e,n){return e&&c(t.prototype,e),n&&c(t,n),t};function c(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)})(u,i.a),n(u,[{key:"init",value:function(t){o(u.prototype.__proto__||Object.getPrototypeOf(u.prototype),"init",this).call(this,t),"none"===t.options.header&&!this.headerElement||this.setupHeader(this.headerElement,a.a)}},{key:"setupHeader",value:function(t,e){o(u.prototype.__proto__||Object.getPrototypeOf(u.prototype),"setupHeader",this).call(this,t,e),this.exitButtonEl=this.getButton(s.Qb),this.exitButtonEl.textContent=this.localized.closeButton||"Close"}},{key:"setupSharedDialog",value:function(t,e){var n=this;this.createDialog=new l.a(t,{isMobile:e.isMobile,hasTouch:e.hasTouch,localized:e.localized}),this.createDialog.createElement(),this.onDialogCancel=this.onDialogCancel.bind(this),this.onDialogPost=this.onDialogPost.bind(this),this.destroyPendingThreads=this.destroyPendingThreads.bind(this),this.createDialog.addListener(s.gb.init,function(){return n.emit(s.hc.pending,s.ic.point)}),this.createDialog.addListener(s.gb.cancel,this.onDialogCancel),this.createDialog.addListener(s.gb.post,this.onDialogPost)}},{key:"onDialogCancel",value:function(){var t=this.getThreadByID(this.pendingThreadID);this.unregisterThread(t),t.destroy(),this.hideSharedDialog()}},{key:"onDialogPost",value:function(t){this.emit(s.fb.createThread,{commentText:t,lastPointEvent:this.lastPointEvent,pendingThreadID:this.pendingThreadID}),this.hideSharedDialog()}},{key:"hideSharedDialog",value:function(){this.lastPointEvent=null,this.pendingThreadID=null,this.createDialog&&this.createDialog.isVisible&&this.createDialog.hide()}},{key:"setupHandlers",value:function(){this.pointClickHandler=this.pointClickHandler.bind(this),this.pushElementHandler(this.annotatedElement,["click","touchstart"],this.pointClickHandler,!0),this.pushElementHandler(this.exitButtonEl,"click",this.toggleMode)}},{key:"exit",value:function(){this.createDialog&&this.createDialog.hide(),this.buttonEl&&this.buttonEl.classList.remove(s.c),this.annotatedElement.classList.remove(s.B),o(u.prototype.__proto__||Object.getPrototypeOf(u.prototype),"exit",this).call(this)}},{key:"enter",value:function(){o(u.prototype.__proto__||Object.getPrototypeOf(u.prototype),"enter",this).call(this),Object(h.H)(this.headerElement,s.fc),this.annotatedElement.classList.add(s.B),this.buttonEl&&this.buttonEl.classList.add(s.c)}},{key:"pointClickHandler",value:function(t){var e,n;Object(h.C)(t)||(t.stopPropagation(),t.preventDefault()),Object(h.D)(t)||(this.isMobile&&this.emit(s.fb.resetMobileDialog),this.hadPendingThreads=this.destroyPendingThreads(),(e=this.annotator.getLocationFromEvent(t,s.ic.point))&&(n=this.annotator.createAnnotationThread([],e,s.ic.point))?(this.isMobile&&(this.lastPointEvent=t,this.container.appendChild(this.createDialog.containerEl),this.createDialog.show(this.container),this.createDialog.showCommentBox()),this.pendingThreadID=n.threadID,n.show(),this.registerThread(n),this.emit(s.hc.pending,n.getThreadEventData())):this.hideSharedDialog())}}]),n=u;function u(){return function(t){if(!(t instanceof u))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(u.__proto__||Object.getPrototypeOf(u)).apply(this,arguments))}e.a=n},function(t,e){t.exports='<div class="bp-header ba-mode-header ba-point-mode-header bp-is-hidden">\n    <div class="ba-mode-header-btn-container ba-point-post-cancel-container">\n        <button class="bp-btn ba-btn-annotate-point-exit"></button>\n    </div>\n</div>\n'},function(t,e,n){"use strict";var i=n(7),o=n.n(i),r=(n(34),n(35),n(36),n(9)),a=n(4),s=n(5),y=n(1),b=n(0),p=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},l=4/3;function g(){var t=window.getSelection();return!(!t||t.isCollapsed||t.rangeCount<1)}function E(t,e,n){var i=t.map(function(t){return t*l*n});if(2===i.length){t=p(i,2);return[t[0],e-t[1]]}i=p(i,8);return[i[0],e-i[1],i[2],e-i[3],i[4],e-i[5],i[6],e-i[7]]}function m(t,e,n){var i;return(2===t.length?[(i=p(t,2))[0],e-i[1]]:[(t=p(t,8))[0],e-t[1],t[2],e-t[3],t[4],e-t[5],t[6],e-t[7]]).map(function(t){return(.75*t/n).toFixed(4)})}function h(t,e){var n=(e.querySelector('[data-page-number="'+t.page+'"]')||e).getBoundingClientRect(),i=n.height-b.Bb-b.Ab,o=y.v(e),r=t.x,e=t.y,n=y.q(t.dimensions,n,o,30);return n&&(r*=n.x,e*=n.y),E([r,e],i,o)}function c(t){var e=p(t[t.length-1],8),n=e[0],i=e[1],o=e[2],r=e[3],a=e[4],s=e[5],t=e[6],e=e[7];return[Math.max(n,o,a,t),Math.min(i,r,s,e)]}function u(t){return!(t.rangeCount<=0||t.isCollapsed||""===t.toString())}function d(t,e){var n=t.getBoundingClientRect(),i=window.devicePixelRatio||1,o=n.width,t=n.height-b.Bb-b.Ab,n=e;return n.width=i*o,n.height=i*t,1!==i&&(n.style.width=o+"px",n.style.height=t+"px",e.getContext("2d").scale(i,i)),n}function v(t,e){if(!t)return null;if(n=t.querySelector("canvas."+e))return n.getContext("2d");(n=document.createElement("canvas")).classList.add(e);var n=d(t,n),i=t.querySelector(".textLayer"),e=t.querySelector(".canvasWrapper");return i?t.insertBefore(n,i):e&&e.appendChild(n),n.getContext("2d")}function f(t,e){return t.querySelector('[data-page-number="'+e+'"]')}b.ib,b.jb,b.pb,b.hb,b.rb,b.kb,b.tb,b.mb,b.sb,b.ob,b.lb,b.nb;function w(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(n):void 0:null===(t=Object.getPrototypeOf(t))?void 0:w(t,e,n)}var C=n(2),O=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},i=function(t,e,n){return e&&x(t.prototype,e),n&&x(t,n),t};function x(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function T(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(n):void 0:null===(t=Object.getPrototypeOf(t))?void 0:T(t,e,n)}var _=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(A,s.a),i(A,[{key:"addAnnotation",value:function(t){var e;""===t.text&&"0"!==t.user.id&&((e=this.highlightDialogEl.querySelector("."+b.R)).textContent=y.I(this.localized.whoHighlighted,[t.user.name]),y.M(e),this.isMobile||this.position()),w(A.prototype.__proto__||Object.getPrototypeOf(A.prototype),"addAnnotation",this).call(this,t)}},{key:"removeAnnotation",value:function(t){t=this.commentsDialogEl.querySelector('[data-annotation-id="'+t+'"]');t&&(t.parentNode.removeChild(t),this.deactivateReply())}},{key:"postAnnotation",value:function(t){var e=this.element.querySelector(b.Wb);""!==(t||e.value).trim()&&(this.element.querySelector(b.ec)&&(y.M(b.Y),this.element.classList.remove(b.z)),w(A.prototype.__proto__||Object.getPrototypeOf(A.prototype),"postAnnotation",this).call(this,t))}},{key:"hideCommentsDialog",value:function(){this.commentsDialogEl&&this.highlightDialogEl&&(this.commentsDialogEl.classList.contains(b.O)||(y.x(this.commentsDialogEl),this.element.classList.add(b.Q),y.M(this.highlightDialogEl),this.hasComments=!1))}},{key:"drawAnnotation",value:function(){this.emit("annotationdraw"),this.toggleHighlight()}},{key:"position",value:function(){var t=this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]'),e=t.getBoundingClientRect(),n=e.height-15-15,i=this.getScaledPDFCoordinates(e,n),o=O(i,2),r=o[0],i=o[1];t.appendChild(this.element);o=y.p(this.element),t=r-o/2,i=this.hasComments?i-10:i;i-=10,this.hasComments&&(this.element.style.borderTopWidth="30px"),t=y.J(this.element,t,o,r,e.width),i<0?i=0:n<i+38&&(i=n-38),this.element.style.left=t+"px",this.element.style.top=i+15+"px",this.fitDialogHeightInPage(),y.M(this.element)}},{key:"toggleHighlightDialogs",value:function(){this.commentsDialogEl&&this.highlightDialogEl&&(this.commentsDialogEl.classList.contains(b.O)?(this.element.classList.remove(b.Q),y.x(this.highlightDialogEl),this.element.classList.add(b.o),y.M(this.commentsDialogEl),this.hasComments=!0,this.dialogEl.querySelector(b.Wb).classList.add(b.c)):(this.element.classList.remove(b.o),y.x(this.commentsDialogEl),this.element.classList.add(b.Q),y.M(this.highlightDialogEl),this.hasComments=!1),this.isMobile||this.position())}},{key:"toggleHighlightCommentsReply",value:function(t){var e=this.commentsDialogEl.querySelector(b.Gb),n=this.commentsDialogEl.querySelector(b.Hb);t?(y.x(e),y.M(n),this.deactivateReply()):(y.x(n),y.M(e),this.activateReply()),this.isMobile||this.position()}},{key:"setup",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],e=1<arguments.length&&void 0!==arguments[1]&&arguments[1];this.element||(this.element=document.createElement("div"));var n=y.r(t);n&&(this.hasComments=""!==n.text||1<Object.keys(t).length);var i=n?n.permissions.can_delete:this.canAnnotate;this.highlightDialogEl=this.generateHighlightDialogEl(i,e),this.highlightDialogEl.classList.add(b.t),this.commentsDialogEl=this.generateDialogEl(Object.keys(t).length),this.commentsDialogEl.classList.add(b.n),this.dialogEl=document.createElement("div"),this.dialogEl.appendChild(this.highlightDialogEl),this.dialogEl.appendChild(this.commentsDialogEl),(this.hasComments?this.highlightDialogEl:this.commentsDialogEl).classList.add(b.O),this.isMobile||(this.element.setAttribute("data-type",b.ib),this.element.classList.add(b.o),this.element.classList.add(b.O),this.element.innerHTML='<div class="'+b.l+'"></div>',this.element.appendChild(this.dialogEl),n&&(this.element.dataset.threadNumber=n.threadNumber)),n&&this.dialogEl.classList.add(b.db),y.F(t)&&n&&"0"!==n.user.id&&((e=this.highlightDialogEl.querySelector("."+b.R)).textContent=y.I(this.localized.whoHighlighted,[n.user.name]),y.M(e)),this.addSortedAnnotations(t),!this.isMobile&&this.canAnnotate&&this.bindDOMListeners()}},{key:"bindDOMListeners",value:function(){this.element.addEventListener("mousedown",this.mousedownHandler),this.element.addEventListener("keydown",this.keydownHandler),this.element.addEventListener("mouseup",this.stopPropagation),this.element.addEventListener("wheel",this.stopPropagation)}},{key:"unbindDOMListeners",value:function(){this.element.removeEventListener("mousedown",this.mousedownHandler),this.element.removeEventListener("keydown",this.keydownHandler),this.element.removeEventListener("mouseup",this.stopPropagation),this.element.removeEventListener("wheel",this.stopPropagation)}},{key:"toggleHighlightIcon",value:function(t){var e=this.dialogEl.querySelector(b.Jb);e&&(t===b.yb.active?e.classList.add(b.c):e.classList.remove(b.c))}},{key:"keydownHandler",value:function(t){t.stopPropagation(),"Enter"===y.f(t)&&this.mousedownHandler(t),w(A.prototype.__proto__||Object.getPrototypeOf(A.prototype),"keydownHandler",this).call(this,t)}},{key:"mousedownHandler",value:function(t){switch(t.stopPropagation(),y.j(t.target)){case b.pb:this.drawAnnotation();break;case b.hb:this.emit("annotationdraw"),this.toggleHighlightCommentsReply(!1),this.toggleHighlightDialogs(),t.preventDefault(),this.focusAnnotationsTextArea();break;default:w(A.prototype.__proto__||Object.getPrototypeOf(A.prototype),"clickHandler",this).call(this,t)}}},{key:"toggleHighlight",value:function(){this.dialogEl.classList.contains(b.db)?(this.hasComments=!0,this.emit("annotationdelete")):(this.hasComments=!1,this.dialogEl.classList.add(b.db),this.emit("annotationcreate"))}},{key:"focusAnnotationsTextArea",value:function(){var t=this.dialogEl.querySelector(b.Wb);y.A(t)&&t.focus()}},{key:"getScaledPDFCoordinates",value:function(t,e){var n=y.v(this.annotatedElement),i=c(this.location.quadPoints),o=O(i,2),i=o[0],o=o[1],t=y.q(this.location.dimensions,t,n,30);return t&&(i*=t.x,o*=t.y),E([i,o],e,n)}},{key:"addAnnotationElement",value:function(t){""===t.text?this.highlightDialogEl.dataset.annotationId=t.annotationID:w(A.prototype.__proto__||Object.getPrototypeOf(A.prototype),"addAnnotationElement",this).call(this,t)}},{key:"generateHighlightDialogEl",value:function(t,e){var n=document.createElement("div"),i=document.createElement("span");if(i.classList.add(b.R),i.classList.add(b.O),n.appendChild(i),!this.canAnnotate)return n;i=document.createElement("span");return i.classList.add(b.P),n.appendChild(i),t&&(t=y.m([b.G,b.e],this.localized.highlightToggle,C.e,b.pb),i.appendChild(t)),e&&(e=y.m([b.G,b.f],this.localized.highlightComment,C.f,b.hb),i.appendChild(e)),n}}]),A),S=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},i=function(t,e,n){return e&&k(t.prototype,e),n&&k(t,n),t};function k(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function A(t){!function(t){if(!(t instanceof A))throw new TypeError("Cannot call a class as a function")}(this);t=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(A.__proto__||Object.getPrototypeOf(A)).call(this,t));return t.mousedownHandler=t.mousedownHandler.bind(t),t}var R=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(P,a.a),i(P,[{key:"cancelFirstComment",value:function(){y.F(this.annotations)&&(this.type=b.ic.highlight),this.reset(),this.isMobile?this.hideDialog():y.F(this.annotations)?this.dialog.toggleHighlightDialogs():this.destroy()}},{key:"destroy",value:function(){T(P.prototype.__proto__||Object.getPrototypeOf(P.prototype),"destroy",this).call(this),this.state===b.gc.pending&&window.getSelection().removeAllRanges(),this.emit(b.hc.threadCleanup)}},{key:"hide",value:function(){this.draw(b.yb.erase)}},{key:"reset",value:function(){this.state=b.gc.inactive,this.show()}},{key:"saveAnnotation",value:function(t,e){T(P.prototype.__proto__||Object.getPrototypeOf(P.prototype),"saveAnnotation",this).call(this,t,e),window.getSelection().removeAllRanges()}},{key:"deleteAnnotation",value:function(t){var e=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];T(P.prototype.__proto__||Object.getPrototypeOf(P.prototype),"deleteAnnotation",this).call(this,t,e);e=y.r(this.annotations);e&&(""!==e.text||1<Object.keys(this.annotations).length)&&e.permissions&&!e.permissions.can_delete&&(e=this.dialog.element.querySelector(b.Jb),y.x(e))}},{key:"onMousedown",value:function(){this.state===b.gc.pending&&this.destroy()}},{key:"onClick",value:function(t,e){return!e&&this.isOnHighlight(t)?(this.state=b.gc.hover,this.show(),!0):(this.reset(),!1)}},{key:"isOnHighlight",value:function(t){return y.D(t)||this.isInHighlight(t)}},{key:"show",value:function(){switch(this.state){case b.gc.pending:this.showDialog();break;case b.gc.inactive:this.hideDialog(),this.draw(b.yb.normal);break;case b.gc.hover:case b.gc.pending_active:this.showDialog(),this.draw(b.yb.active)}}},{key:"showDialog",value:function(){this.dialog&&(this.dialog.element||this.dialog.setup(this.annotations,this.showComment),this.dialog.show())}},{key:"createDialog",value:function(){this.dialog=new _({annotatedElement:this.annotatedElement,container:this.container,annotations:this.annotations,locale:this.locale,location:this.location,isMobile:this.isMobile,hasTouch:this.hasTouch,canAnnotate:this.permissions.canAnnotate});var t=y.r(this.annotations);t&&(""!==t.text||1<Object.keys(this.annotations).length)&&this.type===b.ic.highlight&&(this.type=b.ic.highlight_comment)}},{key:"setupElement",value:function(){}},{key:"handleDraw",value:function(){this.state=b.gc.pending_active,window.getSelection().removeAllRanges(),this.show()}},{key:"handleCommentPending",value:function(){this.state=b.gc.pending_active}},{key:"handleCreate",value:function(t){t?(this.type=b.ic.highlight_comment,this.dialog.toggleHighlightCommentsReply(Object.keys(this.annotations).length)):this.type=b.ic.highlight,this.saveAnnotation(this.type,t?t.text:"")}},{key:"handleDelete",value:function(t){t?this.deleteAnnotation(t.annotationID):(t=y.r(this.annotations))&&this.deleteAnnotation(t.annotationID)}},{key:"bindCustomListenersOnDialog",value:function(){this.handleDraw=this.handleDraw.bind(this),this.handleCommentPending=this.handleCommentPending.bind(this),this.handleCreate=this.handleCreate.bind(this),this.handleDelete=this.handleDelete.bind(this),this.cancelFirstComment=this.cancelFirstComment.bind(this),this.dialog.addListener("annotationdraw",this.handleDraw),this.dialog.addListener("annotationcommentpending",this.handleCommentPending),this.dialog.addListener("annotationcreate",this.handleCreate),this.dialog.addListener("annotationcancel",this.cancelFirstComment),this.dialog.addListener("annotationdelete",this.handleDelete)}},{key:"unbindCustomListenersOnDialog",value:function(){this.dialog.removeAllListeners("annotationdraw"),this.dialog.removeAllListeners("annotationcommentpending"),this.dialog.removeAllListeners("annotationcreate"),this.dialog.removeAllListeners("annotationcancel"),this.dialog.removeAllListeners("annotationdelete")}},{key:"scrollIntoView",value:function(){this.scrollToPage();var t=c(this.location.quadPoints),t=S(t,1)[0];this.adjustScroll(this.annotatedElement.scrollTop+t)}},{key:"draw",value:function(l){var h,c,u,d=this,t=this.getPageEl(),f=this.type===b.ic.highlight?v(t,b.w):v(t,b.x);f&&(t=t.getBoundingClientRect(),h=t.height-b.Bb-b.Ab,c=y.v(this.annotatedElement),u=y.q(this.location.dimensions,t,c,b.Bb+b.Ab),this.location.quadPoints.forEach(function(t){var e=t,n=E(e=u?t.map(function(t,e){return e%2?t*u.y:t*u.x}):e,h,c),i=S(n,8),o=i[0],r=i[1],a=i[2],s=i[3],t=i[4],e=i[5],n=i[6],i=i[7];f.fillStyle=l,f.beginPath(),f.moveTo(o,r),f.lineTo(a,s),f.lineTo(t,e),f.lineTo(n,i),f.closePath(),f.save(),f.globalCompositeOperation="destination-out",f.fillStyle=b.yb.erase,f.fill(),f.restore(),l!==b.yb.erase&&(f.fill(),d.dialog&&d.dialog.element&&d.dialog.toggleHighlightIcon(l))}))}},{key:"isInHighlight",value:function(t){for(var e,n=this.getPageEl().getBoundingClientRect(),i=n.height-b.Bb-b.Ab,o=n.top+b.Bb,r=y.v(this.annotatedElement),a=y.q(this.location.dimensions,n,r,b.Bb+b.Ab),s=t.clientX-n.left,l=t.clientY-o,h=!1,c=this.location.quadPoints,u=c.length,d=0;d<u&&!h;){var f=c[d],p=[].concat(function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}(f));if(a)for(var g=f.length,m=0;m<g;m++)p[m]=(e=f[m],m%2?e*a.y:e*a.x);var v=E(p,i,r),v=S(v,8),h=function(t,e,n){for(var i=!1,o=-1,r=t.length,a=r-1;++o<r;a=o)(t[o][1]<=n&&n<t[a][1]||t[a][1]<=n&&n<t[o][1])&&e<(t[a][0]-t[o][0])*(n-t[o][1])/(t[a][1]-t[o][1])+t[o][0]&&(i=!i);return i}([[v[0],v[1]],[v[2],v[3]],[v[4],v[5]],[v[6],v[7]]],s,l);d+=1}return h}},{key:"getPageEl",value:function(){return this.pageEl||(this.pageEl=f(this.annotatedElement,this.location.page)),this.pageEl}},{key:"regenerateBoundary",value:function(){var l=this;this.location&&this.location.quadPoints&&(this.minX=1/0,this.minY=1/0,this.maxX=0,this.maxY=0,this.location.quadPoints.forEach(function(t){var e=S(t,8),n=e[0],i=e[1],o=e[2],r=e[3],a=e[4],s=e[5],t=e[6],e=e[7];l.minX=Math.min(n,o,a,t,l.minX),l.maxX=Math.max(n,o,a,t,l.maxX),l.minY=Math.min(i,r,s,e,l.minY),l.maxY=Math.max(i,r,s,e,l.maxY)}))}}]),P),i=function(t,e,n){return e&&D(t.prototype,e),n&&D(t,n),t};function D(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function P(t,e){!function(t){if(!(t instanceof P))throw new TypeError("Cannot call a class as a function")}(this);t=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(P.__proto__||Object.getPrototypeOf(P)).call(this,t));return t.showComment=e,t}var L=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(B,s.a),i(B,[{key:"position",value:function(){var t=this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]')||this.annotatedElement;t.appendChild(this.element),y.M(this.element);var e=this.element.getBoundingClientRect().width,n=t.getBoundingClientRect(),i=this.threadEl.offsetLeft+12,o=this.threadEl.offsetTop+31,t=y.J(this.element,t=i-e/2,e,i,n.width);this.element.style.left=t-1+"px";n=n.height+15,n=this.flipDialog(o,n+31);this.element.style.top=n.top,this.element.style.bottom=n.bottom}}]),B),N=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},i=function(t,e,n){return e&&M(t.prototype,e),n&&M(t,n),t};function M(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function B(){return function(t){if(!(t instanceof B))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(B.__proto__||Object.getPrototypeOf(B)).apply(this,arguments))}var j=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(I,a.a),i(I,[{key:"showDialog",value:function(){this.permissions.canAnnotate&&g()||function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){e=Object.getPrototypeOf(e);return null===e?void 0:t(e,n,i)}if("value"in o)return o.value;o=o.get;return void 0!==o?o.call(i):void 0}(I.prototype.__proto__||Object.getPrototypeOf(I.prototype),"showDialog",this).call(this)}},{key:"show",value:function(){var t=this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]')||this.annotatedElement,e=h(this.location,this.annotatedElement),n=N(e,2),e=n[0],n=n[1];this.element.style.left=e-12+"px",this.element.style.top=n-31+4+15+"px",t.appendChild(this.element),y.M(this.element),this.state!==b.gc.pending||this.isMobile&&0===Object.keys(this.annotations).length||this.showDialog()}},{key:"createDialog",value:function(){this.dialog=new L({annotatedElement:this.annotatedElement,container:this.container,annotations:this.annotations,locale:this.locale,location:this.location,isMobile:this.isMobile,hasTouch:this.hasTouch,canAnnotate:this.permissions.canAnnotate})}}]),I);function H(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function I(){return function(t){if(!(t instanceof I))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(I.__proto__||Object.getPrototypeOf(I)).apply(this,arguments))}var F=(function(t,e,n){return e&&H(t.prototype,e),n&&H(t,n),t}(z,[{key:"addCoordinate",value:function(t,e){var n;t&&t.x&&t.y&&(n=Object(y.L)(t.x,2),t=Object(y.L)(t.y,2),n<this.minX&&(this.minX=n),t<this.minY&&(this.minY=t),t>this.maxY&&(this.maxY=t),n>this.maxX&&(this.maxX=n),this.path.push(Object(y.e)(n,t)),e&&e.x&&e.y&&this.browserPath.push(e))}},{key:"isEmpty",value:function(){return 0===this.path.length}},{key:"drawPath",value:function(t){var e=t;if(e&&this.browserPath)for(var n=this.browserPath.length,i=0;i<n;i++){var o=void 0,r=void 0;0<i?(o=this.browserPath[i-1].x,r=this.browserPath[i-1].y):(o=this.browserPath[i].x,r=this.browserPath[i].y,e.moveTo(o,r));var a=(this.browserPath[i].x+o)/2,s=(this.browserPath[i].y+r)/2;e.quadraticCurveTo(o,r,a,s)}}},{key:"generateBrowserPath",value:function(t){this.path&&(this.browserPath=this.path.map(t))}}],[{key:"extractDrawingInfo",value:function(t,e){var n=e.paths,i={path:t.path};return n?n.push(i):n=[i],{minX:e.minX?Math.min(e.minX,t.minX):t.minX,maxX:e.maxX?Math.max(e.maxX,t.maxX):t.maxX,minY:e.minY?Math.min(e.minY,t.minY):t.minY,maxY:e.maxY?Math.max(e.maxY,t.maxY):t.maxY,paths:n}}}]),z);function q(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function z(t){var n=this;!function(t){if(!(t instanceof z))throw new TypeError("Cannot call a class as a function")}(this),this.path=[],this.browserPath=[],this.maxX=-1/0,this.maxY=-1/0,this.minX=1/0,this.minY=1/0,t&&(this.path=t.path.map(function(t){var e=+t.x,t=+t.y;return n.minX=Math.min(n.minX,e),n.maxX=Math.max(n.maxX,e),n.minY=Math.min(n.minY,t),n.maxY=Math.max(n.maxY,t),Object(y.e)(e,t)}))}function Y(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(n):void 0:null===(t=Object.getPrototypeOf(t))?void 0:Y(t,e,n)}var X=(function(t,e,n){return e&&q(t.prototype,e),n&&q(t,n),t}(V,[{key:"destroy",value:function(){this.undoStack=[],this.redoStack=[]}},{key:"insert",value:function(t){this.undoStack.push(t),this.redoStack=[]}},{key:"undo",value:function(){if(this.isEmpty())return!1;var t=this.undoStack.pop();return this.redoStack.push(t),!0}},{key:"redo",value:function(){if(0===this.redoStack.length)return!1;var t=this.redoStack.pop();return this.undoStack.push(t),!0}},{key:"isEmpty",value:function(){return 0===this.undoStack.length}},{key:"getNumberOfItems",value:function(){return{undoCount:this.undoStack.length,redoCount:this.redoStack.length}}},{key:"getItems",value:function(){return this.undoStack.slice()}},{key:"getAxisAlignedBoundingBox",value:function(){var e={minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0,paths:[]};return this.getItems().forEach(function(t){e.minX=Math.min(e.minX,t.minX),e.maxX=Math.max(e.maxX,t.maxX),e.minY=Math.min(e.minY,t.minY),e.maxY=Math.max(e.maxY,t.maxY),e.paths.push({path:t.path})}),e}},{key:"applyToItems",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1];this.undoStack.forEach(t),e&&this.redoStack.forEach(t)}}]),V),W=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},i=function(t,e,n){return e&&U(t.prototype,e),n&&U(t,n),t};function U(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function V(){!function(t){if(!(t instanceof V))throw new TypeError("Cannot call a class as a function")}(this),this.undoStack=[],this.redoStack=[]}(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)})(J,a.a),i(J,[{key:"destroy",value:function(){this.lastAnimationRequestId&&window.cancelAnimationFrame(this.lastAnimationRequestId),this.dialog&&(this.dialog.destroy(),this.dialog=null),Y(J.prototype.__proto__||Object.getPrototypeOf(J.prototype),"destroy",this).call(this),this.state!==b.gc.pending&&this.emit(b.hc.threadCleanup),this.reset()}},{key:"reset",value:function(){Y(J.prototype.__proto__||Object.getPrototypeOf(J.prototype),"reset",this).call(this),this.clearBoundary()}},{key:"bindDrawingListeners",value:function(t){this.isMobile||(this.annotatedElement.addEventListener("mousemove",Object(y.i)(t,this.handleMove)),this.annotatedElement.addEventListener("mouseup",Object(y.i)(t,this.handleStop))),this.hasTouch&&(this.annotatedElement.addEventListener("touchmove",Object(y.i)(t,this.handleMove)),this.annotatedElement.addEventListener("touchcancel",Object(y.i)(t,this.handleStop)),this.annotatedElement.addEventListener("touchend",Object(y.i)(t,this.handleStop)))}},{key:"unbindDrawingListeners",value:function(){this.annotatedElement.removeEventListener("mousemove",y.i),this.annotatedElement.removeEventListener("mouseup",y.i),this.annotatedElement.removeEventListener("touchmove",y.i),this.annotatedElement.removeEventListener("touchcancel",y.i),this.annotatedElement.removeEventListener("touchend",y.i)}},{key:"handleMove",value:function(t){}},{key:"handleStart",value:function(t){}},{key:"handleStop",value:function(t){}},{key:"deleteThread",value:function(){var e=this;Object.keys(this.annotations).forEach(function(t){return e.deleteAnnotationWithID({annotationID:t})});var t=this.getBrowserRectangularBoundary(),n=W(t,4),i=n[0],o=n[1],t=n[2],n=n[3];this.concreteContext&&this.concreteContext.clearRect(i-b.b,o+b.b,t+2*b.b,n-2*b.b),this.clearBoundary(),this.pathContainer.destroy(),this.pathContainer=null}},{key:"setContextStyles",value:function(t,e){var n;(this.drawingContext||e)&&(n=t.scale,t=t.color,(e=e||this.drawingContext).lineCap="round",e.lineJoin="round",e.strokeStyle=t||"black",e.lineWidth=b.ub*(n||1))}},{key:"undo",value:function(){this.pathContainer.undo()&&(this.draw(this.drawingContext,!0),this.updateBoundary(),this.regenerateBoundary(),this.dialog&&this.pathContainer.isEmpty()&&this.dialog.hide(),this.drawBoundary(),this.emitAvailableActions())}},{key:"redo",value:function(){this.pathContainer.redo()&&(this.draw(this.drawingContext,!0),this.updateBoundary(),this.regenerateBoundary(),this.dialog&&this.pathContainer.isEmpty()&&this.dialog.hide(),this.drawBoundary(),this.emitAvailableActions())}},{key:"setup",value:function(){Object(y.r)(this.annotations)?(this.state=b.gc.inactive,this.createDialog()):this.state=b.gc.pending}},{key:"draw",value:function(e){var t;e&&(1<arguments.length&&void 0!==arguments[1]&&arguments[1]&&(t=e.canvas,e.clearRect(0,0,t.width,t.height)),e.beginPath(),this.pathContainer.applyToItems(function(t){return t.drawPath(e)}),this.pendingPath&&!this.pendingPath.isEmpty()&&this.pendingPath.drawPath(e),e.stroke())}},{key:"emitAvailableActions",value:function(){var t=this.pathContainer.getNumberOfItems();this.emit("availableactions",{undo:t.undoCount,redo:t.redoCount})}},{key:"drawBoundary",value:function(){var t,e,n,i;this.location.page&&(n=this.getBrowserRectangularBoundary(),t=(i=W(n,4))[0],e=i[1],n=i[2],i=i[3],this.drawingContext.save(),this.drawingContext.beginPath(),this.drawingContext.lineWidth=this.drawingContext.lineWidth/2,this.drawingContext.setLineDash([b.vb,2*b.vb]),this.drawingContext.rect(t,e,n,i),this.drawingContext.stroke(),this.drawingContext.restore(),this.dialog&&(this.dialog.isVisible()||this.pathContainer.isEmpty()||this.showDialog(),this.dialog.position(t+n,e)))}},{key:"render",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:window.performance.now(),e=!0;t-(this.lastRenderTimestamp||0)>=b.wb&&(this.draw(this.drawingContext,!0),this.drawBoundary(),this.lastRenderTimestamp=t,e=this.drawingFlag===b.xb.drawing),e&&(this.lastAnimationRequestId=window.requestAnimationFrame(this.render))}},{key:"updateBoundary",value:function(t){t=t?F.extractDrawingInfo(t,this.location):this.pathContainer.getAxisAlignedBoundingBox();Object.assign(this.location,t)}},{key:"regenerateBoundary",value:function(){var t;this.location&&!this.location.boundaryData&&(t=this.location,this.minX=t.minX,this.maxX=t.maxX,this.minY=t.minY,this.maxY=t.maxY)}},{key:"getBrowserRectangularBoundary",value:function(){}},{key:"clearBoundary",value:function(){var t;this.drawingContext&&(t=this.drawingContext.canvas,this.drawingContext.clearRect(0,0,t.width,t.height)),this.dialog&&this.dialog.isVisible()&&this.dialog.hide()}}]),a=J,i=function(t,e,n){return e&&G(t.prototype,e),n&&G(t,n),t};function G(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function J(t){!function(t){if(!(t instanceof J))throw new TypeError("Cannot call a class as a function")}(this);var e=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(J.__proto__||Object.getPrototypeOf(J)).call(this,t));return e.drawingFlag=b.xb.idle,e.pathContainer=new X,e.state=b.gc.inactive,e.render=e.render.bind(e),e.handleStart=e.handleStart.bind(e),e.handleMove=e.handleMove.bind(e),e.handleStop=e.handleStop.bind(e),e.undo=e.undo.bind(e),e.redo=e.redo.bind(e),e.location&&e.location.paths&&(e.regenerateBoundary(),e.dialog&&e.pathContainer.isEmpty()&&e.dialog.hide(),e.location.paths.forEach(function(t){t=new F(t);e.pathContainer.insert(t)})),e}var $=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(Z,s.a),i(Z,[{key:"destroy",value:function(){this.unbindDOMListeners(),this.removeAllListeners(),this.element&&(this.element.removeEventListener("click",y.G),this.pageEl&&this.pageEl.contains(this.element)&&this.pageEl.removeChild(this.element),this.element=null)}},{key:"isVisible",value:function(){return this.visible}},{key:"addAnnotation",value:function(t){this.element||this.setup([t]),this.assignDrawingLabel(t)}},{key:"removeAnnotation",value:function(){}},{key:"bindDOMListeners",value:function(){this.commitButtonEl&&(this.isMobile||this.commitButtonEl.addEventListener("click",this.postDrawing),this.hasTouch&&this.commitButtonEl.addEventListener("touchend",this.postDrawing)),this.deleteButtonEl&&(this.isMobile||this.deleteButtonEl.addEventListener("click",this.deleteAnnotation),this.hasTouch&&this.deleteButtonEl.addEventListener("touchend",this.deleteAnnotation))}},{key:"unbindDOMListeners",value:function(){this.commitButtonEl&&(this.commitButtonEl.removeEventListener("click",this.postDrawing),this.commitButtonEl.removeEventListener("touchend",this.postDrawing)),this.deleteButtonEl&&(this.deleteButtonEl.removeEventListener("click",this.deleteAnnotation),this.deleteButtonEl.removeEventListener("touchend",this.deleteAnnotation))}},{key:"setup",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];this.element=document.createElement("div"),this.element.addEventListener("click",y.G),this.element.classList.add(b.o),this.drawingDialogEl=this.generateDialogEl(t),this.commitButtonEl=this.drawingDialogEl.querySelector(b.Ib),this.deleteButtonEl=this.drawingDialogEl.querySelector(b.bc),this.bindDOMListeners();t=y.r(t);t&&this.addAnnotation(t),this.element.appendChild(this.drawingDialogEl)}},{key:"position",value:function(t,e){this.pageEl||(this.pageEl=this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]')),this.element||this.setup(),this.pageEl.contains(this.element)||this.pageEl.appendChild(this.element);var n=this.element.getBoundingClientRect();this.element.style.left=t-n.width+"px",this.element.style.top=e+"px"}},{key:"hide",value:function(){y.x(this.element),this.visible=!1}},{key:"show",value:function(){y.M(this.element),this.visible=!0}},{key:"generateDialogEl",value:function(t){var e=y.r(t),n=!e,i=n||e&&e.permissions&&e.permissions.can_delete,t=document.createElement("span");t.classList.add(b.p);e=document.createElement("span");e.classList.add(b.r),e.classList.add(b.O),t.appendChild(e),n&&(n=y.m([b.G,b.d],this.localized.drawSave,C.d+" "+this.localized.saveButton),t.appendChild(n)),i&&(o=y.m([b.G,b.L],this.localized.drawDelete,C.c+" "+this.localized.deleteButton),t.appendChild(o));var o=document.createElement("div");return o.classList.add(b.q),o.appendChild(t),o}},{key:"assignDrawingLabel",value:function(t){var e;t&&this.drawingDialogEl&&"0"!==t.user.id&&((e=this.drawingDialogEl.querySelector("."+b.r)).textContent=y.I(this.localized.whoDrew,[t.user.name]),y.M(e))}},{key:"postDrawing",value:function(t){t.stopPropagation(),t.preventDefault(),this.emit("annotationcreate")}},{key:"deleteAnnotation",value:function(t){t.stopPropagation(),t.preventDefault(),this.emit("annotationdelete")}}]),Z),Q=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},i=function(t,e,n){return e&&K(t.prototype,e),n&&K(t,n),t};function K(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function Z(t){!function(t){if(!(t instanceof Z))throw new TypeError("Cannot call a class as a function")}(this);t=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(Z.__proto__||Object.getPrototypeOf(Z)).call(this,t));return t.visible=!1,t.postDrawing=t.postDrawing.bind(t),t.deleteAnnotation=t.deleteAnnotation.bind(t),t}function tt(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(n):void 0:null===(t=Object.getPrototypeOf(t))?void 0:tt(t,e,n)}var et=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(it,a),i(it,[{key:"handleMove",value:function(t){var e,n;this.drawingFlag===b.xb.drawing&&t&&(this.hasPageChanged(t)?this.onPageChange(t):(e=h(t,this.pageEl),e=(n=Q(e,2))[0],n=n[1],n=Object(y.e)(e,n),this.pendingPath&&this.pendingPath.addCoordinate(t,n)))}},{key:"handleStart",value:function(t){t&&(this.hasPageChanged(t)?this.onPageChange(t):(this.location&&this.location.page||!t.page||(this.location={page:t.page,dimensions:t.dimensions}),this.checkAndHandleScaleUpdate(),this.drawingFlag=b.xb.drawing,this.pendingPath||(this.pendingPath=new F),this.dialog&&this.dialog.isVisible()&&this.dialog.hide(),this.lastAnimationRequestId=window.requestAnimationFrame(this.render),this.state=b.gc.pending))}},{key:"handleStop",value:function(){window.cancelAnimationFrame(this.lastAnimationRequestId),this.lastAnimationRequestId=0,this.drawingFlag=b.xb.idle,this.pendingPath&&!this.pendingPath.isEmpty()&&(this.dialog||this.createDialog(),this.pathContainer.insert(this.pendingPath),this.updateBoundary(this.pendingPath),this.regenerateBoundary(),this.dialog&&this.pathContainer.isEmpty()&&this.dialog.hide(),this.render(),this.emitAvailableActions(),this.pendingPath=null)}},{key:"hasPageChanged",value:function(t){return!!(t&&this.location&&this.location.page&&this.location.page!==t.page)}},{key:"saveAnnotation",value:function(t,e){this.reset(),this.pathContainer.isEmpty()||(this.regenerateBoundary(),this.dialog&&this.pathContainer.isEmpty()&&this.dialog.hide(),function t(e,n,i){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){e=Object.getPrototypeOf(e);return null===e?void 0:t(e,n,i)}if("value"in o)return o.value;o=o.get;return void 0!==o?o.call(i):void 0}(it.prototype.__proto__||Object.getPrototypeOf(it.prototype),"saveAnnotation",this).call(this,t,e),this.createDialog(),this.show())}},{key:"show",value:function(){var t,e=this;this.annotatedElement&&this.location&&(t=this.selectContext(),this.dialog&&this.dialog.isVisible()&&(this.drawBoundary(),this.dialog.show()),this.pathContainer.applyToItems(function(t){return t.generateBrowserPath(e.reconstructBrowserCoordFromLocation)}),this.pendingPath&&!this.pendingPath.isEmpty()&&this.pendingPath.generateBrowserPath(this.reconstructBrowserCoordFromLocation),this.draw(t,!1))}},{key:"bindCustomListenersOnDialog",value:function(){var t=this;this.dialog&&(this.dialog.addListener("annotationcreate",function(){return t.emit("softcommit")}),this.dialog.addListener("annotationdelete",function(){return t.emit("dialogdelete")}))}},{key:"createDialog",value:function(){this.dialog&&this.dialog.destroy(),this.dialog=new $({annotatedElement:this.annotatedElement,container:this.container,annotations:this.annotations,locale:this.locale,location:this.location,canAnnotate:this.annotationService.canAnnotate,isMobile:this.isMobile,hasTouch:this.hasTouch}),this.dialog.localized=this.localized,this.bindCustomListenersOnDialog()}},{key:"checkAndHandleScaleUpdate",value:function(){var t=Object(y.v)(this.annotatedElement);this.lastScaleFactor!==t&&this.location&&this.location.page&&(this.lastScaleFactor=t,this.pageEl=f(this.annotatedElement,this.location.page),this.drawingContext=v(this.pageEl,b.v),this.setContextStyles({scale:t}))}},{key:"onPageChange",value:function(t){this.handleStop(),this.emit("softcommit",{location:t})}},{key:"reconstructBrowserCoordFromLocation",value:function(t){var e=h(Object(y.e)(t.x,t.y,this.location.dimensions),this.pageEl),t=Q(e,2),e=t[0],t=t[1];return Object(y.e)(e,t)}},{key:"selectContext",value:function(){if(this.checkAndHandleScaleUpdate(),this.state===b.gc.pending)return this.drawingContext;var t={scale:this.lastScaleFactor};return this.concreteContext=v(this.pageEl,b.u),this.setContextStyles(t,this.concreteContext),this.concreteContext}},{key:"getBrowserRectangularBoundary",value:function(){if(!this.location||!this.location.dimensions||!this.pageEl)return null;var t=Object(y.e)(this.minX,this.minY,this.location.dimensions),e=Object(y.e)(this.maxX,this.maxY,this.location.dimensions),n=h(t,this.pageEl),t=Q(n,2),n=t[0],t=t[1],e=h(e,this.pageEl),e=Q(e,2);return[n,t,e[0]-n,e[1]-t]}}]),it),i=n(11),n=function(t,e,n){return e&&nt(t.prototype,e),n&&nt(t,n),t};function nt(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function it(t){!function(t){if(!(t instanceof it))throw new TypeError("Cannot call a class as a function")}(this);t=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(it.__proto__||Object.getPrototypeOf(it)).call(this,t));return t.onPageChange=t.onPageChange.bind(t),t.reconstructBrowserCoordFromLocation=t.reconstructBrowserCoordFromLocation.bind(t),t}function ot(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(n):void 0:null===(t=Object.getPrototypeOf(t))?void 0:ot(t,e,n)}var rt=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(lt,i.a),n(lt,[{key:"show",value:function(t,e){var n;!e||(n=Object(y.u)(e.anchorNode)).pageEl&&(n=this.isMobile?t:n.pageEl,tt(lt.prototype.__proto__||Object.getPrototypeOf(lt.prototype),"show",this).call(this,n),this.parentEl.querySelector(".ba-create-annotation-dialog")||this.parentEl.appendChild(this.containerEl),this.isMobile||this.setPosition(e))}},{key:"setPosition",value:function(t){var e,n;t&&t.rangeCount&&(e=function(t){var e,n=t.endContainer,i=t.endOffset,o=document.createElement("span"),t=n.parentNode;"#text"===n.nodeName?(e=n.splitText(i),t.insertBefore(o,e)):(r=n.firstChild,(e=n.previousElementSibling)?e.appendChild(o):r?n.insertBefore(o,r):n.appendChild(o));var r=o.getBoundingClientRect(),n=r.right,r=r.bottom;return o.parentNode&&o.parentNode.removeChild(o),{x:n,y:r}}(t.getRangeAt(t.rangeCount-1)),(n=Object(y.u)(t.anchorNode)).pageEl&&(n=(t=n.pageEl.getBoundingClientRect()).left,t=t.top+b.Bb,tt(lt.prototype.__proto__||Object.getPrototypeOf(lt.prototype),"setPosition",this).call(this,e.x-n,e.y-t)))}},{key:"destroy",value:function(){tt(lt.prototype.__proto__||Object.getPrototypeOf(lt.prototype),"destroy",this).call(this),this.highlightCreateEl&&(this.highlightCreateEl.removeEventListener("click",this.onHighlightClick),this.highlightCreateEl.removeEventListener("touchstart",this.stopPropagation),this.highlightCreateEl.removeEventListener("touchend",this.onHighlightClick)),this.commentCreateEl&&(this.commentCreateEl.removeEventListener("click",this.onCommentClick),this.commentCreateEl.removeEventListener("touchstart",this.stopPropagation),this.commentCreateEl.removeEventListener("touchend",this.onCommentClick))}},{key:"updatePosition",value:function(){var t;this.isMobile||(t=Object(y.p)(this.containerEl),t=this.position.x-1-t/2,t=Object(y.J)(this.containerEl,t,78,this.position.x,this.parentEl.clientWidth),this.containerEl.style.left=t+"px",this.containerEl.style.top=this.position.y+5+"px",Object(y.M)(this.containerEl))}},{key:"onHighlightClick",value:function(t){t.preventDefault(),t.stopPropagation(),this.emit(b.gb.plain)}},{key:"onCommentClick",value:function(t){t.preventDefault(),t.stopPropagation(),this.emit(b.gb.comment),this.commentBox.show(),this.commentBox.focus(),this.setButtonVisibility(!1),this.updatePosition()}},{key:"createElement",value:function(){this.containerEl=document.createElement("div"),this.containerEl.classList.add("ba-create-annotation-dialog"),this.isMobile||((e=document.createElement("div")).classList.add(b.l),e.left="50%",this.containerEl.appendChild(e));var t=document.createElement("span");t.classList.add(b.P),this.allowHighlight&&(n=Object(y.m)([b.G,b.e],this.localized.highlightToggle,C.e,"add-highlight-btn"),t.appendChild(n));var e=document.createElement("div");e.classList.add(b.t),e.appendChild(t),this.containerEl.appendChild(e),this.isMobile&&(this.containerEl.classList.add(b.W),this.containerEl.classList.add(b.o));var n=this.containerEl.querySelector(b.Ub);this.buttonsEl=n.querySelector(b.dc),this.isMobile||(this.containerEl.addEventListener("click",this.stopPropagation),this.containerEl.addEventListener("mouseup",this.stopPropagation),this.containerEl.addEventListener("dblclick",this.stopPropagation)),this.allowHighlight&&(this.highlightCreateEl=n.querySelector(b.Jb),this.highlightCreateEl.addEventListener("click",this.onHighlightClick),this.hasTouch&&(this.highlightCreateEl.addEventListener("touchstart",this.stopPropagation),this.highlightCreateEl.addEventListener("touchend",this.onHighlightClick))),this.allowComment&&(e=Object(y.m)([b.G,b.f],this.localized.highlightComment,C.f,"add-highlight-comment-btn"),t.appendChild(e),this.commentBox=this.setupCommentBox(n),this.commentCreateEl=n.querySelector(b.Kb),this.commentCreateEl.addEventListener("click",this.onCommentClick),this.hasTouch&&(this.commentCreateEl.addEventListener("touchstart",this.stopPropagation),this.commentCreateEl.addEventListener("touchend",this.onCommentClick))),this.hasTouch&&this.containerEl.addEventListener("touchend",this.stopPropagation)}}]),lt),at=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},n=function(t,e,n){return e&&st(t.prototype,e),n&&st(t,n),t};function st(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function lt(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};!function(t){if(!(t instanceof lt))throw new TypeError("Cannot call a class as a function")}(this);t=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(lt.__proto__||Object.getPrototypeOf(lt)).call(this,t,e));return t.position={x:0,y:0},t.allowHighlight=e.allowHighlight||!1,t.allowComment=e.allowComment||!1,t.allowHighlight&&(t.onHighlightClick=t.onHighlightClick.bind(t)),t.allowComment&&(t.onCommentClick=t.onCommentClick.bind(t),t.onCommentPost=t.onCommentPost.bind(t),t.onCommentCancel=t.onCommentCancel.bind(t)),t.createElement(),t}var ht=[b.w,b.x,b.u],n=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(ct,r.a),n(ct,[{key:"destroy",value:function(){ot(ct.prototype.__proto__||Object.getPrototypeOf(ct.prototype),"destroy",this).call(this),this.createHighlightDialog&&(this.commentHighlightEnabled&&(this.createHighlightDialog.removeListener(b.gb.comment,this.highlightCurrentSelection),this.createHighlightDialog.removeListener(b.gb.post,this.createHighlightThread)),this.plainHighlightEnabled&&this.createHighlightDialog.removeListener(b.gb.plain,this.createPlainHighlight),this.createHighlightDialog.destroy(),this.createHighlightDialog=null)}},{key:"init",value:function(t){ot(ct.prototype.__proto__||Object.getPrototypeOf(ct.prototype),"init",this).call(this,t),this.annotatedElement.id="ba-rangy-annotated-element"}},{key:"getAnnotatedEl",value:function(t){return t.querySelector(".bp-doc")}},{key:"getLocationFromEvent",value:function(t,e){var n=null,i=y.v(this.annotatedElement);if(e===b.ic.point){var o=t;if(this.hasTouch&&t.targetTouches){if(t.targetTouches.length<=0)return n;o=t.targetTouches[0]}var r=o.target,a=y.u(r),s=a.pageEl||this.annotatedElement.querySelector('[data-page-number="'+a.page+'"]');if(!s)return n;if(g())return n;var l=y.j(r);if(y.D(t)||l===b.jb)return n;var h=s.getBoundingClientRect(),c=h.width,r=h.height-b.Bb-b.Ab,t=[o.clientX-h.left,o.clientY-h.top-b.Bb];if(l=c,s=r,o=p(t,2),h=o[0],o=o[1],h<0||l<h||o<0||s<o)return n;s=t[0],o=t[1];if(Number.isNaN(s)||Number.isNaN(o))return this.emit(b.a.error,this.localized.createError),n;t=m(t,r,i),t=at(t,2),n={x:s=t[0],y:o=t[1],page:a.page,dimensions:{x:c/i,y:r/i}}}else if(y.B(e)){if(!this.highlighter||!this.highlighter.highlights.length)return n;var r=y.u(window.getSelection().anchorNode),u=r.pageEl,e=r.page;u||(f=y.u(this.annotatedElement.querySelector(".rangy-highlight")),u=f.pageEl,e=f.page);r=(this.highlighter.highlights[0],[].slice.call(u.querySelectorAll(".rangy-highlight"),0).filter(function(t){return t.tagName&&"SPAN"===t.tagName&&""!==t.textContent.trim()}));if(0===r.length)return n;var d=[];r.forEach(function(t){d.push(function(t,e,n){var i=document.createElement("div");i.classList.add(b.T),i.innerHTML=('\n        <div class="'+b.S+' corner1"></div>\n        <div class="'+b.S+' corner2"></div>\n        <div class="'+b.S+' corner3"></div>\n        <div class="'+b.S+' corner4"></div>').trim(),t.appendChild(i);var o=i.querySelector(".corner1"),r=i.querySelector(".corner2"),a=i.querySelector(".corner3"),s=i.querySelector(".corner4"),l=o.getBoundingClientRect(),h=r.getBoundingClientRect(),o=a.getBoundingClientRect(),r=s.getBoundingClientRect(),a=e.getBoundingClientRect(),s=a.height-b.Bb-b.Ab,e=a.left,a=a.top+b.Bb;return t.removeChild(i),m([l.left-e,l.top-a,h.left-e,h.top-a,o.left-e,o.top-a,r.left-e,r.top-a],s,n)}(t,u,i))});var f=u.getBoundingClientRect(),r=f.width,f=f.height-b.Bb-b.Ab;n={page:e,quadPoints:d,dimensions:{x:r/i,y:f/i}}}return n}},{key:"createAnnotationThread",value:function(t,e,n){var i=void 0,e=this.getThreadParams(t,e,n);return y.a(e)?(y.B(n)?i=new R(e,this.commentHighlightEnabled):n===b.ic.draw?i=new et(e):n===b.ic.point&&(i=new j(e)),i||this.emit(b.a.error,this.localized.loadError)):this.handleValidationError(),i}},{key:"renderPage",value:function(t){this.scaleAnnotationCanvases(t),ot(ct.prototype.__proto__||Object.getPrototypeOf(ct.prototype),"renderPage",this).call(this,t),this.createHighlightDialog&&this.createHighlightDialog.isVisible&&this.createHighlightDialog.hide()}},{key:"scaleAnnotationCanvases",value:function(t){var e=this.annotatedElement.querySelector('[data-page-number="'+t+'"]');ht.forEach(function(t){t=e.querySelector("canvas."+t);t&&d(e,t)})}},{key:"setupAnnotations",value:function(){var t=this;this.plainHighlightEnabled=!!this.modeControllers[b.ic.highlight],this.commentHighlightEnabled=!!this.modeControllers[b.ic.highlight_comment],this.drawEnabled=!!this.modeControllers[b.ic.draw],this.drawEnabled&&(this.drawingSelectionHandler=this.drawingSelectionHandler.bind(this)),(this.plainHighlightEnabled||this.commentHighlightEnabled)&&(this.highlightCreateHandler=this.highlightCreateHandler.bind(this),this.highlightMouseupHandler=this.highlightMouseupHandler.bind(this),this.highlightMousedownHandler=this.highlightMousedownHandler.bind(this),this.hideCreateDialog=this.hideCreateDialog.bind(this),this.clickThread=this.clickThread.bind(this),(this.isMobile||this.hasTouch)&&(this.onSelectionChange=this.onSelectionChange.bind(this)),this.createHighlightDialog=new rt(this.container,{isMobile:this.isMobile,hasTouch:this.hasTouch,allowComment:this.commentHighlightEnabled,allowHighlight:this.plainHighlightEnabled,localized:this.localized}),this.createHighlightDialog.addListener(b.gb.init,function(){return t.emit(b.hc.pending,b.ic.highlight)}),this.commentHighlightEnabled&&(this.highlightCurrentSelection=this.highlightCurrentSelection.bind(this),this.createHighlightDialog.addListener(b.gb.comment,this.highlightCurrentSelection),this.createHighlightThread=this.createHighlightThread.bind(this),this.createHighlightDialog.addListener(b.gb.post,this.createHighlightThread)),this.plainHighlightEnabled&&(this.createPlainHighlight=this.createPlainHighlight.bind(this),this.createHighlightDialog.addListener(b.gb.plain,this.createPlainHighlight)),this.highlighter=o.a.createHighlighter(),this.highlighter.addClassApplier(o.a.createClassApplier("rangy-highlight",{ignoreWhiteSpace:!0,tagNames:["span","a"]}))),ot(ct.prototype.__proto__||Object.getPrototypeOf(ct.prototype),"setupAnnotations",this).call(this)}},{key:"bindDOMListeners",value:function(){ot(ct.prototype.__proto__||Object.getPrototypeOf(ct.prototype),"bindDOMListeners",this).call(this),(this.plainHighlightEnabled||this.commentHighlightEnabled)&&(this.annotatedElement.addEventListener("mouseup",this.highlightMouseupHandler),this.annotatedElement.addEventListener("wheel",this.hideCreateDialog),this.hasTouch&&this.annotatedElement.addEventListener("touchend",this.hideCreateDialog)),this.hasTouch&&this.drawEnabled?this.annotatedElement.addEventListener("touchstart",this.drawingSelectionHandler):this.drawEnabled&&this.annotatedElement.addEventListener("click",this.drawingSelectionHandler),this.permissions.canAnnotate&&(this.plainHighlightEnabled||this.commentHighlightEnabled)&&(this.hasTouch||this.isMobile?document.addEventListener("selectionchange",this.onSelectionChange):(this.annotatedElement.addEventListener("dblclick",this.highlightMouseupHandler),this.annotatedElement.addEventListener("mousedown",this.highlightMousedownHandler),this.annotatedElement.addEventListener("contextmenu",this.highlightMousedownHandler)))}},{key:"unbindDOMListeners",value:function(){var e=this;ot(ct.prototype.__proto__||Object.getPrototypeOf(ct.prototype),"unbindDOMListeners",this).call(this),this.annotatedElement.removeEventListener("mouseup",this.highlightMouseupHandler),this.annotatedElement.removeEventListener("wheel",this.hideCreateDialog),this.annotatedElement.removeEventListener("touchend",this.hideCreateDialog),this.highlightThrottleHandle&&(cancelAnimationFrame(this.highlightThrottleHandle),this.highlightThrottleHandle=null),Object.keys(this.modeControllers).forEach(function(t){e.modeControllers[t].removeSelection()}),this.hasTouch||this.isMobile?document.removeEventListener("selectionchange",this.onSelectionChange):(this.annotatedElement.removeEventListener("click",this.drawingSelectionHandler),this.annotatedElement.removeEventListener("dblclick",this.highlightMouseupHandler),this.annotatedElement.removeEventListener("mousedown",this.highlightMousedownHandler),this.annotatedElement.removeEventListener("contextmenu",this.highlightMousedownHandler))}},{key:"removeThreadFromSharedDialog",value:function(){this.mobileDialogEl&&(this.mobileDialogEl.classList.remove(b.z),ot(ct.prototype.__proto__||Object.getPrototypeOf(ct.prototype),"removeThreadFromSharedDialog",this).call(this))}},{key:"hideCreateDialog",value:function(t){this.createHighlightDialog&&this.createHighlightDialog.isVisible&&t&&!y.D(t)&&this.createHighlightDialog.hide()}},{key:"resetHighlightSelection",value:function(t){this.isCreatingHighlight=!1,this.hideCreateDialog(t),document.getSelection().removeAllRanges()}},{key:"createPlainHighlight",value:function(){this.highlightCurrentSelection(),this.createHighlightThread()}},{key:"createHighlightThread",value:function(t){if(""===t||!this.lastHighlightEvent)return null;this.createHighlightDialog&&this.createHighlightDialog.isVisible&&this.createHighlightDialog.hide(),this.isCreatingHighlight=!1;var e=t?b.ic.highlight_comment:b.ic.highlight,n=this.getLocationFromEvent(this.lastHighlightEvent,e);if(this.highlighter.removeAllHighlights(),!n)return null;n=this.createAnnotationThread({},n,e);if(this.lastHighlightEvent=null,this.lastSelection=null,!n)return null;t?n.dialog.hasComments=!0:n.dialog.drawAnnotation(),n.state=b.gc.hover,n.show(),n.dialog.postAnnotation(t);e=this.modeControllers[e];return e&&e.registerThread(n),this.emit(b.hc.threadSave,n.getThreadEventData()),n}},{key:"onSelectionChange",value:function(t){var e=this;t.preventDefault(),t.stopPropagation(),this.selectionEndTimeout&&(clearTimeout(this.selectionEndTimeout),this.selectionEndTimeout=null);var n=this.modeControllers[b.ic.point];if(!(n&&n.pendingThreadID||"textarea"===document.activeElement.nodeName.toLowerCase())){var i=window.getSelection();if(this.lastSelection&&i&&function(t,e){if(t&&!(t.rangeCount<1)&&e){var n=t.getRangeAt(t.rangeCount-1),t=e.getRangeAt(t.rangeCount-1);return n.compareBoundaryPoints(Range.START_TO_END,t)}}(i,this.lastSelection)||this.highlighter.removeAllHighlights(),!u(i))return this.lastHighlightEvent=null,this.createHighlightDialog.hide(),void this.highlighter.removeAllHighlights();this.selectionEndTimeout=setTimeout(function(){e.createHighlightDialog&&e.createHighlightDialog.show(e.container,i)},500);n=y.u(t.target).page;this.plainHighlightEnabled&&this.modeControllers[b.ic.highlight].applyActionToThreads(function(t){return t.reset()},n),this.commentHighlightEnabled&&this.modeControllers[b.ic.highlight_comment].applyActionToThreads(function(t){return t.reset()},n),this.lastSelection=i,this.lastHighlightEvent=t}}},{key:"highlightCurrentSelection",value:function(){this.highlighter&&this.highlighter.highlightSelection("rangy-highlight",{containerElementId:this.annotatedElement.id})}},{key:"highlightMousedownHandler",value:function(t){this.isCreatingHighlight=!0,this.mouseX=t.clientX,this.mouseY=t.clientY,this.plainHighlightEnabled&&this.modeControllers[b.ic.highlight].applyActionToThreads(function(t){return t.onMousedown()}),this.commentHighlightEnabled&&this.modeControllers[b.ic.highlight_comment].applyActionToThreads(function(t){return t.onMousedown()})}},{key:"drawingSelectionHandler",value:function(t){var e=this.modeControllers[b.ic.draw];!e||this.isCreatingAnnotation()||this.isCreatingHighlight||e.handleSelection(t)}},{key:"isCreatingAnnotation",value:function(){var e=this,n=!1;return Object.keys(this.modeControllers).some(function(t){return n=e.modeControllers[t].hadPendingThreads?!0:n}),n}},{key:"highlightMouseupHandler",value:function(t){this.highlighter&&this.highlighter.removeAllHighlights();var e=this.mouseX&&this.mouseX!==t.clientX||this.mouseY&&this.mouseY!==t.clientY;this.createHighlightDialog&&e||"dblclick"===t.type?this.highlightCreateHandler(t):this.highlightClickHandler(t)}},{key:"highlightCreateHandler",value:function(t){t.stopPropagation();var e,n=window.getSelection();!u(n)||(e=y.u(n.anchorNode).pageEl)&&(e=this.isMobile?this.container:e,this.createHighlightDialog.show(e,n),this.isCreatingHighlight=!0,this.lastHighlightEvent=t)}},{key:"highlightClickHandler",value:function(t){this.activeThread=null,this.mouseEvent=t,this.consumed=!1;var e=[],n=[];this.plainHighlightEnabled&&(e=this.modeControllers[b.ic.highlight].getIntersectingThreads(this.mouseEvent)),this.commentHighlightEnabled&&(n=this.modeControllers[b.ic.highlight_comment].getIntersectingThreads(this.mouseEvent)),this.hideAnnotations(t),[].concat(e,n).forEach(this.clickThread),this.activeThread?this.activeThread.show():this.isMobile?this.removeThreadFromSharedDialog():this.resetHighlightSelection(t)}},{key:"clickThread",value:function(t){var e;y.E(t.state)?t.type===b.ic.point?t.destroy():t.cancelFirstComment():y.B(t.type)?((e=t.onClick(this.mouseEvent,this.consumed))&&(this.activeThread=t),this.consumed=this.consumed||e):t.hideDialog()}},{key:"useDefaultCursor",value:function(){this.annotatedElement.classList.add("bp-use-default-cursor")}},{key:"removeDefaultCursor",value:function(){this.annotatedElement.classList.remove("bp-use-default-cursor")}},{key:"removeRangyHighlight",value:function(e){var t=this.highlighter.highlights;Array.isArray(t)&&(t=t.filter(function(t){return t.id===e.id}),this.highlighter.removeHighlights(t))}},{key:"handleControllerEvents",value:function(t){switch(t.event){case b.fb.toggleMode:this.resetHighlightSelection(t.event);break;case b.fb.bindDOMListeners:this.hideCreateDialog(t);break;case b.fb.renderPage:this.renderPage(t.data)}ot(ct.prototype.__proto__||Object.getPrototypeOf(ct.prototype),"handleControllerEvents",this).call(this,t)}},{key:"showFirstDialogFilter",value:function(t,e){0===e?t.show():t.hideDialog()}}]),ct);function ct(){return function(t){if(!(t instanceof ct))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(ct.__proto__||Object.getPrototypeOf(ct)).apply(this,arguments))}e.a=n},function(t,e,n){"use strict";var i=n(9),o=n(4),r=n(5),l=n(1),a=function(t,e,n){return e&&s(t.prototype,e),n&&s(t,n),t};function s(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var h=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(u,r.a),a(u,[{key:"position",value:function(){this.annotatedElement.appendChild(this.element),l.M(this.element);var t=this.element.getBoundingClientRect().width,e=this.annotatedElement.querySelector('[data-page-number="'+this.location.page+'"]'),n=this.threadEl.offsetLeft+12,i=this.threadEl.offsetTop+31,o=(e.clientWidth>this.annotatedElement.clientWidth?e:this.annotatedElement).clientWidth,e=l.J(this.element,e=n-t/2,t,n,o);this.element.style.left=e+"px";i=this.flipDialog(i,this.container.clientHeight);this.element.style.top=i.top,this.element.style.bottom=i.bottom}}]),u),c=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")};function u(){return function(t){if(!(t instanceof u))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(u.__proto__||Object.getPrototypeOf(u)).apply(this,arguments))}var d=n(0),f=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},n=function(t,e,n){return e&&p(t.prototype,e),n&&p(t,n),t};function p(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function g(t,e,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(n):void 0:null===(t=Object.getPrototypeOf(t))?void 0:g(t,e,n)}var m=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(b,o.a),n(b,[{key:"show",value:function(){var t,e,n,i,r,a,o,s,n=(t=this.location,e=this.annotatedElement,n=e.querySelector('[data-page-number="'+(t.page||1)+'"]')||e.querySelector("img"),i=e.getBoundingClientRect(),r=n.getBoundingClientRect(),a=l.v(e),o=r.top-i.top+e.scrollTop,e=r.left-i.left+e.scrollLeft,s=Number(n.getAttribute("data-rotation-angle")),n=function(t,e){var n=r.height,i=r.width/a,o=n/a;switch(s){case-90:return[e,o-t];case-180:return[i-t,o-e];case-270:return[i-e,t]}return[t,e]}(t.x,t.y),n=(t=c(n,2))[0],t=t[1],n*=a,t*=a,0<=e&&(n+=e),0<=o&&(t+=o),-180===s&&(t-=7.5),[n,t]),t=f(n,2),n=t[0],t=t[1];this.element.style.left=n-12+"px",this.element.style.top=t-31+8+"px",this.annotatedElement.appendChild(this.element),l.M(this.element),this.state!==d.gc.pending||this.isMobile&&0===Object.keys(this.annotations).length||this.showDialog()}},{key:"createDialog",value:function(){this.dialog=new h({annotatedElement:this.annotatedElement,container:this.container,annotations:this.annotations,location:this.location,locale:this.locale,isMobile:this.isMobile,hasTouch:this.hasTouch,canAnnotate:this.permissions.canAnnotate})}}]),b),v=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(t){o=!0,r=t}finally{try{!i&&s.return&&s.return()}finally{if(o)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},n=function(t,e,n){return e&&y(t.prototype,e),n&&y(t,n),t};function y(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function b(){return function(t){if(!(t instanceof b))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)})(E,i.a),n(E,[{key:"getAnnotatedEl",value:function(t){return t.querySelector(".bp-image, .bp-images-wrapper")}},{key:"getLocationFromEvent",value:function(t){var e=null,n=t;if(this.hasTouch){if(!t.targetTouches||0===t.targetTouches.length)return e;n=t.targetTouches[0]}var i=n.target;if("img"!==i.nodeName.toLowerCase())return e;var o=l.u(i).page,a=i.getBoundingClientRect(),r=n.clientX-a.left,t=n.clientY-a.top;if(Number.isNaN(r)||Number.isNaN(t))return this.emit(d.a.error,this.localized.createError),e;n=l.v(this.annotatedElement),e=function(t,e,n,i){var o=a.height,r=a.width;switch(n){case-90:return[r/i-e,t];case-180:return[r/i-t,o/i-e];case-270:return[e,o/i-t]}return[t,e]}(r/n,t/n,Number(i.getAttribute("data-rotation-angle")),n),e=v(e,2);return{x:e[0],y:t=e[1],imageEl:i,dimensions:{x:a.width/n,y:a.height/n},page:o}}},{key:"createAnnotationThread",value:function(t,e,n){var i=void 0;(!e.page||e.page<0)&&(e.page=1);e=this.getThreadParams(t,e,n);return l.a(e)?(i=n===d.ic.point?new m(e):i)||this.emit(d.a.error,this.localized.loadError):this.handleValidationError(),i}},{key:"scaleAnnotations",value:function(t){this.setScale(t.scale),this.rotateAnnotations(t.rotationAngle,t.pageNum)}},{key:"rotateAnnotations",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;e?this.renderPage(e):this.render();var n=this.modeControllers[d.ic.point];this.permissions.canAnnotate&&n&&(e=this.modeButtons[d.ic.point].selector,e=n.getButton(e),0!==t?l.x(e):l.M(e))}},{key:"bindDOMListeners",value:function(){this.annotatedElement.addEventListener("mouseup",this.hideAnnotations),g(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"bindDOMListeners",this).call(this)}},{key:"unbindDOMListeners",value:function(){this.annotatedElement.removeEventListener("mouseup",this.hideAnnotations),g(E.prototype.__proto__||Object.getPrototypeOf(E.prototype),"bindDOMListeners",this).call(this)}}]),n=E;function E(){return function(t){if(!(t instanceof E))throw new TypeError("Cannot call a class as a function")}(this),function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(E.__proto__||Object.getPrototypeOf(E)).apply(this,arguments))}e.a=n},function(t,e,n){t.exports=n(32)},function(t,g,m){"use strict";m.r(g),function(t){var e=m(29),n=m(30),i=m(24),o=m(27),r=m(12),a=m(0),s=m(1),l=function(t,e,n){return e&&h(t.prototype,e),n&&h(t,n),t};function h(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function c(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function u(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var d=[{NAME:"Document",CONSTRUCTOR:e.a,VIEWER:["Document","Presentation"],TYPE:[a.ic.point,a.ic.highlight,a.ic.highlight_comment,a.ic.draw],DEFAULT_TYPES:[a.ic.point,a.ic.highlight,a.ic.highlight_comment,a.ic.draw]},{NAME:"Image",CONSTRUCTOR:n.a,VIEWER:["Image","MultiImage"],TYPE:[a.ic.point],DEFAULT_TYPES:[a.ic.point]}],f=(u(n={},a.ic.point,{CONSTRUCTOR:o.a}),u(n,a.ic.highlight,{CONSTRUCTOR:r.a}),u(n,a.ic.highlight_comment,{CONSTRUCTOR:r.a}),u(n,a.ic.draw,{CONSTRUCTOR:i.a}),n),l=(l(p,[{key:"getAnnotators",value:function(){return Array.isArray(this.annotators)?this.annotators:[]}},{key:"getAnnotatorsForViewer",value:function(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],t=this.getAnnotators().find(function(t){return!n.includes(t.NAME)&&t.VIEWER.includes(e)});return this.instantiateControllers(t),t}},{key:"instantiateControllers",value:function(e){e&&e.TYPE&&!e.CONTROLLERS&&(e.CONTROLLERS={},this.getAnnotatorTypes(e).forEach(function(t){t in f&&(e.CONTROLLERS[t]=new f[t].CONSTRUCTOR)}))}},{key:"getAnnotatorTypes",value:function(t){if(this.viewerOptions&&this.viewerOptions[t.NAME]){var e=this.viewerOptions[t.NAME];if(e.enabledTypes)return e.enabledTypes.filter(function(e){return t.TYPE.some(function(t){return t===e})})}else if(!this.viewerConfig)return[].concat(c(t.DEFAULT_TYPES));var e=this.viewerConfig.enabledTypes||[].concat(c(t.DEFAULT_TYPES)),n=this.viewerConfig.disabledTypes||[];return e.filter(function(e){return!n.some(function(t){return t===e})&&t.TYPE.some(function(t){return t===e})})}},{key:"determineAnnotator",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],i=null;this.viewerConfig=e;e=Object(s.b)(t.file.permissions),n=this.getAnnotatorsForViewer(t.viewer.NAME,n);return e&&n&&!1!==this.viewerConfig.enabled&&((i=Object.assign({},n)).TYPE=this.getAnnotatorTypes(i)),i}}]),p);function p(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};!function(t){if(!(t instanceof p))throw new TypeError("Cannot call a class as a function")}(this),this.annotators=d,this.viewerOptions=t}t.BoxAnnotations=l,g.default=l}.call(this,m(33))},function(t,e){var n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(t){"object"==typeof window&&(n=window)}t.exports=n},function(t,e,n){var o=[n(7)];void 0===(n="function"==typeof(n=function(t){return t.createModule("ClassApplier",["WrappedSelection"],function(n,u){var d=n.dom,o=d.DomPosition,r=d.arrayContains,t=n.util,p=t.forEach,a=t.isHostMethod(document,"createElementNS");function c(t,e){for(var n in t)if(t.hasOwnProperty(n)&&!1===e(n,t[n]))return!1;return!0}function f(t){return t.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function s(t,e){return!!t&&new RegExp("(?:^|\\s)"+e+"(?:\\s|$)").test(t)}function l(t,e){return"object"==typeof t.classList?t.classList.contains(e):s("string"==typeof t.className?t.className:t.getAttribute("class"),e)}function g(t,e){var n,i;"object"==typeof t.classList?t.classList.add(e):((i=(n="string"==typeof t.className)?t.className:t.getAttribute("class"))?s(i,e)||(i+=" "+e):i=e,n?t.className=i:t.setAttribute("class",i))}var m=function(t,e){var n,i;"object"==typeof t.classList?t.classList.remove(e):(i=(i=(n="string"==typeof t.className)?t.className:t.getAttribute("class")).replace(new RegExp("(^|\\s)"+e+"(\\s|$)"),h),n?t.className=i:t.setAttribute("class",i))};function h(t,e,n){return e&&n?" ":""}function e(t){return"string"==typeof t.className?t.className:t.getAttribute("class")}function v(t){return t&&t.split(/\s+/).sort().join(" ")}function y(t){return v(e(t))}function b(t,e){return y(t)==y(e)}function E(t,e){for(var n=e.split(/\s+/),i=0,o=n.length;i<o;++i)if(!l(t,f(n[i])))return!1;return!0}function w(t,r,a,e){-1==a&&(a=r.childNodes.length);var s=t.parentNode,l=d.getNodeIndex(t);p(e,function(t){var e,n,i,o;n=(e=t).node,i=e.offset,o=i,(t=n)==r&&a<i&&++o,n!=s||i!=l&&i!=l+1||(t=r,o+=a-l),n==s&&l+1<i&&--o,e.node=t,e.offset=o}),r.childNodes.length==a?r.appendChild(t):r.insertBefore(t,r.childNodes[a])}function C(t,e){var n=t.parentNode,i=d.getNodeIndex(t);p(e,function(t){t.node==n&&t.offset>i&&--t.offset}),d.removeNode(t)}function O(t,e){return function(t,e,n,i){for(var o,r=[];o=t.firstChild;)w(o,e,n++,i),r.push(o);return C(t,i),r}(t,t.parentNode,d.getNodeIndex(t),e)}function x(t,e){var n=t.cloneRange();n.selectNodeContents(e);t=n.intersection(t);return""!=(t?t.toString():"")}function T(t){for(var e,n=t.getNodes([3]),i=0;(e=n[i])&&!x(t,e);)++i;for(var o=n.length-1;(e=n[o])&&!x(t,e);)--o;return n.slice(i,o+1)}function _(t,e){if(t.attributes.length!=e.attributes.length)return!1;for(var n,i,o=0,r=t.attributes.length;o<r;++o)if("class"!=(i=(n=t.attributes[o]).name)){if(null===n!=(null===(i=e.attributes.getNamedItem(i))))return!1;if(n.specified!=i.specified)return!1;if(n.specified&&n.nodeValue!==i.nodeValue)return!1}return!0}function S(t,e){for(var n,i=0,o=t.attributes.length;i<o;++i)if(n=t.attributes[i].name,(!e||!r(e,n))&&t.attributes[i].specified&&"class"!=n)return!0;return!1}var k=d.getComputedStyleProperty,A="boolean"==typeof document.createElement("div").isContentEditable?function(t){return t&&1==t.nodeType&&t.isContentEditable}:function(t){return!(!t||1!=t.nodeType||"false"==t.contentEditable)&&("true"==t.contentEditable||A(t.parentNode))};function R(t){var e;return t&&1==t.nodeType&&((e=t.parentNode)&&9==e.nodeType&&"on"==e.designMode||A(t)&&!A(t.parentNode))}function D(t){return(A(t)||1!=t.nodeType&&A(t.parentNode))&&!R(t)}var P=/^inline(-block|-table)?$/i;function L(t){return t&&1==t.nodeType&&!P.test(k(t,"display"))}var N=/[^\r\n\t\f \u200B]/;function M(t){for(var e,n=[],i=0;e=t[i++];)n.push(new o(e.startContainer,e.startOffset),new o(e.endContainer,e.endOffset));return n}function B(t,e){for(var n,i,o,r=0,a=t.length;r<a;++r)n=t[r],i=e[2*r],o=e[2*r+1],n.setStartAndEnd(i.node,i.offset,o.node,o.offset)}function j(t,e,n,i){var o,r=0==n;if(d.isAncestorOf(e,t))return t;if(d.isCharacterDataNode(e)){var a=d.getNodeIndex(e);if(0==n)n=a;else{if(n!=e.length)throw u.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+n+" in "+e.data);n=a+1}e=e.parentNode}if(o=e,a=n,d.isCharacterDataNode(o)?0==a?o.previousSibling:a!=o.length||o.nextSibling:0<a&&a<o.childNodes.length){h=e.cloneNode(!1),c=e.parentNode,h.id&&h.removeAttribute("id");for(var s,l=0;s=e.childNodes[n];)w(s,h,l++,i);return w(h,c,d.getNodeIndex(e)+1,i),e==t?h:j(t,c,d.getNodeIndex(h),i)}if(t==e)return t;var h=e.parentNode,c=d.getNodeIndex(e);return r||c++,j(t,h,c,i)}function H(i){var o=i?"nextSibling":"previousSibling";return function(t,e){var n=t.parentNode,t=t[o];if(t){if(t&&3==t.nodeType)return t}else if(e&&(t=n[o])&&1==t.nodeType&&((e=n).namespaceURI==(n=t).namespaceURI&&e.tagName.toLowerCase()==n.tagName.toLowerCase()&&b(e,n)&&_(e,n)&&"inline"==k(e,"display")&&"inline"==k(n,"display"))){t=t[i?"firstChild":"lastChild"];if(t&&3==t.nodeType)return t}return null}}var I=H(!1),F=H(!0);function q(t){this.isElementMerge=1==t.nodeType,this.textNodes=[];t=this.isElementMerge?t.lastChild:t;t&&(this.textNodes[0]=t)}var z=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements","onElementCreate"],Y={};function X(t,e,n){var i,o,r,a=this;a.cssClass=a.className=t;var s=null,l={};if("object"==typeof e&&null!==e){for(void 0!==e.elementTagName&&(e.elementTagName=e.elementTagName.toLowerCase()),n=e.tagNames,s=e.elementProperties,l=e.elementAttributes,i=0;r=z[i++];)e.hasOwnProperty(r)&&(a[r]=e[r]);h=e.normalize}else h=e;a.normalize=void 0===h||h,a.attrExceptions=[];var h=document.createElement(a.elementTagName);a.elementProperties=a.copyPropertiesToElement(s,h,!0),c(l,function(t,e){a.attrExceptions.push(t),l[t]=""+e}),a.elementAttributes=l,a.elementSortedClassName=a.elementProperties.hasOwnProperty("className")?v(a.elementProperties.className+" "+t):t,a.applyToAnyTagName=!1;t=typeof n;if("string"==t)"*"==n?a.applyToAnyTagName=!0:a.tagNames=f(n.toLowerCase()).split(/\s*,\s*/);else if("object"==t&&"number"==typeof n.length)for(a.tagNames=[],i=0,o=n.length;i<o;++i)"*"==n[i]?a.applyToAnyTagName=!0:a.tagNames.push(n[i].toLowerCase());else a.tagNames=[a.elementTagName]}X.prototype={elementTagName:"span",elementProperties:{},elementAttributes:{},ignoreWhiteSpace:!0,applyToEditableOnly:!(q.prototype={doMerge:function(t){var i,o,r,a,e=this.textNodes,s=e[0];return 1<e.length&&(o=d.getNodeIndex(s),r=[],a=0,p(e,function(e,n){i=e.parentNode,0<n&&(i.removeChild(e),i.hasChildNodes()||d.removeNode(i),t&&p(t,function(t){t.node==e&&(t.node=s,t.offset+=a),t.node==i&&t.offset>o&&(--t.offset,t.offset==o+1&&n<len-1&&(t.node=s,t.offset=a))})),r[n]=e.data,a+=e.data.length}),s.data=r.join("")),s.data},getLength:function(){for(var t=this.textNodes.length,e=0;t--;)e+=this.textNodes[t].length;return e},toString:function(){var n=[];return p(this.textNodes,function(t,e){n[e]="'"+t.data+"'"}),"[Merge("+n.join(",")+")]"}}),useExistingElements:!0,removeEmptyElements:!0,onElementCreate:null,copyPropertiesToElement:function(t,e,n){var i,o,r,a,s,l,h={};for(l in t)if(t.hasOwnProperty(l))if(a=t[l],s=e[l],"className"==l)g(e,a),g(e,this.className),e[l]=v(e[l]),n&&(h[l]=a);else if("style"==l){for(i in o=s,n&&(h[l]=r={}),t[l])t[l].hasOwnProperty(i)&&(o[i]=a[i],n&&(r[i]=o[i]));this.attrExceptions.push(l)}else e[l]=a,n&&(h[l]=e[l],s=Y.hasOwnProperty(l)?Y[l]:l,this.attrExceptions.push(s));return n?h:""},copyAttributesToElement:function(t,e){for(var n in t)t.hasOwnProperty(n)&&!/^class(?:Name)?$/i.test(n)&&e.setAttribute(n,t[n])},appliesToElement:function(t){return r(this.tagNames,t.tagName.toLowerCase())},getEmptyElements:function(t){var e=this;return t.getNodes([1],function(t){return e.appliesToElement(t)&&!t.hasChildNodes()})},hasClass:function(t){return 1==t.nodeType&&(this.applyToAnyTagName||this.appliesToElement(t))&&l(t,this.className)},getSelfOrAncestorWithClass:function(t){for(;t;){if(this.hasClass(t))return t;t=t.parentNode}return null},isModifiable:function(t){return!this.applyToEditableOnly||D(t)},isIgnorableWhiteSpaceNode:function(t){return this.ignoreWhiteSpace&&t&&3==t.nodeType&&function(t){if(0==t.data.length)return!0;if(N.test(t.data))return!1;switch(k(t.parentNode,"whiteSpace")){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(t.data))return!1}return L(t.previousSibling)||L(t.nextSibling)}(t)},postApply:function(t,e,n,o){var r,a,s=t[0],l=t[t.length-1],h=[],c=s,u=l,d=0,f=l.length;p(t,function(t){(a=I(t,!o))?(r||(r=new q(a),h.push(r)),r.textNodes.push(t),t===s&&(c=r.textNodes[0],d=c.length),t===l&&(u=r.textNodes[0],f=r.getLength())):r=null});t=F(l,!o);if(t&&(r||(r=new q(l),h.push(r)),r.textNodes.push(t)),h.length){for(i=0,len=h.length;i<len;++i)h[i].doMerge(n);e.setStartAndEnd(c,d,u,f)}},createContainer:function(t){var e=d.getDocument(t),e=a&&!d.isHtmlNamespace(t)&&t.namespaceURI?e.createElementNS(t.namespaceURI,this.elementTagName):e.createElement(this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,e,!1),this.copyAttributesToElement(this.elementAttributes,e),g(e,this.className),this.onElementCreate&&this.onElementCreate(e,this),e},elementHasProperties:function(n,t){var i=this;return c(t,function(t,e){if("className"==t)return E(n,e);if("object"==typeof e){if(!i.elementHasProperties(n[t],e))return!1}else if(n[t]!==e)return!1})},elementHasAttributes:function(n,t){return c(t,function(t,e){if(n.getAttribute(t)!==e)return!1})},applyToTextNode:function(t,e){var n,i;(i=t.parentNode)&&1==i.nodeType&&!/^(textarea|style|script|select|iframe)$/i.test(i.nodeName)&&(1==(n=t.parentNode).childNodes.length&&this.useExistingElements&&this.appliesToElement(n)&&this.elementHasProperties(n,this.elementProperties)&&this.elementHasAttributes(n,this.elementAttributes)?g(n,this.className):(i=t.parentNode,n=this.createContainer(i),i.insertBefore(n,t),n.appendChild(t)))},isRemovable:function(t){return t.tagName.toLowerCase()==this.elementTagName&&y(t)==this.elementSortedClassName&&this.elementHasProperties(t,this.elementProperties)&&!S(t,this.attrExceptions)&&this.elementHasAttributes(t,this.elementAttributes)&&this.isModifiable(t)},isEmptyContainer:function(t){var e=t.childNodes.length;return 1==t.nodeType&&this.isRemovable(t)&&(0==e||1==e&&this.isEmptyContainer(t.firstChild))},removeEmptyContainers:function(t){var e=this,n=t.getNodes([1],function(t){return e.isEmptyContainer(t)}),t=[t],i=M(t);p(n,function(t){C(t,i)}),B(t,i)},undoToTextNode:function(t,e,n,i){var o;e.containsNode(n)||((o=e.cloneRange()).selectNode(n),o.isPointInRange(e.endContainer,e.endOffset)&&(j(n,e.endContainer,e.endOffset,i),e.setEndAfter(n)),o.isPointInRange(e.startContainer,e.startOffset)&&(n=j(n,e.startContainer,e.startOffset,i))),this.isRemovable(n)?O(n,i):m(n,this.className)},splitAncestorWithClass:function(t,e,n){var i=this.getSelfOrAncestorWithClass(t);i&&j(i,t,e,n)},undoToAncestor:function(t,e){this.isRemovable(t)?O(t,e):m(t,this.className)},applyToRange:function(t,e){var n=this,i=M((e=e||[])||[]);t.splitBoundariesPreservingPositions(i),n.removeEmptyElements&&n.removeEmptyContainers(t);var o,r=T(t);r.length&&(p(r,function(t){n.isIgnorableWhiteSpaceNode(t)||n.getSelfOrAncestorWithClass(t)||!n.isModifiable(t)||n.applyToTextNode(t,i)}),o=r[r.length-1],t.setStartAndEnd(r[0],0,o,o.length),n.normalize&&n.postApply(r,t,i,!1),B(e,i));t=n.getEmptyElements(t);p(t,function(t){g(t,n.className)})},applyToRanges:function(t){for(var e=t.length;e--;)this.applyToRange(t[e],t);return t},applyToSelection:function(t){t=n.getSelection(t);t.setRanges(this.applyToRanges(t.getAllRanges()))},undoToRange:function(t,e){var n=this,i=M(e=e||[]);t.splitBoundariesPreservingPositions(i),n.removeEmptyElements&&n.removeEmptyContainers(t,i);var o,r,a=T(t),s=a[a.length-1];if(a.length){n.splitAncestorWithClass(t.endContainer,t.endOffset,i),n.splitAncestorWithClass(t.startContainer,t.startOffset,i);for(var l=0,h=a.length;l<h;++l)o=a[l],(r=n.getSelfOrAncestorWithClass(o))&&n.isModifiable(o)&&n.undoToAncestor(r,i);t.setStartAndEnd(a[0],0,s,s.length),n.normalize&&n.postApply(a,t,i,!0),B(e,i)}t=n.getEmptyElements(t);p(t,function(t){m(t,n.className)})},undoToRanges:function(t){for(var e=t.length;e--;)this.undoToRange(t[e],t);return t},undoToSelection:function(t){var e=n.getSelection(t),t=n.getSelection(t).getAllRanges();this.undoToRanges(t),e.setRanges(t)},isAppliedToRange:function(t){if(t.collapsed||""==t.toString())return!!this.getSelfOrAncestorWithClass(t.commonAncestorContainer);var e=t.getNodes([3]);if(e.length)for(var n,i=0;n=e[i++];)if(!this.isIgnorableWhiteSpaceNode(n)&&x(t,n)&&this.isModifiable(n)&&!this.getSelfOrAncestorWithClass(n))return!1;return!0},isAppliedToRanges:function(t){var e=t.length;if(0==e)return!1;for(;e--;)if(!this.isAppliedToRange(t[e]))return!1;return!0},isAppliedToSelection:function(t){t=n.getSelection(t);return this.isAppliedToRanges(t.getAllRanges())},toggleRange:function(t){this.isAppliedToRange(t)?this.undoToRange(t):this.applyToRange(t)},toggleSelection:function(t){this.isAppliedToSelection(t)?this.undoToSelection(t):this.applyToSelection(t)},getElementsWithClassIntersectingRange:function(t){var e=[],n=this;return t.getNodes([3],function(t){t=n.getSelfOrAncestorWithClass(t);t&&!r(e,t)&&e.push(t)}),e},detach:function(){}},X.util={hasClass:l,addClass:g,removeClass:m,getClass:e,hasSameClasses:b,hasAllClasses:E,replaceWithOwnChildren:O,elementsHaveSameNonClassAttributes:_,elementHasNonClassAttributes:S,splitNodeAt:j,isEditableElement:A,isEditingHost:R,isEditable:D},n.CssClassApplier=n.ClassApplier=X,n.createClassApplier=function(t,e,n){return new X(t,e,n)},t.createAliasForDeprecatedMethod(n,"createCssClassApplier","createClassApplier",u)}),t})?n.apply(e,o):n)||(t.exports=n)},function(t,e,n){var i=[n(7)];void 0===(n="function"==typeof(n=function(t){return t.createModule("Highlighter",["ClassApplier"],function(C,t){var e=C.dom,o=e.arrayContains,l=e.getBody,O=C.util.createOptions,x=C.util.forEach,a=1;function n(t,e){return t.characterRange.start-e.characterRange.start}function u(t,e){return e?t.getElementById(e):l(t)}var i={};function r(t,e){this.type=t,this.converterCreator=e}function s(t,e){i[t]=new r(t,e)}function d(t){var e=i[t];if(e instanceof r)return e.create();throw new Error("Highlighter type '"+t+"' is not valid")}function T(t,e){this.start=t,this.end=e}r.prototype.create=function(){var t=this.converterCreator();return t.type=this.type,t},C.registerHighlighterType=s,T.prototype={intersects:function(t){return this.start<t.end&&this.end>t.start},isContiguousWith:function(t){return this.start==t.end||this.end==t.start},union:function(t){return new T(Math.min(this.start,t.start),Math.max(this.end,t.end))},intersection:function(t){return new T(Math.max(this.start,t.start),Math.min(this.end,t.end))},getComplements:function(t){var e=[];if(this.start>=t.start){if(this.end<=t.end)return[];e.push(new T(t.end,this.end))}else e.push(new T(this.start,Math.min(this.end,t.start))),this.end>t.end&&e.push(new T(t.end,this.end));return e},toString:function(){return"[CharacterRange("+this.start+", "+this.end+")]"}},T.fromCharacterRange=function(t){return new T(t.start,t.end)};var h,c={rangeToCharacterRange:function(t,e){e=t.getBookmark(e);return new T(e.start,e.end)},characterRangeToRange:function(t,e,n){t=C.createRange(t);return t.moveToBookmark({start:e.start,end:e.end,containerNode:n}),t},serializeSelection:function(t,e){for(var n=t.getAllRanges(),i=[],o=1==n.length&&t.isBackward(),r=0,a=n.length;r<a;++r)i[r]={characterRange:this.rangeToCharacterRange(n[r],e),backward:o};return i},restoreSelection:function(t,e,n){t.removeAllRanges();for(var i,o,r=t.win.document,a=0,s=e.length;a<s;++a)(o=e[a]).characterRange,i=this.characterRangeToRange(r,o.characterRange,n),t.addRange(i,o.backward)}};function _(t,e,n,i,o,r){o?(this.id=o,a=Math.max(a,o+1)):this.id=a++,this.characterRange=e,this.doc=t,this.classApplier=n,this.converter=i,this.containerElementId=r||null,this.applied=!1}function f(t,e){e=e||"textContent",this.doc=t||document,this.classAppliers={},this.highlights=[],this.converter=d(e)}s("textContent",function(){return c}),s("TextRange",function(){if(!h){var t=C.modules.TextRange;if(!t)throw new Error("TextRange module is missing.");if(!t.supported)throw new Error("TextRange module is present but not supported.");h={rangeToCharacterRange:function(t,e){return T.fromCharacterRange(t.toCharacterRange(e))},characterRangeToRange:function(t,e,n){t=C.createRange(t);return t.selectCharacters(n,e.start,e.end),t},serializeSelection:function(t,e){return t.saveCharacterRanges(e)},restoreSelection:function(t,e,n){t.restoreCharacterRanges(n,e)}}}return h}),_.prototype={getContainerElement:function(){return u(this.doc,this.containerElementId)},getRange:function(){return this.converter.characterRangeToRange(this.doc,this.characterRange,this.getContainerElement())},fromRange:function(t){this.characterRange=this.converter.rangeToCharacterRange(t,this.getContainerElement())},getText:function(){return this.getRange().toString()},containsElement:function(t){return this.getRange().containsNodeContents(t.firstChild)},unapply:function(){this.classApplier.undoToRange(this.getRange()),this.applied=!1},apply:function(){this.classApplier.applyToRange(this.getRange()),this.applied=!0},getHighlightElements:function(){return this.classApplier.getElementsWithClassIntersectingRange(this.getRange())},toString:function(){return"[Highlight(ID: "+this.id+", class: "+this.classApplier.className+", character range: "+this.characterRange.start+" - "+this.characterRange.end+")]"}},f.prototype={addClassApplier:function(t){this.classAppliers[t.className]=t},getHighlightForElement:function(t){for(var e=this.highlights,n=0,i=e.length;n<i;++n)if(e[n].containsElement(t))return e[n];return null},removeHighlights:function(t){for(var e,n=0,i=this.highlights.length;n<i;++n)e=this.highlights[n],o(t,e)&&(e.unapply(),this.highlights.splice(n--,1))},removeAllHighlights:function(){this.removeHighlights(this.highlights)},getIntersectingHighlights:function(t){var n=[],i=this.highlights;return x(t,function(e){x(i,function(t){e.intersectsRange(t.getRange())&&!o(n,t)&&n.push(t)})}),n},highlightCharacterRanges:function(t,e,n){var i,o,r,a,s,l,h,c,u,d,f,p=this.highlights,g=this.converter,m=this.doc,v=[],y=t?this.classAppliers[t]:null,b=(n=O(n,{containerElementId:null,exclusive:!0})).containerElementId,E=n.exclusive;for(b&&(a=this.doc.getElementById(b))&&((n=C.createRange(this.doc)).selectNodeContents(a),s=new T(0,n.toString().length)),i=0,o=e.length;i<o;++i)if(l=e[i],d=[],(l=s?l.intersection(s):l).start!=l.end){for(r=0;r<p.length;++r)c=!1,b==p[r].containerElementId&&(h=p[r].characterRange,f=!(u=y==p[r].classApplier)&&E,(h.intersects(l)||h.isContiguousWith(l))&&(u||f)&&(f&&x(h.getComplements(l),function(t){d.push(new _(m,t,p[r].classApplier,g,null,b))}),c=!0,u&&(l=h.union(l)))),c?(v.push(p[r]),p[r]=new _(m,h.union(l),y,g,null,b)):d.push(p[r]);y&&d.push(new _(m,l,y,g,null,b)),this.highlights=p=d}x(v,function(t){t.unapply()});var w=[];return x(p,function(t){t.applied||(t.apply(),w.push(t))}),w},highlightRanges:function(t,e,n){var i,o=[],r=this.converter,a=(n=O(n,{containerElement:null,exclusive:!0})).containerElement,s=a?a.id:null;return a&&(i=C.createRange(a)).selectNodeContents(a),x(e,function(t){var e=a?i.intersection(t):t;o.push(r.rangeToCharacterRange(e,a||l(t.getDocument())))}),this.highlightCharacterRanges(t,o,{containerElementId:s,exclusive:n.exclusive})},highlightSelection:function(t,e){var n=this.converter,i=!!t&&this.classAppliers[t],o=(e=O(e,{containerElementId:null,selection:C.getSelection(this.doc),exclusive:!0})).containerElementId,r=e.exclusive,a=e.selection,e=u(a.win.document,o);if(!i&&!1!==t)throw new Error("No class applier found for class '"+t+"'");var i=n.serializeSelection(a,e),s=[];x(i,function(t){s.push(T.fromCharacterRange(t.characterRange))});r=this.highlightCharacterRanges(t,s,{containerElementId:o,exclusive:r});return n.restoreSelection(a,i,e),r},unhighlightSelection:function(t){t=t||C.getSelection(this.doc);var e=this.getIntersectingHighlights(t.getAllRanges());return this.removeHighlights(e),t.removeAllRanges(),e},getHighlightsInSelection:function(t){return t=t||C.getSelection(this.doc),this.getIntersectingHighlights(t.getAllRanges())},selectionOverlapsHighlight:function(t){return 0<this.getHighlightsInSelection(t).length},serialize:function(i){var t,o,r,a,s=this,e=s.highlights;return e.sort(n),t=(i=O(i,{serializeHighlightText:!1,type:s.converter.type})).type,(r=t!=s.converter.type)&&(a=d(t)),o=["type:"+t],x(e,function(t){var e,n=t.characterRange;r&&(e=t.getContainerElement(),n=a.rangeToCharacterRange(s.converter.characterRangeToRange(s.doc,n,e),e));n=[n.start,n.end,t.id,t.classApplier.className,t.containerElementId];i.serializeHighlightText&&n.push(t.getText()),o.push(n.join("$"))}),o.join("|")},deserialize:function(t){var e,n,i,o,r,a=t.split("|"),s=[],t=a[0],l=!1;if(!t||!(e=/^type:(\w+)$/.exec(t)))throw new Error("Serialized highlights are invalid.");(e=e[1])!=this.converter.type&&(n=d(e),l=!0),a.shift();for(var h,c=a.length;0<c--;){if(i=new T(+(h=a[c].split("$"))[0],+h[1]),o=h[4]||null,l&&(r=u(this.doc,o),i=this.converter.rangeToCharacterRange(n.characterRangeToRange(this.doc,i,r),r)),!(r=this.classAppliers[h[3]]))throw new Error("No class applier found for class '"+h[3]+"'");(o=new _(this.doc,i,r,this.converter,parseInt(h[2]),o)).apply(),s.push(o)}this.highlights=s}},C.Highlighter=f,C.createHighlighter=function(t,e){return new f(t,e)}}),t})?n.apply(e,i):n)||(t.exports=n)},function(t,e,n){var i=[n(7)];void 0===(n="function"==typeof(n=function(t){return t.createModule("SaveRestore",["WrappedRange"],function(l,a){var o=l.dom,s=o.removeNode,h=l.Selection.isDirectionBackward,r="\ufeff";function c(t,e){return(e||document).getElementById(t)}function u(t,e){var n="selectionBoundary_"+ +new Date+"_"+(""+Math.random()).slice(2),i=o.getDocument(t.startContainer),t=t.cloneRange();return t.collapse(e),(e=i.createElement("span")).id=n,e.style.lineHeight="0",e.style.display="none",e.className="rangySelectionBoundary",e.appendChild(i.createTextNode(r)),t.insertNode(e),e}function d(t,e,n,i){t=c(n,t);t?(e[i?"setStartBefore":"setEndBefore"](t),s(t)):a.warn("Marker element has been removed. Cannot restore selection.")}function f(t,e){return e.compareBoundaryPoints(t.START_TO_START,t)}function p(t,e){var n,i=l.DomRange.getRangeDocument(t),o=t.toString(),e=h(e);return t.collapsed?{document:i,markerId:(n=u(t,!1)).id,collapsed:!0}:(n=u(t,!1),{document:i,startMarkerId:u(t,!0).id,endMarkerId:n.id,collapsed:!1,backward:e,toString:function(){return"original text: '"+o+"', new text: '"+t.toString()+"'"}})}function i(t,e){var n=t.document;void 0===e&&(e=!0);var i,o,r=l.createRange(n);return t.collapsed?(i=c(t.markerId,n))?(i.style.display="inline",(o=i.previousSibling)&&3==o.nodeType?(s(i),r.collapseToPoint(o,o.length)):(r.collapseBefore(i),s(i))):a.warn("Marker element has been removed. Cannot restore selection."):(d(n,r,t.startMarkerId,!0),d(n,r,t.endMarkerId,!1)),e&&r.normalizeBoundaries(),r}function g(t,e){var n,i,o=[],r=h(e);(t=t.slice(0)).sort(f);for(var a=0,s=t.length;a<s;++a)o[a]=p(t[a],r);for(a=s-1;0<=a;--a)n=t[a],i=l.DomRange.getRangeDocument(n),n.collapsed?n.collapseAfter(c(o[a].markerId,i)):(n.setEndBefore(c(o[a].endMarkerId,i)),n.setStartAfter(c(o[a].startMarkerId,i)));return o}function m(t){for(var e=[],n=t.length-1;0<=n;n--)e[n]=i(t[n],!0);return e}function v(t,e){t=c(e,t);t&&s(t)}l.util.extend(l,{saveRange:p,restoreRange:i,saveRanges:g,restoreRanges:m,saveSelection:function(t){if(!l.isSelectionValid(t))return a.warn("Cannot save selection. This usually happens when the selection is collapsed and the selection document has lost focus."),null;var e=l.getSelection(t),n=e.getAllRanges(),i=1==n.length&&e.isBackward(),o=g(n,i);return i?e.setSingleRange(n[0],i):e.setRanges(n),{win:t,rangeInfos:o,restored:!1}},restoreSelection:function(t,e){var n,i,o;t.restored||(n=t.rangeInfos,i=l.getSelection(t.win),o=m(n),1==n.length&&e&&l.features.selectionHasExtend&&n[0].backward?(i.removeAllRanges(),i.addRange(o[0],!0)):i.setRanges(o),t.restored=!0)},removeMarkerElement:v,removeMarkers:function(t){for(var e,n=t.rangeInfos,i=0,o=n.length;i<o;++i)(e=n[i]).collapsed?v(t.doc,e.markerId):(v(t.doc,e.startMarkerId),v(t.doc,e.endMarkerId))}})}),t})?n.apply(e,i):n)||(t.exports=n)},function(t,e,n){},,function(t,e,n){"use strict";function i(t,e,n,i,o){!function t(e,n,i,o,r){for(;i<o;){var a,s,l,h;600<o-i&&(a=o-i+1,s=n-i+1,h=Math.log(a),l=.5*Math.exp(2*h/3),h=.5*Math.sqrt(h*l*(a-l)/a)*(s-a/2<0?-1:1),t(e,n,Math.max(i,Math.floor(n-s*l/a+h)),Math.min(o,Math.floor(n+(a-s)*l/a+h)),r));var c=e[n],u=i,d=o;for(f(e,i,n),0<r(e[o],c)&&f(e,i,o);u<d;){for(f(e,u,d),u++,d--;r(e[u],c)<0;)u++;for(;0<r(e[d],c);)d--}0===r(e[i],c)?f(e,i,d):f(e,++d,o),d<=n&&(i=d+1),n<=d&&(o=d-1)}}(t,e,n||0,i||t.length-1,o||r)}function f(t,e,n){var i=t[e];t[e]=t[n],t[n]=i}function r(t,e){return t<e?-1:e<t?1:0}t.exports=i,t.exports.default=i}],o.c=a,o.d=function(t,e,n){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)o.d(n,i,function(t){return e[t]}.bind(null,i));return n},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=31)}});